<!DOCTYPE html><html lang="vi"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><meta name="generator" content="Gatsby 4.25.0"/><meta data-react-helmet="true" name="description" content="Ở bài viết này mình muốn xây dựng một API dùng cho việc import CSV bằng nodejs và express, kết hợp với database postgresql."/><meta data-react-helmet="true" name="og:title" content="Dựng API import CSV bằng Nodejs và Express"/><meta data-react-helmet="true" name="og:type" content="website"/><meta data-react-helmet="true" name="og:description" content="Ở bài viết này mình muốn xây dựng một API dùng cho việc import CSV bằng nodejs và express, kết hợp với database postgresql."/><meta data-react-helmet="true" name="og:url" content="https://devgiangho.github.io/dung-api-import-csv-bang-nodejs-va-express/"/><meta data-react-helmet="true" name="twitter:label1" content="Written by"/><meta data-react-helmet="true" name="twitter:data1" content="Kiên Đinh"/><meta data-react-helmet="true" name="twitter:card" content="summary"/><meta data-react-helmet="true" name="twitter:creator" content="Kiên Đinh"/><meta data-react-helmet="true" name="twitter:title" content="Dựng API import CSV bằng Nodejs và Express"/><meta data-react-helmet="true" name="twitter:description" content="Ở bài viết này mình muốn xây dựng một API dùng cho việc import CSV bằng nodejs và express, kết hợp với database postgresql."/><meta data-react-helmet="true" name="keywords" content="JavaScript, .NET, Go, NodeJs, Vạn Vật, Nodejs, Backend, JavaScript"/><meta data-react-helmet="true" name="article:published_time" content="2023-04-12T04:33:56.927Z"/><meta data-react-helmet="true" name="article:modified_time" content="2023-04-12T04:33:56.927Z"/><meta data-react-helmet="true" name="twitter:label2" content="Filed under"/><meta data-react-helmet="true" name="twitter:data2" content="Nodejs"/><meta data-react-helmet="true" name="og:image" content="https://devgiangho.github.io//static/527adeb9fa98ccee34f98ce928095dcc/e29ef/featured-nodejs-csv-importer.png"/><meta data-react-helmet="true" name="twitter:image" content="https://devgiangho.github.io//static/527adeb9fa98ccee34f98ce928095dcc/e29ef/featured-nodejs-csv-importer.png"/><meta name="theme-color" content="#a4cbb8"/><style data-href="/styles.8688c389d7251e1860d6.css" data-identity="gatsby-global-css">@font-face{font-named-instance:"Regular";font-display:swap;font-family:JetbrainsMono;font-style:normal;font-weight:100 900;src:url(/fonts/JetBrainsMono-Regular.woff2) format("woff2")}code,pre{font-family:JetbrainsMono,Consolas,monospace!important}code[class*=language-],pre[class*=language-]{word-wrap:normal;background:none;color:#f8f8f2;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;-webkit-hyphens:none;hyphens:none;line-height:1.5;-o-tab-size:4;tab-size:4;text-align:left;text-shadow:0 1px rgba(0,0,0,.3);white-space:pre;word-break:normal;word-spacing:normal}pre[class*=language-]{border-radius:.3em;margin:.5em 0;overflow:auto;padding:1em}:not(pre)>code[class*=language-],pre[class*=language-]{background:#272822}:not(pre)>code[class*=language-]{border-radius:.3em;padding:.1em;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#708090}.token.punctuation{color:#f8f8f2}.namespace{opacity:.7}.token.constant,.token.deleted,.token.property,.token.symbol,.token.tag{color:#f92672}.token.boolean,.token.number{color:#ae81ff}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#a6e22e}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url,.token.variable{color:#f8f8f2}.token.atrule,.token.attr-value,.token.class-name,.token.function{color:#e6db74}.token.keyword{color:#66d9ef}.token.important,.token.regex{color:#fd971f}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}article.post ol ol,article.post ol ul,article.post ul ol,article.post ul ul{-webkit-padding-start:1rem;padding-inline-start:1rem}</style><link rel="preconnect" href="https://www.google-analytics.com"/><link rel="dns-prefetch" href="https://www.google-analytics.com"/><script>
  
  function gaOptout(){document.cookie=disableStr+'=true; expires=Thu, 31 Dec 2099 23:59:59 UTC;path=/',window[disableStr]=!0}var gaProperty='UA-149502908-1',disableStr='ga-disable-'+gaProperty;document.cookie.indexOf(disableStr+'=true')>-1&&(window[disableStr]=!0);
  if(true) {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  }
  if (typeof ga === "function") {
    ga('create', 'UA-149502908-1', 'auto', {});
      ga('set', 'anonymizeIp', true);
      
      
      
      
      }</script><title data-react-helmet="true">Dựng API import CSV bằng Nodejs và Express</title><link data-react-helmet="true" rel="preconnect" href="https://giscus.app"/><link data-react-helmet="true" rel="dns-prefetch" href="https://giscus.app"/><script data-react-helmet="true" type="application/ld+json">
        {
          "@context": "https://schema.org/",
          "@type": "Article",
          "author": {
            "@type": "Person",
            "name": "Kiên Đinh"
          },
          "keywords": "Nodejs, Backend, JavaScript",
          "headline": "Dựng API import CSV bằng Nodejs và Express",
          "url": "https://devgiangho.github.io/dung-api-import-csv-bang-nodejs-va-express/",
          "datePublished": "2023-04-12T04:33:56.927Z",
          "dateModified": "2023-04-12T04:33:56.927Z",
          "image": {
            "@type": "ImageObject",
            "url": "https://devgiangho.github.io//static/527adeb9fa98ccee34f98ce928095dcc/e29ef/featured-nodejs-csv-importer.png",
            "width": "1000",
            "height": "520"
          },
          "publisher": {
            "@type": "Organization",
            "name": "Dev Giang Hồ - Blog for Devs"
          },
          "description": "Ở bài viết này mình muốn xây dựng một API dùng cho việc import CSV bằng nodejs và express, kết hợp với database postgresql.",
          "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https://devgiangho.github.io"
          }
        }
      </script><style data-styled="" data-styled-version="5.3.3">html{line-height:1.15;-webkit-text-size-adjust:100%;}/*!sc*/
body{margin:0;}/*!sc*/
main{display:block;}/*!sc*/
h1{font-size:2em;margin:0.67em 0;}/*!sc*/
hr{box-sizing:content-box;height:0;overflow:visible;}/*!sc*/
pre{font-family:monospace,monospace;font-size:1em;}/*!sc*/
a{background-color:transparent;}/*!sc*/
abbr[title]{border-bottom:none;-webkit-text-decoration:underline;text-decoration:underline;-webkit-text-decoration:underline dotted;text-decoration:underline dotted;}/*!sc*/
b,strong{font-weight:bolder;}/*!sc*/
code,kbd,samp{font-family:monospace,monospace;font-size:1em;}/*!sc*/
small{font-size:80%;}/*!sc*/
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline;}/*!sc*/
sub{bottom:-0.25em;}/*!sc*/
sup{top:-0.5em;}/*!sc*/
img{border-style:none;}/*!sc*/
button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0;}/*!sc*/
button,input{overflow:visible;}/*!sc*/
button,select{text-transform:none;}/*!sc*/
button,[type="button"],[type="reset"],[type="submit"]{-webkit-appearance:button;}/*!sc*/
button::-moz-focus-inner,[type="button"]::-moz-focus-inner,[type="reset"]::-moz-focus-inner,[type="submit"]::-moz-focus-inner{border-style:none;padding:0;}/*!sc*/
button:-moz-focusring,[type="button"]:-moz-focusring,[type="reset"]:-moz-focusring,[type="submit"]:-moz-focusring{outline:1px dotted ButtonText;}/*!sc*/
fieldset{padding:0.35em 0.75em 0.625em;}/*!sc*/
legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal;}/*!sc*/
progress{vertical-align:baseline;}/*!sc*/
textarea{overflow:auto;}/*!sc*/
[type="checkbox"],[type="radio"]{box-sizing:border-box;padding:0;}/*!sc*/
[type="number"]::-webkit-inner-spin-button,[type="number"]::-webkit-outer-spin-button{height:auto;}/*!sc*/
[type="search"]{-webkit-appearance:textfield;outline-offset:-2px;}/*!sc*/
[type="search"]::-webkit-search-decoration{-webkit-appearance:none;}/*!sc*/
::-webkit-file-upload-button{-webkit-appearance:button;font:inherit;}/*!sc*/
details{display:block;}/*!sc*/
summary{display:list-item;}/*!sc*/
template{display:none;}/*!sc*/
[hidden]{display:none;}/*!sc*/
html{box-sizing:border-box;background-color:#fafafa;}/*!sc*/
body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;line-height:1.9em;}/*!sc*/
*{box-sizing:border-box;}/*!sc*/
p .footnote-ref{color:#067a5f;font-size:0.9rem;display:inline-block;-webkit-scroll-margin-top:4.7rem;-moz-scroll-margin-top:4.7rem;-ms-scroll-margin-top:4.7rem;scroll-margin-top:4.7rem;-webkit-overflow-scrolling:touch;}/*!sc*/
.footnote-list-item{-webkit-scroll-margin-top:4.9rem;-moz-scroll-margin-top:4.9rem;-ms-scroll-margin-top:4.9rem;scroll-margin-top:4.9rem;}/*!sc*/
h1,h2,h3,h4,h5,h6{outline:none;}/*!sc*/
a{color:#000;-webkit-text-decoration:none;text-decoration:none;}/*!sc*/
.gatsby-highlight{max-width:100% !important;}/*!sc*/
.gatsby-highlight-code-line{background-color:#353631;display:block;margin-right:-1em;margin-left:-1em;padding-right:1em;padding-left:0.75em;}/*!sc*/
.interactive-gif .embedded{position:relative;width:100%;height:auto;}/*!sc*/
.interactive-gif .loading,.interactive-gif .still-container,.interactive-gif .gif-container{position:absolute;top:0;width:100%;height:100%;}/*!sc*/
.interactive-gif .still,.interactive-gif .gif{width:100%;height:100%;cursor:pointer;}/*!sc*/
.interactive-gif .loading .indicator{position:absolute;bottom:0;left:0;width:80px;-webkit-filter:contrast(0.5);filter:contrast(0.5);}/*!sc*/
.interactive-gif .still-container .play{cursor:pointer;-webkit-filter:grayscale(100%);filter:grayscale(100%);width:20%;position:absolute;opacity:0.9;left:50%;top:50%;-webkit-transform:translateX(-50%) translateY(-50%);-ms-transform:translateX(-50%) translateY(-50%);transform:translateX(-50%) translateY(-50%);}/*!sc*/
.interactive-gif .caption{font-size:90%;font-style:italic;}/*!sc*/
.interactive-gif .placeholder{-webkit-filter:grayscale(100%);filter:grayscale(100%);text-align:center;}/*!sc*/
.interactive-gif .placeholder img{width:200px;display:none;}/*!sc*/
article code:not(pre > code){border:0.1rem solid rgba(0,0,0,0.1);font-weight:300;border-radius:0.25rem;background-color:rgb(245 245 245) !important;text-shadow:none !important;padding-top:0.2rem !important;padding-bottom:0.1rem !important;padding-left:0.125rem !important;padding-right:0.125rem !important;color:rgb(11 11 11) !important;}/*!sc*/
data-styled.g2[id="sc-global-fIUfrS1"]{content:"sc-global-fIUfrS1,"}/*!sc*/
.hhzXsP{width:1260px;margin-left:auto;margin-right:auto;max-width:100%;}/*!sc*/
@media (max-width:1300px){.hhzXsP{padding:0 20px;}}/*!sc*/
data-styled.g3[id="common__Container-sc-yvdkhc-0"]{content:"hhzXsP,"}/*!sc*/
.eBjOxQ{z-index:1000;background-color:#20232a;position:-webkit-sticky;position:sticky;top:0;box-shadow:0 0 3px rgba(0,0,0,.03),0 3px 46px rgba(0,0,0,.07);}/*!sc*/
data-styled.g5[id="style__NavContainer-sc-jhe81k-0"]{content:"eBjOxQ,"}/*!sc*/
.hRmTxB{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;position:relative;}/*!sc*/
data-styled.g6[id="style__Nav-sc-jhe81k-1"]{content:"hRmTxB,"}/*!sc*/
.kkNwJo{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;width:100%;height:70px;white-space:nowrap;}/*!sc*/
@media (max-width:576px){.kkNwJo{width:90%;}}/*!sc*/
data-styled.g7[id="style__NavWrapper-sc-jhe81k-2"]{content:"kkNwJo,"}/*!sc*/
.cPsfUr{-webkit-align-self:center;-ms-flex-item-align:center;align-self:center;list-style-type:none;margin:0;padding:0;}/*!sc*/
@media (max-width:576px){.cPsfUr{width:80%;overflow-x:auto;overflow-y:hidden;-webkit-mask-image:linear-gradient(to right,transparent,#000 25px,#000 90%,transparent);mask-image:linear-gradient(to right,transparent,#000 25px,#000 90%,transparent);}}/*!sc*/
.jPyOnZ{-webkit-align-self:center;-ms-flex-item-align:center;align-self:center;list-style-type:none;margin:0;padding:0;}/*!sc*/
data-styled.g8[id="style__NavMenu-sc-jhe81k-3"]{content:"cPsfUr,jPyOnZ,"}/*!sc*/
.fPrbPq{cursor:pointer;display:inline-block;border:0;background:transparent;outline:none;-webkit-text-decoration:none;text-decoration:none;}/*!sc*/
data-styled.g9[id="style__NavMenuItem-sc-jhe81k-4"]{content:"fPrbPq,"}/*!sc*/
.bdMJer{color:#fff;opacity:.8;padding:16px;-webkit-transition:opacity .5s;transition:opacity .5s;}/*!sc*/
.bdMJer:hover{opacity:1;}/*!sc*/
data-styled.g10[id="style__NavLink-sc-jhe81k-5"]{content:"bdMJer,"}/*!sc*/
.dSpRmA{-webkit-align-self:center;-ms-flex-item-align:center;align-self:center;position:relative;}/*!sc*/
data-styled.g11[id="style__SearchContainer-sc-jhe81k-6"]{content:"dSpRmA,"}/*!sc*/
.cbBsOC{cursor:pointer;color:#fff;opacity:.8;background:none;outline:none;border:0;-webkit-transition:opacity .5s;transition:opacity .5s;}/*!sc*/
.cbBsOC:hover{opacity:1;}/*!sc*/
data-styled.g12[id="style__ToggleSearchButton-sc-jhe81k-7"]{content:"cbBsOC,"}/*!sc*/
.jIujQe{max-height:30px;width:30px;margin-right:45px;}/*!sc*/
@media (max-width:576px){.jIujQe{margin-right:15px;}}/*!sc*/
data-styled.g20[id="logo__LogoImage-sc-1ta2zdq-0"]{content:"jIujQe,"}/*!sc*/
.dYGSok{-webkit-align-self:center;-ms-flex-item-align:center;align-self:center;height:30px;}/*!sc*/
data-styled.g21[id="logo__HomeLink-sc-1ta2zdq-1"]{content:"dYGSok,"}/*!sc*/
.hNmZFn{max-width:100%;padding:10px 0;z-index:700;position:relative;font-size:.9em;margin-top:50px;}/*!sc*/
data-styled.g27[id="style__StyledFooter-sc-1bbyksd-0"]{content:"hNmZFn,"}/*!sc*/
.kRFmqs{text-align:right;line-height:1.1em;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}/*!sc*/
data-styled.g28[id="style__FooterContainer-sc-1bbyksd-1"]{content:"kRFmqs,"}/*!sc*/
.eFaQjI{margin:0;}/*!sc*/
data-styled.g29[id="style__Copyright-sc-1bbyksd-2"]{content:"eFaQjI,"}/*!sc*/
.hFClol{margin:0;opacity:.8;font-size:.8em;}/*!sc*/
.hFClol a{font-weight:bold;-webkit-text-decoration:none;text-decoration:none;color:#000;}/*!sc*/
.hFClol a:hover{-webkit-text-decoration:underline;text-decoration:underline;}/*!sc*/
data-styled.g30[id="style__DesignBy-sc-1bbyksd-3"]{content:"hFClol,"}/*!sc*/
.hCiwIZ ul{list-style-type:none;margin:0;padding:0;}/*!sc*/
.hCiwIZ li{display:inline-block;margin-right:25px;}/*!sc*/
.hCiwIZ li:last-child{margin-right:0;}/*!sc*/
data-styled.g31[id="style__StyledNav-sc-1bbyksd-4"]{content:"hCiwIZ,"}/*!sc*/
.RdnGO{color:#000;-webkit-text-decoration:none;text-decoration:none;}/*!sc*/
data-styled.g33[id="style__FooterMenuLink-sc-1bbyksd-6"]{content:"RdnGO,"}/*!sc*/
.fmlDtj > ul{list-style-type:none;margin:0;padding:0;}/*!sc*/
.fmlDtj > ul li{line-height:1.2em;list-style-type:none;padding-top:0.3em;padding-bottom:0.3em;}/*!sc*/
.fmlDtj > ul li:last-child{padding-bottom:0;}/*!sc*/
.fmlDtj > ul ul,.fmlDtj > ul li,.fmlDtj > ul ol{margin-left:-0.7rem;}/*!sc*/
.fmlDtj a{color:#808080;-webkit-text-decoration:none;text-decoration:none;}/*!sc*/
.fmlDtj a:hover{cursor:pointer;}/*!sc*/
.fmlDtj .is-active{color:#404040;font-weight:700;}/*!sc*/
data-styled.g34[id="toc__StyledNav-sc-1rcn1mg-0"]{content:"fmlDtj,"}/*!sc*/
.bGzPfA{position:-webkit-sticky;position:sticky;height:5px;top:70px;background-color:#a4cbb8;z-index:500;}/*!sc*/
data-styled.g35[id="reading-progress__ReadingProgressBar-sc-1h92jbi-0"]{content:"bGzPfA,"}/*!sc*/
.eWZpEr{list-style-type:none;margin:0;padding:0;}/*!sc*/
data-styled.g36[id="social-channel-list__StyledSocialChannels-sc-hb4cd6-0"]{content:"eWZpEr,"}/*!sc*/
.dIYGZM{display:inline-block;margin:0 10px;font-size:1.6em;opacity:.7;-webkit-transition:opacity .5s;transition:opacity .5s;}/*!sc*/
.dIYGZM:hover{opacity:1;}/*!sc*/
data-styled.g37[id="social-channel-list__StyledSocialChannel-sc-hb4cd6-1"]{content:"dIYGZM,"}/*!sc*/
.iLbeUa{max-width:110px;border-radius:100%;}/*!sc*/
data-styled.g38[id="avatar__StyledAvatar-sc-1b55w7o-0"]{content:"iLbeUa,"}/*!sc*/
.buiIfq{margin:auto;text-align:center;width:100%;}/*!sc*/
data-styled.g39[id="bio__StyledBio-sc-cy4lz8-0"]{content:"buiIfq,"}/*!sc*/
.iEPaOA{margin:10px 0 13px;}/*!sc*/
.iEPaOA a{color:#000;-webkit-text-decoration:underline;text-decoration:underline;}/*!sc*/
data-styled.g40[id="bio__AuthorDescription-sc-cy4lz8-1"]{content:"iEPaOA,"}/*!sc*/
.HeSmV{margin:10px;}/*!sc*/
data-styled.g41[id="bio__AuthorName-sc-cy4lz8-2"]{content:"HeSmV,"}/*!sc*/
.cEXXiX{margin:2rem auto;max-width:95%;}/*!sc*/
@media (max-width:768px){.cEXXiX{max-width:95%;}}/*!sc*/
data-styled.g42[id="comments__PostComment-sc-188g6ow-0"]{content:"cEXXiX,"}/*!sc*/
.fwNAhO{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;padding:0 !important;}/*!sc*/
data-styled.g43[id="postStyle__PostContainer-sc-1q9n7ky-0"]{content:"fwNAhO,"}/*!sc*/
.hkHhPL{min-width:255px;max-width:225px;-webkit-transition:opacity 0.5s;transition:opacity 0.5s;}/*!sc*/
@media (max-width:1300px){.hkHhPL{position:fixed;display:none;z-index:1000;background-color:#fff;width:100% !important;max-width:100%;padding:0 20px;margin-top:-5px;height:calc(100vh - 70px);}}/*!sc*/
data-styled.g44[id="postStyle__LeftSidebar-sc-1q9n7ky-1"]{content:"hkHhPL,"}/*!sc*/
.izgFAQ{margin-top:-5px;border-right:1px #e5eff5 solid;border-left:1px #e5eff5 solid;background-color:#fff;box-shadow:0 0 3px rgba(0,0,0,0.03),0 3px 46px rgba(0,0,0,0.1);z-index:10;width:1035px;max-width:100%;}/*!sc*/
.izgFAQ li > a,.izgFAQ p > a{color:#0054aa;border-bottom:2px #0054aa solid;overflow-wrap:break-word;}/*!sc*/
.izgFAQ pre{margin:30px 0;}/*!sc*/
.izgFAQ blockquote{border-left:4px #a4cbb8 solid;background-color:#fafafa;margin:30px 0;padding:5px 20px;border-radius:0.3em;}/*!sc*/
.izgFAQ h1,.izgFAQ h2,.izgFAQ h3,.izgFAQ h4,.izgFAQ h5,.izgFAQ h6{-webkit-scroll-margin-top:4.7rem;-moz-scroll-margin-top:4.7rem;-ms-scroll-margin-top:4.7rem;scroll-margin-top:4.7rem;}/*!sc*/
.izgFAQ h3::before,.izgFAQ h4::before,.izgFAQ h5::before,.izgFAQ h6::before{display:block;content:" ";visibility:hidden;}/*!sc*/
.izgFAQ h2{border-top:1px solid #ececec;margin-top:44px;padding-top:15px;line-height:1.2;}/*!sc*/
.izgFAQ h2 .anchor.before{padding-top:10px;}/*!sc*/
.izgFAQ code[class*="language-text"]{padding:5px;}/*!sc*/
.izgFAQ p > img{max-width:100%;border-radius:0.3em;margin:30px 0;}/*!sc*/
.izgFAQ hr{border-top:1px solid #ececec;border-bottom:0;margin-top:44px;margin-bottom:40px;}/*!sc*/
.izgFAQ .gatsby-resp-image-link{margin:30px 0;max-width:100%;}/*!sc*/
.izgFAQ .gatsby-resp-image-link .gatsby-resp-image-image{border-radius:0.3em;}/*!sc*/
.izgFAQ .table-wrapper{max-width:100%;overflow-x:scroll;}/*!sc*/
.izgFAQ .table-wrapper table{width:100%;}/*!sc*/
.izgFAQ table{margin:0 auto;}/*!sc*/
.izgFAQ table{color:#333;background:white;border:1px solid grey;font-size:12pt;border-collapse:collapse;}/*!sc*/
.izgFAQ table thead th,.izgFAQ table tfoot th{color:#474747;background:rgb(102 102 102 / 10%);}/*!sc*/
.izgFAQ table caption{padding:0.5em;}/*!sc*/
.izgFAQ table th,.izgFAQ table td{padding:0.5em;border:1px solid lightgrey;}/*!sc*/
.izgFAQ [data-table-theme*="zebra"] tbody tr:nth-of-type(odd){background:rgba(0,0,0,0.05);}/*!sc*/
.izgFAQ [data-table-theme*="zebra"][data-table-theme*="dark"] tbody tr:nth-of-type(odd){background:rgba(255,255,255,0.05);}/*!sc*/
.izgFAQ [data-table-theme*="dark"]{color:#ddd;background:#333;font-size:12pt;border-collapse:collapse;}/*!sc*/
.izgFAQ [data-table-theme*="dark"] thead th,.izgFAQ [data-table-theme*="dark"] tfoot th{color:#aaa;background:rgba(0255,255,255,0.15);}/*!sc*/
.izgFAQ [data-table-theme*="dark"] caption{padding:0.5em;}/*!sc*/
.izgFAQ [data-table-theme*="dark"] th,.izgFAQ [data-table-theme*="dark"] td{padding:0.5em;border:1px solid grey;}/*!sc*/
.izgFAQ sup{-webkit-scroll-margin-top:5.5rem;-moz-scroll-margin-top:5.5rem;-ms-scroll-margin-top:5.5rem;scroll-margin-top:5.5rem;}/*!sc*/
data-styled.g45[id="postStyle__PostContent-sc-1q9n7ky-2"]{content:"izgFAQ,"}/*!sc*/
.chUzhL{position:-webkit-sticky;position:sticky;top:70px;padding:40px 30px 40px 0;}/*!sc*/
data-styled.g46[id="postStyle__TocWrapper-sc-1q9n7ky-3"]{content:"chUzhL,"}/*!sc*/
.emniPl{padding:40px;}/*!sc*/
@media (max-width:576px){.emniPl{padding:20px;}}/*!sc*/
data-styled.g47[id="postStyle__PostHeader-sc-1q9n7ky-4"]{content:"emniPl,"}/*!sc*/
.hPgZxr{border-radius:0;}/*!sc*/
@media (max-width:1300px){.hPgZxr{margin-left:-1px;margin-right:-1px;}}/*!sc*/
data-styled.g48[id="postStyle__FeaturedImage-sc-1q9n7ky-5"]{content:"hPgZxr,"}/*!sc*/
.fuGkXD{padding:40px;}/*!sc*/
@media (max-width:576px){.fuGkXD{padding:20px;}}/*!sc*/
data-styled.g49[id="postStyle__StyledPost-sc-1q9n7ky-6"]{content:"fuGkXD,"}/*!sc*/
.dvkpbj{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;opacity:0.8;font-size:0.9em;}/*!sc*/
data-styled.g50[id="postStyle__PostMeta-sc-1q9n7ky-7"]{content:"dvkpbj,"}/*!sc*/
.jXQCDR{margin:0;padding:0;line-height:1.2;}/*!sc*/
data-styled.g51[id="postStyle__PostTitle-sc-1q9n7ky-8"]{content:"jXQCDR,"}/*!sc*/
.kGeBkw{background-color:#fafafa;font-size:0.8em;color:#666;padding:40px;line-height:1em;}/*!sc*/
.kGeBkw p{margin:5px 0;}/*!sc*/
data-styled.g52[id="postStyle__PostFooter-sc-1q9n7ky-9"]{content:"kGeBkw,"}/*!sc*/
.bsOVgh{color:#000 !important;-webkit-text-decoration:none;text-decoration:none;border-bottom:0 !important;}/*!sc*/
data-styled.g53[id="postStyle__FooterTagLink-sc-1q9n7ky-10"]{content:"bsOVgh,"}/*!sc*/
.hnKtRH{background-color:#fff;border-top:1px #e5eff5 solid;border-bottom:1px #e5eff5 solid;z-index:700;position:relative;padding:40px;}/*!sc*/
data-styled.g54[id="postStyle__PostAddition-sc-1q9n7ky-11"]{content:"hnKtRH,"}/*!sc*/
.bIQtHU{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;}/*!sc*/
data-styled.g55[id="postStyle__PostAdditionContent-sc-1q9n7ky-12"]{content:"bIQtHU,"}/*!sc*/
.cXvylF{width:50%;margin:auto;}/*!sc*/
@media (max-width:576px){.cXvylF{width:100%;}}/*!sc*/
data-styled.g56[id="postStyle__BioWrapper-sc-1q9n7ky-13"]{content:"cXvylF,"}/*!sc*/
.kxysTe{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;padding-top:1em;position:fixed;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;right:20px;bottom:20px;border-radius:100%;box-shadow:0 0 3px rgba(0,0,0,0.03),0 3px 46px rgba(0,0,0,0.1);border:0;z-index:5000;width:50px;height:50px;background-color:#20232a;color:#fff;outline:none;}/*!sc*/
@media (min-width:1300px){.kxysTe{display:none;}}/*!sc*/
data-styled.g57[id="postStyle__ToggleTocButton-sc-1q9n7ky-14"]{content:"kxysTe,"}/*!sc*/
.tpqNJ{margin-top:1rem;margin-bottom:1rem;padding-left:1rem;padding-right:1rem;overflow:auto;display:grid;grid-template-columns:repeat(2,1fr);gap:0.6rem;}/*!sc*/
@media (max-width:576px){.tpqNJ{display:block;}}/*!sc*/
data-styled.g58[id="style__LinkedPostWrapper-sc-cu5n11-0"]{content:"tpqNJ,"}/*!sc*/
.llMcQV{display:block;background-color:#ffff;border:1px solid #ddd;border-radius:3px;padding:5px 10px;font-size:16px;-webkit-text-decoration:none;text-decoration:none;color:#333;height:100%;border:1px solid #dadde1;}/*!sc*/
.llMcQV:hover{border:1px solid #009400;}/*!sc*/
.llMcQV .label{color:#067a5f;font-weight:600;}/*!sc*/
@media (max-width:576px){.llMcQV{margin-top:0.5rem;margin-bottom:0.5rem;}}/*!sc*/
data-styled.g59[id="style__LinkedPost-sc-cu5n11-1"]{content:"llMcQV,"}/*!sc*/
.jKVyMT{text-align:left;}/*!sc*/
.jKVyMT .label:before{content:"« ";}/*!sc*/
data-styled.g60[id="style__PrevPost-sc-cu5n11-2"]{content:"jKVyMT,"}/*!sc*/
</style><link rel="sitemap" type="application/xml" href="/sitemap/sitemap-index.xml"/><link rel="icon" href="/favicon-32x32.png?v=5e09b7dc046a8972547b7e2d01e32a28" type="image/png"/><link rel="manifest" href="/manifest.webmanifest" crossorigin="anonymous"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=5e09b7dc046a8972547b7e2d01e32a28"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=5e09b7dc046a8972547b7e2d01e32a28"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=5e09b7dc046a8972547b7e2d01e32a28"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=5e09b7dc046a8972547b7e2d01e32a28"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=5e09b7dc046a8972547b7e2d01e32a28"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=5e09b7dc046a8972547b7e2d01e32a28"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=5e09b7dc046a8972547b7e2d01e32a28"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=5e09b7dc046a8972547b7e2d01e32a28"/><style type="text/css">
    .anchor.before {
      position: absolute;
      top: 0;
      left: 0;
      transform: translateX(-100%);
      padding-right: 4px;
    }
    .anchor.after {
      display: inline-block;
      padding-left: 4px;
    }
    h1 .anchor svg,
    h2 .anchor svg,
    h3 .anchor svg,
    h4 .anchor svg,
    h5 .anchor svg,
    h6 .anchor svg {
      visibility: hidden;
    }
    h1:hover .anchor svg,
    h2:hover .anchor svg,
    h3:hover .anchor svg,
    h4:hover .anchor svg,
    h5:hover .anchor svg,
    h6:hover .anchor svg,
    h1 .anchor:focus svg,
    h2 .anchor:focus svg,
    h3 .anchor:focus svg,
    h4 .anchor:focus svg,
    h5 .anchor:focus svg,
    h6 .anchor:focus svg {
      visibility: visible;
    }
  </style><script>
    document.addEventListener("DOMContentLoaded", function(event) {
      var hash = window.decodeURI(location.hash.replace('#', ''))
      if (hash !== '') {
        var element = document.getElementById(hash)
        if (element) {
          var scrollTop = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop
          var clientTop = document.documentElement.clientTop || document.body.clientTop || 0
          var offset = element.getBoundingClientRect().top + scrollTop - clientTop
          // Wait for the browser to finish rendering before scrolling.
          setTimeout((function() {
            window.scrollTo(0, offset - 100)
          }), 0)
        }
      }
    })
  </script><link rel="alternate" type="application/rss+xml" title="RSS Feed" href="/rss.xml"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div class="style__NavContainer-sc-jhe81k-0 eBjOxQ"><div class="common__Container-sc-yvdkhc-0 style__Nav-sc-jhe81k-1 hhzXsP hRmTxB"><a class="logo__HomeLink-sc-1ta2zdq-1 dYGSok" href="/"><div class="logo__LogoImage-sc-1ta2zdq-0 jIujQe gatsby-image-wrapper" style="position:relative;overflow:hidden;display:inline-block;width:30px;height:30px"><img aria-hidden="true" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsTAAALEwEAmpwYAAAFlUlEQVQ4y2WSaVCTVxSGb6gz+kccq1QFlVo7tI7TqTp16lJFVGRRkAARWcWxuIKKYtWyBUWEqSgKHRFks0QWBQoKuGIBQVQIGMISwhISCCQioCxVvu+7b+cL2v7oj3vvzL3nfc57zrkk2VZMrtmEkyQbseDKphDCrwuWp02i1586GvnTLw/CVgdpT608yh5bEcAEfH9Is3/pgbu7Lfz2eS7abSwy30VcFvoIHEw9BY5mnsTB1JOQVPsIkmwrFqTYRZCr1mE80P/SxmB99LqTCFkWgGPf7MURi304uNgPuxf4YJe5L3Zb+MHr6z1q0UIfb+F8L7JuhjPZNs9DYD/XnZAU+whBxtazRLIt0ihxS/jNhC1hiFkVhHOrg5gbhxLZ8tTH9HF6CS1NKqTFCcVcjPtvjMdCH0Zk5oUdi3yx3cwrXjjfmyydYke2zvMgJM4qmCTZikmKXcTNJDsxYtecmPjj53iuV67G2Og7mn7tIvXfI6J73e1obEQQHdD3U/nTZgRanWQdZrsxwgXesJ/rHse7czD1NCI3tkXyyz9921nErzs1URwmoRzHAQCNOHGYrlhshmUWi2E+xwTGnxEEHvSj/NvYyDjCROeozUxXdqupJ6xN3ETWJm6EZDtFmUi2R+mTNoUi71Aix7GsATY8OARXG0usXWKODUu/hO/ab+G4/Cus+WE53gwMGGJGh0exd3Ugu3mmK7bM2alYY+w8lWQLzx/NdDyH6zbhjFamMgSyEwx/IjMhChHeG5F2RIhkfyekHhHi1wPeGBx+C3DU4PRpUQ02zXBhrL9ww4ZZop0k1yX6QfoWMYqD0nhrlHIcH4iJ8RFUSS7g9vn9yD/rh4wT7rgTE4DbIb4YVCkNCSnlKMuw1G/tcWb9dCGsZu/IJLdcY7QpViGQ3nhiyPixZDAfPqCx4DKeJgTgfvR+FAV74kmMH8pi/DE+qDfEsMxke+KOJXGrpzrAysStngey1zcEQ3FP+hHI8ZtBoGuXIl/shsxAF1z3s0VOkCM0supJdxz3L/DmxXz645StPHCUBzIGYGndf0BK+XIMwuf5l1AY7oE/gz2QH+6F8XdD/wNKYvM+Ad/yQE3qxhDUpj3iPgEnFZOHtCQJBWdFyDnthKzjdmguLzA88SP59L1iD19l10wzlPyS5DpH382wEaPoSDLzEWPo4/vxEcgaXqL61gXkhjoiN9QZt4O3o7rgGirLH4GdGAfHsXRs5G/qu/IwY2nszA8llf82+ySO55BsHc50VMjBcGN0dEiLfnUzqsqK0C6rQGnCMTy4sh+yhxlQyGrwtOwu3o/qKccO0WelVdT6cxG72cQNVrNETiTH6byxxClKnWgZjKrkQnZ0VIOBXgUd7G+n/d1ydDTVoLn2IaSPcyB/8QjdbbXoU7fQQb2KDg+ooNO0Mj4rDsByunNDliTPiKRuDCMZ9me80x0joaqXMnptC9V2ytCnklFdTwvV97RC3VYHZeMzaDpeoaeriT55UEgV8hd43avghvRKTuwTCQtiabOArCLkdX+7QFFRQ/IDfo/XqVrR1VLDttQ9Znkn/d1NVKduphqllL7WttE3ui56/04ubW2soT2dMqZPJef6VE34q6AkdEDbSli214g8Ty0SpAjjSJ7wEhnSq+I0bXWoLcuDUlbJC5i+bjmn7ZJTnaaVDr1WsT1dcv6e7eloQL+6BdrOptDkMwmk8t4dQc7lbEIq4m4RafZ9AQCi62kkGoV0R3VpVpuivhy9na/ACzVKKbSqRmhVct412hur0dXysqG/W2Gr0zSTJeQ7QdalLBIXGE9I65NqoqqTksaSCqLpeGmkUdSRrNiYaU01j9zl1aUSZX15fZf8xbhaUT+ibKisVb6qSmuoLHW6fDzKqK+7hWi7Gox6lArS29FKtJ3N5B8YTTI10y3oBAAAAABJRU5ErkJggg==" alt="Dev Giang Hồ - Blog for Devs" style="position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;object-position:center;opacity:1;transition-delay:500ms"/><noscript><picture><source srcset="/static/5e09b7dc046a8972547b7e2d01e32a28/91664/logo.png 1x,
/static/5e09b7dc046a8972547b7e2d01e32a28/ad39b/logo.png 1.5x,
/static/5e09b7dc046a8972547b7e2d01e32a28/183c2/logo.png 2x" /><img loading="lazy" width="30" height="30" srcset="/static/5e09b7dc046a8972547b7e2d01e32a28/91664/logo.png 1x,
/static/5e09b7dc046a8972547b7e2d01e32a28/ad39b/logo.png 1.5x,
/static/5e09b7dc046a8972547b7e2d01e32a28/183c2/logo.png 2x" src="/static/5e09b7dc046a8972547b7e2d01e32a28/91664/logo.png" alt="Dev Giang Hồ - Blog for Devs" style="position:absolute;top:0;left:0;opacity:1;width:100%;height:100%;object-fit:cover;object-position:center"/></picture></noscript></div></a><div class="style__NavWrapper-sc-jhe81k-2 kkNwJo"><ul class="style__NavMenu-sc-jhe81k-3 cPsfUr"><li class="style__NavMenuItem-sc-jhe81k-4 fPrbPq"><a class="style__NavLink-sc-jhe81k-5 bdMJer" href="/">Home</a></li><li class="style__NavMenuItem-sc-jhe81k-4 fPrbPq"><a class="style__NavLink-sc-jhe81k-5 bdMJer" href="/about-me/">About me</a></li></ul><div class="style__SearchContainer-sc-jhe81k-6 dSpRmA"><ul class="style__NavMenu-sc-jhe81k-3 jPyOnZ"><li class="style__NavMenuItem-sc-jhe81k-4 fPrbPq"><button role="button" aria-label="Toggle search" class="style__ToggleSearchButton-sc-jhe81k-7 cbBsOC"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"></path></svg></button></li></ul></div></div></div></div><main><div style="width:0%" class="reading-progress__ReadingProgressBar-sc-1h92jbi-0 bGzPfA"></div><div class="common__Container-sc-yvdkhc-0 postStyle__PostContainer-sc-1q9n7ky-0 hhzXsP fwNAhO"><div class="postStyle__LeftSidebar-sc-1q9n7ky-1 hkHhPL"><div class="postStyle__TocWrapper-sc-1q9n7ky-3 chUzhL"><nav class="toc__StyledNav-sc-1rcn1mg-0 fmlDtj toc-list"><ul><li><a class="non-active" href="/dung-api-import-csv-bang-nodejs-va-express/#/">Tản mạn</a></li><li><a class="non-active" href="/dung-api-import-csv-bang-nodejs-va-express/#/">Giới thiệu về project</a><ul><li><a class="non-active" href="/dung-api-import-csv-bang-nodejs-va-express/#/">Tại sao lại là import CSV?</a></li><li><a class="non-active" href="/dung-api-import-csv-bang-nodejs-va-express/#/">Ưu điểm của CSV</a></li></ul></li><li><a class="non-active" href="/dung-api-import-csv-bang-nodejs-va-express/#/">First thing first</a></li><li><a class="non-active" href="/dung-api-import-csv-bang-nodejs-va-express/#/">Bắt tay vào code</a><ul><li><a class="non-active" href="/dung-api-import-csv-bang-nodejs-va-express/#/">Khởi tạo Nodejs Project</a><ul><li><a class="non-active" href="/dung-api-import-csv-bang-nodejs-va-express/#/">Cấu trúc thư mục</a></li></ul></li><li><a class="non-active" href="/dung-api-import-csv-bang-nodejs-va-express/#/">Dựng database postgresql</a></li><li><a class="non-active" href="/dung-api-import-csv-bang-nodejs-va-express/#/">Dựng model và kết nối database</a></li><li><a class="non-active" href="/dung-api-import-csv-bang-nodejs-va-express/#/">Cache lại file đã upload</a></li><li><a class="non-active" href="/dung-api-import-csv-bang-nodejs-va-express/#/">Các endpoint REST API</a><ul><li><a class="non-active" href="/dung-api-import-csv-bang-nodejs-va-express/#/">Get many products</a></li><li><a class="non-active" href="/dung-api-import-csv-bang-nodejs-va-express/#/">Get product by ID</a></li><li><a class="non-active" href="/dung-api-import-csv-bang-nodejs-va-express/#/">Import products</a></li><li><a class="non-active" href="/dung-api-import-csv-bang-nodejs-va-express/#/">Export product</a></li></ul></li><li><a class="non-active" href="/dung-api-import-csv-bang-nodejs-va-express/#/">Middleware logger</a></li><li><a class="non-active" href="/dung-api-import-csv-bang-nodejs-va-express/#/">UI cho trang chủ</a></li><li><a class="non-active" href="/dung-api-import-csv-bang-nodejs-va-express/#/">Cài đặt express server</a></li><li><a class="non-active" href="/dung-api-import-csv-bang-nodejs-va-express/#/">Chạy app lên</a></li></ul></li><li><a class="non-active" href="/dung-api-import-csv-bang-nodejs-va-express/#/">Benchmark</a><ul><li><a class="non-active" href="/dung-api-import-csv-bang-nodejs-va-express/#/">Tạo file CSV mẫu</a></li><li><a class="non-active" href="/dung-api-import-csv-bang-nodejs-va-express/#/">Tiến hành benchmark</a><ul><li><a class="non-active" href="/dung-api-import-csv-bang-nodejs-va-express/#/">Test trên trình duyệt</a></li><li><a class="non-active" href="/dung-api-import-csv-bang-nodejs-va-express/#/">Stress test</a></li></ul></li></ul></li><li><a class="non-active" href="/dung-api-import-csv-bang-nodejs-va-express/#/">Kết luận</a></li></ul></nav></div></div><button role="button" aria-label="Toggle table of contents" class="postStyle__ToggleTocButton-sc-1q9n7ky-14 kxysTe"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 448 512" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M432 416H16a16 16 0 0 0-16 16v32a16 16 0 0 0 16 16h416a16 16 0 0 0 16-16v-32a16 16 0 0 0-16-16zm0-128H16a16 16 0 0 0-16 16v32a16 16 0 0 0 16 16h416a16 16 0 0 0 16-16v-32a16 16 0 0 0-16-16zm0-128H16a16 16 0 0 0-16 16v32a16 16 0 0 0 16 16h416a16 16 0 0 0 16-16v-32a16 16 0 0 0-16-16zm0-128H16A16 16 0 0 0 0 48v32a16 16 0 0 0 16 16h416a16 16 0 0 0 16-16V48a16 16 0 0 0-16-16z"></path></svg></button><div class="postStyle__PostContent-sc-1q9n7ky-2 izgFAQ"><article class="post"><header class="postStyle__PostHeader-sc-1q9n7ky-4 emniPl"><section class="postStyle__PostMeta-sc-1q9n7ky-7 dvkpbj"><a href="/tag/nodejs/">Nodejs</a><time dateTime="2023-04-12T04:33:56.927Z">12 April, 2023</time></section><h1 class="postStyle__PostTitle-sc-1q9n7ky-8 jXQCDR">Dựng API import CSV bằng Nodejs và Express</h1></header><div class="postStyle__FeaturedImage-sc-1q9n7ky-5 hPgZxr gatsby-image-wrapper" style="position:relative;overflow:hidden"><div aria-hidden="true" style="width:100%;padding-bottom:60%"></div><img aria-hidden="true" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAA9hAAAPYQGoP6dpAAACIUlEQVQoz2Pg2xQpsiVGcmuC3PZk5R3pGruydHfnGe0tNN9XanOgwvFQjdvheu+jTQHH20JPdEaf6o0/PSH17JTMczPyL8xmwK55D1Szw6Fqp8M1Hkca/Y+1hmDXvDlGcluC3LZk5R1pGjtBmg13FVjsL7U+UOFxqCHmWE/M0d7Y470xJ3qjT/Yknp6IpHljpMj2WMltCbK7U5V2ZmgeytPekKleFm55rNJsf0n6qSk7b51YeW3fsmu7y8/MCz7ZEXu6P/ns5Cyo5u1RopODJXyc5XpDNfv91GdEy0d5K4V6q2UE6lRGeRxtiD7aHXW0O/XkpPTTU5NOTco5OyPn3Mysc9NhmrsDJUr95Vr9taa4qncHy/u6q+WHqEb76k1Kij/dv/D8tpbTS5Zf2b3u+sEVV/YsvbRzydXdWedm5EGdvTVWckei7M5U1S1JeusT9ZYmG+4uNNtRZLmz1OtoQ+K5aZGne1NOTEw4MSHz9LSs09MKz83OQgmwLfFy25NVtqXprYw32JphtK/IfH+p3aFyy71t/IsPmKydEHOiPe/4jNLTc0pPzi47NSf33My8C7NQo2onKKp0dudC4tn2QJnt/jaNroUOC5tiz/RkHJ+SfWpa4alZJafn5IA044pnWCJxOlTleazG52ST/7HWoBPt4Se7Y073J52dnAkNMEIpzPVQg/fhpsDjbWEnumJO9Sacnph2dkoWvhRGKHlCNAMAXwJjAVMGuZoAAAAASUVORK5CYII=" alt="" style="position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;object-position:center;opacity:1;transition-delay:500ms"/><picture><source type="image/webp" srcSet="/static/527adeb9fa98ccee34f98ce928095dcc/008ad/featured-nodejs-csv-importer.webp 200w,
/static/527adeb9fa98ccee34f98ce928095dcc/aeeb3/featured-nodejs-csv-importer.webp 400w,
/static/527adeb9fa98ccee34f98ce928095dcc/932c5/featured-nodejs-csv-importer.webp 800w,
/static/527adeb9fa98ccee34f98ce928095dcc/e67f6/featured-nodejs-csv-importer.webp 878w" sizes="(max-width: 800px) 100vw, 800px"/><source srcSet="/static/527adeb9fa98ccee34f98ce928095dcc/1da13/featured-nodejs-csv-importer.png 200w,
/static/527adeb9fa98ccee34f98ce928095dcc/e0693/featured-nodejs-csv-importer.png 400w,
/static/527adeb9fa98ccee34f98ce928095dcc/e29ef/featured-nodejs-csv-importer.png 800w,
/static/527adeb9fa98ccee34f98ce928095dcc/f5c5d/featured-nodejs-csv-importer.png 878w" sizes="(max-width: 800px) 100vw, 800px"/><img sizes="(max-width: 800px) 100vw, 800px" srcSet="/static/527adeb9fa98ccee34f98ce928095dcc/1da13/featured-nodejs-csv-importer.png 200w,
/static/527adeb9fa98ccee34f98ce928095dcc/e0693/featured-nodejs-csv-importer.png 400w,
/static/527adeb9fa98ccee34f98ce928095dcc/e29ef/featured-nodejs-csv-importer.png 800w,
/static/527adeb9fa98ccee34f98ce928095dcc/f5c5d/featured-nodejs-csv-importer.png 878w" src="/static/527adeb9fa98ccee34f98ce928095dcc/e29ef/featured-nodejs-csv-importer.png" alt="" loading="eager" style="position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;object-position:center;opacity:0;transition:opacity 500ms"/></picture><noscript><picture><source type='image/webp' srcset="/static/527adeb9fa98ccee34f98ce928095dcc/008ad/featured-nodejs-csv-importer.webp 200w,
/static/527adeb9fa98ccee34f98ce928095dcc/aeeb3/featured-nodejs-csv-importer.webp 400w,
/static/527adeb9fa98ccee34f98ce928095dcc/932c5/featured-nodejs-csv-importer.webp 800w,
/static/527adeb9fa98ccee34f98ce928095dcc/e67f6/featured-nodejs-csv-importer.webp 878w" sizes="(max-width: 800px) 100vw, 800px" /><source srcset="/static/527adeb9fa98ccee34f98ce928095dcc/1da13/featured-nodejs-csv-importer.png 200w,
/static/527adeb9fa98ccee34f98ce928095dcc/e0693/featured-nodejs-csv-importer.png 400w,
/static/527adeb9fa98ccee34f98ce928095dcc/e29ef/featured-nodejs-csv-importer.png 800w,
/static/527adeb9fa98ccee34f98ce928095dcc/f5c5d/featured-nodejs-csv-importer.png 878w" sizes="(max-width: 800px) 100vw, 800px" /><img loading="eager" sizes="(max-width: 800px) 100vw, 800px" srcset="/static/527adeb9fa98ccee34f98ce928095dcc/1da13/featured-nodejs-csv-importer.png 200w,
/static/527adeb9fa98ccee34f98ce928095dcc/e0693/featured-nodejs-csv-importer.png 400w,
/static/527adeb9fa98ccee34f98ce928095dcc/e29ef/featured-nodejs-csv-importer.png 800w,
/static/527adeb9fa98ccee34f98ce928095dcc/f5c5d/featured-nodejs-csv-importer.png 878w" src="/static/527adeb9fa98ccee34f98ce928095dcc/e29ef/featured-nodejs-csv-importer.png" alt="" style="position:absolute;top:0;left:0;opacity:1;width:100%;height:100%;object-fit:cover;object-position:center"/></picture></noscript></div><section class="postStyle__StyledPost-sc-1q9n7ky-6 fuGkXD post"><h2 id="tản-mạn" style="position:relative;"><a href="#t%E1%BA%A3n-m%E1%BA%A1n" aria-label="tản mạn permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Tản mạn</h2>
<p>Nodejs luôn luôn là một lựa chọn tốt cho startup.</p>
<p>Lý do ư?</p>
<ul>
<li>Nhanh (có hàng tá bài viết nói tại sao Nodejs lại nhanh rồi)</li>
<li>Dễ code, dễ học, dễ tiếp cận, và dễ maintain: Nhân sĩ trên giang hồ chỉ cần biết một môn công pháp Javascript thôi là đã đủ để luyện cả 2 phần backend và frontend.</li>
<li>Thư viện hỗ trợ nhiều, cộng đồng đông đảo.</li>
</ul>
<p>Tình cờ hôm bữa mình lướt thấy 1 bài viết nói về tối ưu hiệu suất cho Nodejs, mình nghĩ bụng hay là làm một cái thử xem nhỉ. Ơ thế là làm thật, và ra bài viết này.</p>
<blockquote>
<p>⚠️ Cảnh báo: Bài viết rất dài và chi tiết.</p>
</blockquote>
<h2 id="giới-thiệu-về-project" style="position:relative;"><a href="#gi%E1%BB%9Bi-thi%E1%BB%87u-v%E1%BB%81-project" aria-label="giới thiệu về project permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Giới thiệu về project</h2>
<p>Mình đã quyết định thử nghiệm một chút với Nodejs, và sẽ làm 2 phần, phần đầu tiên sẽ là dựng một service để phục vụ mục đích chính là import CSV.</p>
<p>Phần tiếp theo sẽ là tối ưu performance. Đợi bài sau sẽ rõ.</p>
<h3 id="tại-sao-lại-la-import-csv" style="position:relative;"><a href="#t%E1%BA%A1i-sao-l%E1%BA%A1i-la-import-csv" aria-label="tại sao lại la import csv permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Tại sao lại là import CSV?</h3>
<p>Thực ra các project CRUD đã quá nhiều rồi, mà mình muốn test thử hiệu năng, cho nên CSV là một lựa chọn không tồi để thử sức với các dataset lớn hàng trăm nghìn dòng, hoặc hàng triệu dòng, mà cũng là do một phần mình đọc được bài viết này <sup id="fnref-1"><a href="#fn-1" class="footnote-ref">1</a></sup>.</p>
<p>Mà thực tế các hệ thống hiện nay vẫn còn dùng CSV Importer đấy thôi, trong đó có công ty mình.</p>
<h3 id="ưu-diểm-của-csv" style="position:relative;"><a href="#%C6%B0u-di%E1%BB%83m-c%E1%BB%A7a-csv" aria-label="ưu diểm của csv permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Ưu điểm của CSV</h3>
<ul>
<li>Thân thiện hơn với user non-tech</li>
<li>Dễ dàng quản lý relationship</li>
<li>Có thể dùng để migrate data từ hệ thống cũ qua hệ thống với với sự khác biệt về cấu trúc data.</li>
<li>… bạn tự điền nếu bạn có dùng rồi 😂.</li>
</ul>
<h2 id="first-thing-first" style="position:relative;"><a href="#first-thing-first" aria-label="first thing first permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>First thing first</h2>
<p>Again, nếu bạn không biết thì mình là Kiên bê đê (lúc đi cùng bạn gái), một anh chàng developer thích viết. Mình đang cố gắng nâng cao kiến thức về máy tính và lập trình bằng nhiều cách như đọc sách, học các khóa học, đọc, và cả viết blog cho mấy cái experiment của mình nữa.</p>
<p>Hi vọng những bài viết của mình sẽ giúp được bạn, mình rất vui ❤️.</p>
<h2 id="bắt-tay-vao-code" style="position:relative;"><a href="#b%E1%BA%AFt-tay-vao-code" aria-label="bắt tay vao code permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Bắt tay vào code</h2>
<p>Và đây là cấu trúc dự án mình đã code xong version 1:</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 943px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/928e96121d62a0551901af615dc23eec/146da/nodejs-products-csv-project-structure.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 102%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAIAAAAC64paAAAACXBIWXMAAA7EAAAOxAGVKw4bAAAC00lEQVQ4y2WUyXIbNxCG+SaWSM4MgMbe2IFZSIq2YstRqnJIJadc8gbOwdckD54aUqYip+qrOeGb7r+xbOSnv+P0NJ9/Cu0xjI+uvm/HHzGfMT9gfhBYuU6As25PdnoS4YRpUukoXFEub3Yd4UK3tqQyKu2FtNp4yiQDCVwR7igPGmcIM/gJwsz8RE2hJg/cbQi3Eki2ckwBFVe0V6zXQK5QjlQEpSr4kWFhtlAVCeAKd5v9ILKGUzTZyqQhShIlCYIEucIEUh5AZeYqw0qEH5gl3BHuBsDNfQf7QRjMxqWOym0H2/4VAshkNGF0ccaVJdYHlw+YFp+Pq3zXAQE9L0euw7sdve/gBuHIZBCmCj9x10AlJgOoeP1urosGJudlDuWw7fn9nv1HdkwErgrDte01sPArt7bvL5WXZanLIyh/91YGGY2dVtkWcI3Z8vIX7l7leVlcmjuq37btmIrCZgI4fOM66le5p+JwmGI7gfLbtzJ3WZpsfQGVuF4zX80X+a6DjvDDMsZ25Pp/bdvEcVRYtWvGj1yn4bvKTGIbZ2kzE/hmYMIxEbnO1NVBhZ6aHuyt/1V+twfCTWoH5dp2UHd7eOGaWUZQSZiqTJMqS1WlLEpVIfMqA4OMpuWspWKEcsZuXI+ntFXb0brJuglxvrAgLpvtICiFaaopVWMspazvh28QKhzTSWPVmKkM3GTQkZvETeYmb3qm9yLlH37Jy3NcnmV46ETd8bLjdccCAQSblJ8NFolVYZW2UO4Hdsk8gFTTr+ff/nn+/a/556/x6Uv6/Gf6/CU/f8XzHwMYJoKwVZgibVZYlVtv+Mu0mcRQxuXDxzafQm7GRe3CDVCRu4xhqu0gbTF+NH5aiwtPhd/0VFPplJ8UFu0b1+HleK8bxtZp62zqY2znPL4fp5NLs9BZmJVLZiI7IjuqdoNYze9vVbTtg68PuZ1COfpysGFSl+fpX4st5T+IaAuzAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/928e96121d62a0551901af615dc23eec/c85cb/nodejs-products-csv-project-structure.webp 300w,
/static/928e96121d62a0551901af615dc23eec/e88ff/nodejs-products-csv-project-structure.webp 600w,
/static/928e96121d62a0551901af615dc23eec/18615/nodejs-products-csv-project-structure.webp 943w"
              sizes="(max-width: 943px) 100vw, 943px"
              type="image/webp"
            />
          <source
            srcset="/static/928e96121d62a0551901af615dc23eec/5a46d/nodejs-products-csv-project-structure.png 300w,
/static/928e96121d62a0551901af615dc23eec/0a47e/nodejs-products-csv-project-structure.png 600w,
/static/928e96121d62a0551901af615dc23eec/146da/nodejs-products-csv-project-structure.png 943w"
            sizes="(max-width: 943px) 100vw, 943px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/928e96121d62a0551901af615dc23eec/146da/nodejs-products-csv-project-structure.png"
            alt="nodejs-products-csv-project-structure.png"
            title="nodejs-products-csv-project-structure.png"
            loading="lazy"
            decoding="async"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span></p>
<p>Code hiện có ở trên github repo<sup id="fnref-2"><a href="#fn-2" class="footnote-ref">2</a></sup>, các bạn tham khảo nhé.</p>
<h3 id="khởi-tạo-nodejs-project" style="position:relative;"><a href="#kh%E1%BB%9Fi-t%E1%BA%A1o-nodejs-project" aria-label="khởi tạo nodejs project permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Khởi tạo Nodejs Project</h3>
<p>Mình thích typescript hơn javascript nhiều, tuy nhiên sau khi dùng Goland/IntelliJ để code thì intellisense hoạt động rất tốt, mình cảm giác không cần typescript cũng không sao 😄. Vậy nên để tập trung vào vấn đề chính, mình code Javascript cho lẹ.</p>
<p>Mình giả định các bạn cũng dùng Linux/Mac, nên mình dùng command trên linux luôn.</p>
<p>Tạo folder và init:</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">mkdir</span> nodejs-product-csv <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">cd</span> nodejs-product-csv</code></pre></div>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">yarn</span> init</code></pre></div>
<p>Điền vài thông tin cơ bản xong thì đến với bước thêm thư viện:</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">yarn</span> <span class="token function">add</span> express ejs multer fast-csv csv-writer pg sequelize colors</code></pre></div>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">yarn</span> <span class="token function">add</span> -D nodemon autocannon @faker-js/faker</code></pre></div>
<p>Đến đây thì để tại hạ phải ra mặt giới thiệu những thư viện trên cho các đạo hữu rồi:</p>
<ul>
<li><strong>express</strong>: Web framework của nodejs, nổi tiếng nhỏ mà có võ.</li>
<li><strong>ejs</strong>: Javascript template engine, dùng như Razor trong .NET vậy, giúp chúng ta render các file template HTML.</li>
<li><strong>multer</strong>: Middleware hỗ trợ cache file upload.</li>
<li><strong>fast-csv</strong>, <strong>csv-writer</strong>: Hai thư viện này phục vụ cho việc đọc và xuất CSV từ dữ liệu của chúng ta.</li>
<li><strong>pg</strong>: Driver cho postgresql.</li>
<li><strong>sequelize:</strong> ORM này hỗ trợ tốt việc define schema và khá tối ưu query. Mình chọn sequelize vì nó khá đơn giản, còn nếu làm typeorm hay prisma thì hiệu năng cao hơn, nhưng tốn thời gian setup hơn nên mình lười.
Thêm vào đó, với kinh nghiệm của mình thi sequelize cũng hỗ trợ query tốt hơn trong trường hợp không sử dụng raw-query, đặc biệt là các field JSON.</li>
</ul>
<p>Tương tự mình cũng cài thêm vài package hỗ trợ cho việc dev mượt mà hơn:</p>
<ul>
<li><strong>nodemon</strong>: Hỗ trợ reload app khi chúng ta thay đổi code (watch mode).</li>
<li><strong>autocannon</strong>: HTTP benchmark tool, giúp mình đo hiệu năng của app.</li>
<li><strong>@faker-js/faker</strong>: Thư viện hỗ trợ fake data, rất hữu ích trong việc generate cả triệu dòng CSV để test.</li>
</ul>
<h4 id="cấu-truc-thư-mục" style="position:relative;"><a href="#c%E1%BA%A5u-truc-th%C6%B0-m%E1%BB%A5c" aria-label="cấu truc thư mục permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Cấu trúc thư mục</h4>
<p>Trước khi code mình show cho các bạn xem cấu trúc thư mục, để cho các phần tiếp theo được dễ hình dung:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">.
├── bench
│   ├── sample-csv
│   └── v1.bash
├── csv-generator.js
├── data
│   └── postgres //readonly
├── docker-compose.yml
├── package.json
├── src
│   ├── config
│   │   └── db.js
│   ├── handlers
│   │   ├── index.js
│   │   └── product.js
│   ├── index.js
│   ├── middlewares
│   │   ├── fileUpload.js
│   │   └── logger.js
│   ├── models
│   │   ├── categoryInit.js
│   │   ├── index.js
│   │   ├── productInit.js
│   │   └── sequelize.js
│   ├── utils
│   │   └── pathHelper.js
│   └── views
└── static
    ├── exports
    └── uploads</code></pre></div>
<h3 id="dựng-database-postgresql" style="position:relative;"><a href="#d%E1%BB%B1ng-database-postgresql" aria-label="dựng database postgresql permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Dựng database postgresql</h3>
<p>Như trong bài trước về <a href="https://devgiangho.github.io/golang-slice-tat-tan-tat-va-nhung-dieu-co-the-ban-chua-biet/">connection pooling</a>, mình đã tạo 1 DB postgres cho bảng Product rất đơn giản. Bài này mình dùng lại cái schema đó và có vài thay đổi.</p>
<p>Lần này mình có 1 bảng Product, liên kết khóa ngoại tới bảng Category.</p>
<p>File <code class="language-text">seed.sql</code> để khởi tạo database và chèn sẵn 10 danh mục (category):</p>
<div class="gatsby-highlight" data-language="sql"><pre class="language-sql"><code class="language-sql"><span class="token comment">-- We need double quoted the column names to preserve the case.</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> categories
<span class="token punctuation">(</span>
    id          <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">36</span><span class="token punctuation">)</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span>
    name        <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    description <span class="token keyword">TEXT</span><span class="token punctuation">,</span>
    code        <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span>  <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token string">"createdAt"</span> <span class="token keyword">TIMESTAMP</span>    <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token string">"updatedAt"</span> <span class="token keyword">TIMESTAMP</span>    <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> products
<span class="token punctuation">(</span>
    id           <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">36</span><span class="token punctuation">)</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span>
    name         <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span>   <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    price        <span class="token keyword">NUMERIC</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    description  <span class="token keyword">TEXT</span><span class="token punctuation">,</span>
    <span class="token string">"categoryId"</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">36</span><span class="token punctuation">)</span>    <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token string">"createdAt"</span>  <span class="token keyword">TIMESTAMP</span>      <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token string">"updatedAt"</span>  <span class="token keyword">TIMESTAMP</span>      <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">CONSTRAINT</span> products_categoryId_fk <span class="token keyword">FOREIGN</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token string">"categoryId"</span><span class="token punctuation">)</span> <span class="token keyword">REFERENCES</span> categories <span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token keyword">ON</span> <span class="token keyword">DELETE</span> <span class="token keyword">CASCADE</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> categories <span class="token punctuation">(</span>id<span class="token punctuation">,</span> name<span class="token punctuation">,</span> description<span class="token punctuation">,</span> code<span class="token punctuation">)</span>
<span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'b2ff1377-c40c-4c10-b3a4-4d12c2f90bca'</span><span class="token punctuation">,</span> <span class="token string">'Electronics'</span><span class="token punctuation">,</span> <span class="token string">'Category for electronic devices'</span><span class="token punctuation">,</span> <span class="token string">'ELC'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
       <span class="token punctuation">(</span><span class="token string">'8c054e34-e65d-4b6e-b7f1-9d9b556e10d1'</span><span class="token punctuation">,</span> <span class="token string">'Clothing'</span><span class="token punctuation">,</span> <span class="token string">'Category for clothing items'</span><span class="token punctuation">,</span> <span class="token string">'CLT'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
       <span class="token punctuation">(</span><span class="token string">'a18b11cc-9a2e-4a04-b831-dde4667e8e0a'</span><span class="token punctuation">,</span> <span class="token string">'Books'</span><span class="token punctuation">,</span> <span class="token string">'Category for books and literature'</span><span class="token punctuation">,</span> <span class="token string">'BKS'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
       <span class="token punctuation">(</span><span class="token string">'773e7aa3-f06d-42af-a8c3-3cb50d966f26'</span><span class="token punctuation">,</span> <span class="token string">'Home &amp; Kitchen'</span><span class="token punctuation">,</span> <span class="token string">'Category for home and kitchen products'</span><span class="token punctuation">,</span> <span class="token string">'HKP'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
       <span class="token punctuation">(</span><span class="token string">'b8f3c3eb-30f6-41dd-a7b8-518ff2db616f'</span><span class="token punctuation">,</span> <span class="token string">'Health &amp; Beauty'</span><span class="token punctuation">,</span> <span class="token string">'Category for health and beauty products'</span><span class="token punctuation">,</span> <span class="token string">'HBP'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
       <span class="token punctuation">(</span><span class="token string">'5c6f5df6-5c5f-4a69-a38c-95d330c156e2'</span><span class="token punctuation">,</span> <span class="token string">'Toys &amp; Games'</span><span class="token punctuation">,</span> <span class="token string">'Category for toys and games'</span><span class="token punctuation">,</span> <span class="token string">'TNG'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
       <span class="token punctuation">(</span><span class="token string">'54b31c80-38f6-4e6a-9f70-049a8e0905c9'</span><span class="token punctuation">,</span> <span class="token string">'Sports &amp; Outdoors'</span><span class="token punctuation">,</span> <span class="token string">'Category for sports and outdoor products'</span><span class="token punctuation">,</span> <span class="token string">'SPO'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
       <span class="token punctuation">(</span><span class="token string">'66d74c4b-4b4d-4a54-935d-6b0b6faa07f4'</span><span class="token punctuation">,</span> <span class="token string">'Automotive'</span><span class="token punctuation">,</span> <span class="token string">'Category for automotive products'</span><span class="token punctuation">,</span> <span class="token string">'AUT'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
       <span class="token punctuation">(</span><span class="token string">'23212a97-74af-460e-bd3d-7b1320dd1c25'</span><span class="token punctuation">,</span> <span class="token string">'Office Products'</span><span class="token punctuation">,</span> <span class="token string">'Category for office supplies and stationery'</span><span class="token punctuation">,</span>
        <span class="token string">'OFS'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
       <span class="token punctuation">(</span><span class="token string">'141d2f17-91d8-4f9d-9143-3b8213c6f5a5'</span><span class="token punctuation">,</span> <span class="token string">'Pet Supplies'</span><span class="token punctuation">,</span> <span class="token string">'Category for pet supplies and accessories'</span><span class="token punctuation">,</span> <span class="token string">'PET'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>Có một lưu ý nhỏ, postgresql không giống với SQLServer, khi chúng ta tạo table thì nó sẽ tự động lowercase hết column name như <code class="language-text">createdAt → createdat</code> và làm cho Sequelize query bị lỗi.</p>
<p>Để né việc đó, chúng ta cần thêm nháy kép (<code class="language-text">&quot;createdAt&quot;</code>) trong DDL.</p>
<p>Tiếp tục tạo file <code class="language-text">docker-compose.yml</code> để seed data:</p>
<div class="gatsby-highlight" data-language="sql"><pre class="language-sql"><code class="language-sql">version: <span class="token string">"3.9"</span>

services:
  postgres:
    image: postgres:<span class="token number">13.1</span><span class="token operator">-</span>alpine
    container_name: product_postgres_container
    volumes:
      <span class="token operator">-</span> <span class="token punctuation">.</span><span class="token operator">/</span>seed<span class="token punctuation">.</span><span class="token keyword">sql</span>:<span class="token operator">/</span>docker<span class="token operator">-</span>entrypoint<span class="token operator">-</span>initdb<span class="token punctuation">.</span>d<span class="token operator">/</span>seed<span class="token punctuation">.</span><span class="token keyword">sql</span>
      <span class="token operator">-</span> <span class="token punctuation">.</span><span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>postgres:<span class="token operator">/</span>var<span class="token operator">/</span>lib<span class="token operator">/</span>postgresql<span class="token operator">/</span><span class="token keyword">data</span>
    environment:
      <span class="token operator">-</span> POSTGRES_DB<span class="token operator">=</span>${POSTGRES_DB:<span class="token operator">-</span>postgres}
      <span class="token operator">-</span> POSTGRES_USER<span class="token operator">=</span>${POSTGRES_USER:<span class="token operator">-</span>postgres}
      <span class="token operator">-</span> POSTGRES_PASSWORD<span class="token operator">=</span>${POSTGRES_PASSWORD:<span class="token operator">-</span>password1}
    ports:
      <span class="token operator">-</span> <span class="token string">"5433:5432"</span>
    restart: unless<span class="token operator">-</span>stopped</code></pre></div>
<p>Giờ ta chỉ cần chạy <code class="language-text">docker compose up -d</code> là đã có 1 instance postgres ở cổng 5433.</p>
<h3 id="dựng-model-va-kết-nối-database" style="position:relative;"><a href="#d%E1%BB%B1ng-model-va-k%E1%BA%BFt-n%E1%BB%91i-database" aria-label="dựng model va kết nối database permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Dựng model và kết nối database</h3>
<p>Mình trước hết cần một file config để lưu thiết lập, connection string của database, đó là file <code class="language-text">/src/config/db.js</code> :</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> dbConfig <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token constant">HOST</span><span class="token punctuation">:</span> <span class="token string">"localhost"</span><span class="token punctuation">,</span>
  <span class="token constant">USER</span><span class="token punctuation">:</span> <span class="token string">"postgres"</span><span class="token punctuation">,</span>
  <span class="token constant">PASSWORD</span><span class="token punctuation">:</span> <span class="token string">"password1"</span><span class="token punctuation">,</span>
  <span class="token constant">PORT</span><span class="token punctuation">:</span> <span class="token string">"5433"</span><span class="token punctuation">,</span>
  <span class="token constant">DB</span><span class="token punctuation">:</span> <span class="token string">"postgres"</span><span class="token punctuation">,</span>
  dialect<span class="token punctuation">:</span> <span class="token string">"postgres"</span><span class="token punctuation">,</span>
  pool<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    max<span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token comment">// max pool size</span>
    min<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">// min pool size</span>
    acquire<span class="token punctuation">:</span> <span class="token number">3000</span><span class="token punctuation">,</span> <span class="token comment">// timeout to wait connection in  milliseconds</span>
    idle<span class="token punctuation">:</span> <span class="token number">10000</span><span class="token punctuation">,</span> <span class="token comment">// idle time in milliseconds</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> dbConfig<span class="token punctuation">;</span></code></pre></div>
<p>Ở đây mình hardcode luôn các biến môi trường, thực tế có thể thêm vài dòng để đọc ra từ file <code class="language-text">.env</code> .</p>
<p>Sequelize có hỗ trợ connection pooling mặc định luôn trong các thiết đặt, nếu bạn chưa biết thì đọc bài viết trước<sup id="fnref-3"><a href="#fn-3" class="footnote-ref">3</a></sup> của mình nhé.</p>
<p>Vào folder <code class="language-text">src/models</code> để chúng ta làm việc tiếp, đầu tiên chúng ta cần 1 instance của Sequelize, lấy config từ file config hồi nãy:</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">import</span> dbConfig <span class="token keyword">from</span> <span class="token string">"../config/db.js"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Sequelize <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"sequelize"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> colors <span class="token keyword">from</span> <span class="token string">"colors"</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> sequelize <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Sequelize</span><span class="token punctuation">(</span>
  dbConfig<span class="token punctuation">.</span><span class="token constant">DB</span><span class="token punctuation">,</span>
  dbConfig<span class="token punctuation">.</span><span class="token constant">USER</span><span class="token punctuation">,</span>
  dbConfig<span class="token punctuation">.</span><span class="token constant">PASSWORD</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    host<span class="token punctuation">:</span> dbConfig<span class="token punctuation">.</span><span class="token constant">HOST</span><span class="token punctuation">,</span>
    dialect<span class="token punctuation">:</span> dbConfig<span class="token punctuation">.</span>dialect<span class="token punctuation">,</span>
    operatorsAliases<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    port<span class="token punctuation">:</span> dbConfig<span class="token punctuation">.</span><span class="token constant">PORT</span><span class="token punctuation">,</span>
    pool<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      max<span class="token punctuation">:</span> dbConfig<span class="token punctuation">.</span>pool<span class="token punctuation">.</span>max<span class="token punctuation">,</span>
      min<span class="token punctuation">:</span> dbConfig<span class="token punctuation">.</span>pool<span class="token punctuation">.</span>min<span class="token punctuation">,</span>
      acquire<span class="token punctuation">:</span> dbConfig<span class="token punctuation">.</span>pool<span class="token punctuation">.</span>acquire<span class="token punctuation">,</span>
      idle<span class="token punctuation">:</span> dbConfig<span class="token punctuation">.</span>pool<span class="token punctuation">.</span>idle<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    define<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      timestamps<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      underscored<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    benchmark<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token function-variable function">logging</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">message<span class="token punctuation">,</span> execTime</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>message<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">500</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        message <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"... (truncated)"</span><span class="token punctuation">;</span>
        <span class="token comment">// You can use something like cloud logging...</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">let</span> color <span class="token operator">=</span> colors<span class="token punctuation">.</span>blue<span class="token punctuation">.</span>bold<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>execTime <span class="token operator">&amp;&amp;</span> execTime <span class="token operator">>=</span> <span class="token number">30</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        color <span class="token operator">=</span> colors<span class="token punctuation">.</span>red<span class="token punctuation">.</span>bold<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>colors<span class="token punctuation">.</span>magenta<span class="token punctuation">.</span><span class="token function">bold</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>execTime<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> ms]</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">color</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

sequelize
  <span class="token punctuation">.</span><span class="token function">authenticate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Connection has been established successfully."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Unable to connect to the database:"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> sequelize<span class="token punctuation">;</span></code></pre></div>
<p>Ở đây mình cũng làm luôn 1 cái logger đơn giản cho sequelize, để in ra những query nào tốn thời gian để thực thi thì bôi nó thành màu đỏ, khỏi cần dùng ASCII code vì có thư viện colors lo.</p>
<p>Tiếp tục define model schema cho bảng Product và Category tương tứng 2 file <code class="language-text">ProductInit.js</code> và <code class="language-text">CategoryInit.js</code>:</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">import</span> Sequelize <span class="token keyword">from</span> <span class="token string">"sequelize"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> sequelize <span class="token keyword">from</span> <span class="token string">"./sequelize.js"</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> ProductInit <span class="token operator">=</span> sequelize<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">"products"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  id<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    type<span class="token punctuation">:</span> Sequelize<span class="token punctuation">.</span><span class="token constant">UUID</span><span class="token punctuation">,</span>
    defaultValue<span class="token punctuation">:</span> Sequelize<span class="token punctuation">.</span><span class="token constant">UUIDV4</span><span class="token punctuation">,</span>
    primaryKey<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  name<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    type<span class="token punctuation">:</span> Sequelize<span class="token punctuation">.</span><span class="token constant">STRING</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  price<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    type<span class="token punctuation">:</span> Sequelize<span class="token punctuation">.</span><span class="token constant">FLOAT</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  description<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    type<span class="token punctuation">:</span> Sequelize<span class="token punctuation">.</span><span class="token constant">STRING</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  categoryId<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    type<span class="token punctuation">:</span> Sequelize<span class="token punctuation">.</span><span class="token constant">UUID</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  createdAt<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    type<span class="token punctuation">:</span> Sequelize<span class="token punctuation">.</span><span class="token constant">DATE</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  updatedAt<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    type<span class="token punctuation">:</span> Sequelize<span class="token punctuation">.</span><span class="token constant">DATE</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> ProductInit<span class="token punctuation">;</span></code></pre></div>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">import</span> Sequelize <span class="token keyword">from</span> <span class="token string">"sequelize"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> sequelize <span class="token keyword">from</span> <span class="token string">"./sequelize.js"</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> CategoryInit <span class="token operator">=</span> sequelize<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">"categories"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  id<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    type<span class="token punctuation">:</span> Sequelize<span class="token punctuation">.</span><span class="token constant">UUID</span><span class="token punctuation">,</span>
    defaultValue<span class="token punctuation">:</span> Sequelize<span class="token punctuation">.</span><span class="token constant">UUIDV4</span><span class="token punctuation">,</span>
    primaryKey<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  name<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    type<span class="token punctuation">:</span> Sequelize<span class="token punctuation">.</span><span class="token constant">STRING</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  code<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    type<span class="token punctuation">:</span> Sequelize<span class="token punctuation">.</span><span class="token constant">STRING</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  description<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    type<span class="token punctuation">:</span> Sequelize<span class="token punctuation">.</span><span class="token constant">STRING</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  createdAt<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    type<span class="token punctuation">:</span> Sequelize<span class="token punctuation">.</span><span class="token constant">DATE</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  updatedAt<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    type<span class="token punctuation">:</span> Sequelize<span class="token punctuation">.</span><span class="token constant">DATE</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> CategoryInit<span class="token punctuation">;</span></code></pre></div>
<p>Tạo 1 file <code class="language-text">index.js</code> để khai báo thêm ràng buộc khóa ngoại cho 2 table trên.</p>
<p>Ở đây Product và Category có quan hệ Many-To-One, cho nên mình sử dụng 2 phương thức của Sequelize là <code class="language-text">hasMany</code> và <code class="language-text">belongsTo</code> .</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">import</span> ProductInit <span class="token keyword">from</span> <span class="token string">"./productInit.js"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> CategoryInit <span class="token keyword">from</span> <span class="token string">"./categoryInit.js"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Sequelize <span class="token keyword">from</span> <span class="token string">"sequelize"</span><span class="token punctuation">;</span>

CategoryInit<span class="token punctuation">.</span>Products <span class="token operator">=</span> CategoryInit<span class="token punctuation">.</span><span class="token function">hasMany</span><span class="token punctuation">(</span>ProductInit<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  foreignKey<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    name<span class="token punctuation">:</span> <span class="token string">"categoryId"</span><span class="token punctuation">,</span>
    type<span class="token punctuation">:</span> Sequelize<span class="token punctuation">.</span><span class="token constant">UUID</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

ProductInit<span class="token punctuation">.</span><span class="token function">belongsTo</span><span class="token punctuation">(</span>CategoryInit<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  foreignKey<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    name<span class="token punctuation">:</span> <span class="token string">"categoryId"</span><span class="token punctuation">,</span>
    type<span class="token punctuation">:</span> Sequelize<span class="token punctuation">.</span><span class="token constant">UUID</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token punctuation">{</span> ProductInit <span class="token keyword">as</span> Product<span class="token punctuation">,</span> CategoryInit <span class="token keyword">as</span> Category <span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div>
<p>Có thể bạn sẽ hỏi tại sao mình không khai báo luôn relationship ở trong <code class="language-text">ProductInit</code> và <code class="language-text">CategoryInit</code> . Đáp án là bởi vì nếu làm vậy sẽ xảy ra lỗi circular import.</p>
<p>Mình cũng muốn export chỉ mỗi model để thao tác query, nên cũng không gán 2 model này vào instance của Sequelize. Coi tiếp phần dưới thì bạn sẽ thấy mình chỉ import model từ <code class="language-text">models/index.js</code> mà thôi.</p>
<h3 id="cache-lại-file-da-upload" style="position:relative;"><a href="#cache-l%E1%BA%A1i-file-da-upload" aria-label="cache lại file da upload permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Cache lại file đã upload</h3>
<p>Như bạn đã biết, lúc import thì file CSV có thể lên tới hàng triệu dòng, do vậy nên kích thước file khá là lớn (tầm 150mb cho 1 triệu dòng), thế nên việc cache lại file vào ổ cứng là điều bắt buộc phải làm.</p>
<p>Tạo 1 middleware <code class="language-text">middlewares/fileUpload.js</code> :</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">import</span> fs <span class="token keyword">from</span> <span class="token string">"fs"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> multer <span class="token keyword">from</span> <span class="token string">"multer"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> appDir <span class="token keyword">from</span> <span class="token string">"../utils/pathHelper.js"</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> storage <span class="token operator">=</span> multer<span class="token punctuation">.</span><span class="token function">diskStorage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function-variable function">destination</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">_req<span class="token punctuation">,</span> file<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> dir <span class="token operator">=</span> appDir <span class="token operator">+</span> <span class="token string">"static/uploads"</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fs<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span>dir<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      fs<span class="token punctuation">.</span><span class="token function">mkdirSync</span><span class="token punctuation">(</span>dir<span class="token punctuation">,</span> <span class="token punctuation">{</span> recursive<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> dir<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">filename</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">_req<span class="token punctuation">,</span> file<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>process<span class="token punctuation">.</span>hrtime<span class="token punctuation">.</span><span class="token function">bigint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>file<span class="token punctuation">.</span>originalname<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">csvFilter</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">_req<span class="token punctuation">,</span> file<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Reading file in middleware"</span><span class="token punctuation">,</span> file<span class="token punctuation">.</span>originalname<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>file<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">callback</span><span class="token punctuation">(</span><span class="token string">"Please upload a file to proceed."</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>file<span class="token punctuation">.</span>mimetype<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">"csv"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">callback</span><span class="token punctuation">(</span>
      <span class="token string">"Please upload only csv file as only CSV is supported for now."</span><span class="token punctuation">,</span>
      <span class="token boolean">false</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">multer</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  storage<span class="token punctuation">:</span> storage<span class="token punctuation">,</span>
  fileFilter<span class="token punctuation">:</span> csvFilter<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>Đặc thù hệ thống là import CSV, do vậy nên middleware này chỉ cho phép upload file có đuôi csv mà thôi, sau đó cache lại trong ổ đĩa.</p>
<p>Ở đây mình cache lại file name theo dạng <code class="language-text">${process.hrtime.bigint()}-${file.originalname}</code>.</p>
<p>Lý do mình dùng <code class="language-text">process.hrtime.bigint()</code> thay vì <code class="language-text">Date.now()</code> chính là khi mình thực hiện stress test (ở bước tiếp theo) thì lượng request đồng thời rất lớn, khiến cho hàm <code class="language-text">Date.now()</code> trả về giá trị đôi lúc giống nhau, cho nên file bị conflict.
<code class="language-text">process.hrtime.bigint()</code> sẽ có resolution cao hơn, trả về nanoseconds, còn <code class="language-text">Date.now()</code> trả về milliseconds<sup id="fnref-4"><a href="#fn-4" class="footnote-ref">4</a></sup>.</p>
<p>Ở đây do với chế độ module thì thằng quỷ Nodejs không cho phép gọi <code class="language-text">__dirname</code>. Nên mình làm 1 cái file helper để lấy folder root của project nằm ở <code class="language-text">utils/pathHelper.js</code>:</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">import</span> path <span class="token keyword">from</span> <span class="token string">"path"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> fileURLToPath <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"url"</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> __dirname <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span><span class="token function">fileURLToPath</span><span class="token punctuation">(</span><span class="token keyword">import</span><span class="token punctuation">.</span>meta<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> appDir <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">"../../"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> appDir<span class="token punctuation">;</span></code></pre></div>
<h3 id="cac-endpoint-rest-api" style="position:relative;"><a href="#cac-endpoint-rest-api" aria-label="cac endpoint rest api permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Các endpoint REST API</h3>
<p>Như đã nói ở đầu bài viết, mục đích chính của service này là để import CSV. Do đó mình chỉ có vài endpoint sau:</p>
<ul>
<li><code class="language-text">/</code> - GET: Index, dùng để làm giao diện cho form upload CSV.</li>
<li><code class="language-text">/api/products</code> - GET: Lấy 200 product mới nhất để hiển thị.</li>
<li><code class="language-text">/api/products/:id</code> - GET: Lấy product theo ID.</li>
<li><code class="language-text">/api/products/export</code> - GET: Export products ra file CSV và download.</li>
<li><code class="language-text">/api/products/import</code> - POST: Import CSV file.</li>
</ul>
<p>Handler của những endpoint này sẽ nằm trong folder <code class="language-text">handlers</code>.</p>
<p>Bắt đầu với file <code class="language-text">product.js</code> cho những handler liên quan em này:</p>
<h4 id="get-many-products" style="position:relative;"><a href="#get-many-products" aria-label="get many products permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Get many products</h4>
<p>Mình query lấy ra 200 product mới nhất:</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">findManyProducts</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">// should add pagination.</span>
    <span class="token keyword">const</span> products <span class="token operator">=</span> <span class="token keyword">await</span> Product<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      limit<span class="token punctuation">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
      include<span class="token punctuation">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          model<span class="token punctuation">:</span> Category<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      order<span class="token punctuation">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">[</span><span class="token string">"updatedAt"</span><span class="token punctuation">,</span> <span class="token string">"DESC"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span><span class="token string">"createdAt"</span><span class="token punctuation">,</span> <span class="token string">"DESC"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      message<span class="token punctuation">:</span> <span class="token string">"OK"</span><span class="token punctuation">,</span>
      data<span class="token punctuation">:</span> products<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      message<span class="token punctuation">:</span> <span class="token string">"internal error"</span><span class="token punctuation">,</span>
      err<span class="token punctuation">:</span> err<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div>
<p>Thực tế cần phải làm thêm phần pagination, nhưng mục tiêu chính mình làm không phải ở đó nên đã bỏ qua.</p>
<p>Mình có dùng option include, tức là sẽ join và lấy luôn Category về, kết quả sẽ hiển thị ở postman như sau:</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1200px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/2af70692ae27664661d65edc11fdd752/e8814/postman-get-many-products.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 61.33333333333334%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAA9hAAAPYQGoP6dpAAABOklEQVQoz42RWW7cQAxEdWafKUfIOXwMG87IaqkXNllcJqDGntjIx/iBIIofJVZTy77vtdZSymVNjuPovRONG/MLzEw0wXOt8+n3+PUsSztKq4eqAgLFKRJVdffrJ2amqveRRPuUxd3N7PodEYnvMPOc8z4qoJCllq33Poh6b2OM3AncPhERN+HuACQdyhACjmFQX1pvvVbqg5kVIiIKuf5HZMVd25l3sQhTBRHDGa4W5lnXR0TEAjWPUBrH2+X1fVyOuVUuTdpUqMtHZch/I1KnmaEWgTHGy8vW+HWjtzIrQdT8jPC138vTG8vM1e6mYyvrTqXJYG0E5J+KB7HTbGmXbRu1rVW2xnUAlu9/YGaomrkqi04xhmdX+9HBOHeE0TjW8mefe5dGINEJExjOzrDbtRh5PIGdF/G/o+O/DIFbthAAAAAASUVORK5CYII='); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/2af70692ae27664661d65edc11fdd752/c85cb/postman-get-many-products.webp 300w,
/static/2af70692ae27664661d65edc11fdd752/e88ff/postman-get-many-products.webp 600w,
/static/2af70692ae27664661d65edc11fdd752/92f8c/postman-get-many-products.webp 1200w,
/static/2af70692ae27664661d65edc11fdd752/f3c7c/postman-get-many-products.webp 1392w"
              sizes="(max-width: 1200px) 100vw, 1200px"
              type="image/webp"
            />
          <source
            srcset="/static/2af70692ae27664661d65edc11fdd752/5a46d/postman-get-many-products.png 300w,
/static/2af70692ae27664661d65edc11fdd752/0a47e/postman-get-many-products.png 600w,
/static/2af70692ae27664661d65edc11fdd752/c1b63/postman-get-many-products.png 1200w,
/static/2af70692ae27664661d65edc11fdd752/e8814/postman-get-many-products.png 1392w"
            sizes="(max-width: 1200px) 100vw, 1200px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/2af70692ae27664661d65edc11fdd752/c1b63/postman-get-many-products.png"
            alt="postman-get-many-products.png"
            title="postman-get-many-products.png"
            loading="lazy"
            decoding="async"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span></p>
<h4 id="get-product-by-id" style="position:relative;"><a href="#get-product-by-id" aria-label="get product by id permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Get product by ID</h4>
<p>Cũng giống với findMany, khi lấy chỉ 1 product theo ID thì chúng ta chỉ cần lấy id từ path params vào thôi:</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">findOneProduct</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> id <span class="token operator">=</span> req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> product <span class="token operator">=</span> <span class="token keyword">await</span> Product<span class="token punctuation">.</span><span class="token function">findByPk</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      include<span class="token punctuation">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          model<span class="token punctuation">:</span> Category<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>product<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        message<span class="token punctuation">:</span> <span class="token string">"OK"</span><span class="token punctuation">,</span>
        data<span class="token punctuation">:</span> product<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        message<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Cannot find Product with id=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      message<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Error retrieving Product with id=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
      error<span class="token punctuation">:</span> err<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div>
<p>Kết quả khi gọi postman:</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1200px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/f49b1ae572906db71cbbb3c4defa3b6b/062c8/postman-get-one-product.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 61%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAA9hAAAPYQGoP6dpAAABOUlEQVQoz4WQXXIcIQyE59S+UY6Qc/gUrtrYM4YFCfTTYlKw3k2ch+xXegCqWnT3di2lEqWU92Pf9z2nxEStNV70O7JorZv0vcjLT/7xKlu9JqIKhLs7HICZmRoABM47WDyuZtZFN1M1s/M7ZjbGOM9z3BGRLvK4+vzBti7C3CLwh+nBx3fmk/lj+wiH26aqjXkuXsHWRiOiW2YiurmdLTSeipkOhXXaTsdeSiHmWutsSLqr/uV3uV+ZPWYlU49ggTk2NVNm5SYeDqhDzb8U/yWAzREw6ykfuR1FSJzEu8IQc3wNwh/nNYjpaTMHItrlcj3y22d7O/g99yupGBzDl+zf8YibWMwQoTnlTHvR0oy6q+Op7SnuahjDaq2XXx+5v+eeSFlcbFp7ItZV/bSiqo6u6M9kX4VF/AY4d78CUCxT/AAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/f49b1ae572906db71cbbb3c4defa3b6b/c85cb/postman-get-one-product.webp 300w,
/static/f49b1ae572906db71cbbb3c4defa3b6b/e88ff/postman-get-one-product.webp 600w,
/static/f49b1ae572906db71cbbb3c4defa3b6b/92f8c/postman-get-one-product.webp 1200w,
/static/f49b1ae572906db71cbbb3c4defa3b6b/df861/postman-get-one-product.webp 1386w"
              sizes="(max-width: 1200px) 100vw, 1200px"
              type="image/webp"
            />
          <source
            srcset="/static/f49b1ae572906db71cbbb3c4defa3b6b/5a46d/postman-get-one-product.png 300w,
/static/f49b1ae572906db71cbbb3c4defa3b6b/0a47e/postman-get-one-product.png 600w,
/static/f49b1ae572906db71cbbb3c4defa3b6b/c1b63/postman-get-one-product.png 1200w,
/static/f49b1ae572906db71cbbb3c4defa3b6b/062c8/postman-get-one-product.png 1386w"
            sizes="(max-width: 1200px) 100vw, 1200px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/f49b1ae572906db71cbbb3c4defa3b6b/c1b63/postman-get-one-product.png"
            alt="postman-get-one-product.png"
            title="postman-get-one-product.png"
            loading="lazy"
            decoding="async"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span></p>
<h4 id="import-products" style="position:relative;"><a href="#import-products" aria-label="import products permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Import products</h4>
<p>Đây là nhân vật chính của ngày hôm nay, endpoint dùng để xử lý file CSV và thêm vào database.</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">importProducts</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>req<span class="token punctuation">.</span>file<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      message<span class="token punctuation">:</span> <span class="token string">"No file is uploaded"</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> rows <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> path <span class="token operator">=</span> appDir <span class="token operator">+</span> <span class="token string">"static/uploads/"</span> <span class="token operator">+</span> req<span class="token punctuation">.</span>file<span class="token punctuation">.</span>filename<span class="token punctuation">;</span>
  <span class="token keyword">const</span> categories <span class="token operator">=</span> <span class="token keyword">await</span> Category<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    attributes<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"id"</span><span class="token punctuation">,</span> <span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token string">"code"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> categoryMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span>
    categories<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">c</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">[</span>c<span class="token punctuation">.</span>dataValues<span class="token punctuation">.</span>code<span class="token punctuation">,</span> c<span class="token punctuation">.</span>dataValues<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> rowNumber <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> parser <span class="token operator">=</span> csv
      <span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token punctuation">{</span> headers<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"error"</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">await</span> fs<span class="token punctuation">.</span>promises<span class="token punctuation">.</span><span class="token function">unlink</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
        res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span> message<span class="token punctuation">:</span> err<span class="token punctuation">.</span>message <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"data"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> category <span class="token operator">=</span> categoryMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>categoryCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>category<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
            <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Row </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>rowNumber<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, category not found.\nData: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>
              data
            <span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        rows<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span>data<span class="token punctuation">,</span> categoryId<span class="token punctuation">:</span> category<span class="token punctuation">.</span>id <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        rowNumber<span class="token operator">++</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"end"</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token comment">// Remove the uploaded file after parsing</span>
        <span class="token keyword">await</span> fs<span class="token punctuation">.</span>promises<span class="token punctuation">.</span><span class="token function">unlink</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Map the parsed data into the Product model</span>
        <span class="token keyword">const</span> products <span class="token operator">=</span> rows<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>
          <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> name<span class="token punctuation">,</span> price<span class="token punctuation">,</span> description<span class="token punctuation">,</span> categoryId <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
            name<span class="token punctuation">,</span>
            price<span class="token punctuation">,</span>
            description<span class="token punctuation">,</span>
            categoryId<span class="token punctuation">,</span>
            createdAt<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            updatedAt<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Import the products into the database</span>
        <span class="token keyword">await</span> Product<span class="token punctuation">.</span><span class="token function">bulkCreate</span><span class="token punctuation">(</span>products<span class="token punctuation">)</span><span class="token punctuation">;</span>

        res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span> message<span class="token punctuation">:</span> <span class="token string">"Products imported successfully"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    fs<span class="token punctuation">.</span><span class="token function">createReadStream</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>parser<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span> message<span class="token punctuation">:</span> <span class="token string">"Internal server error"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div>
<p>Bạn để ý dòng code <code class="language-text">await fs.promises.unlink(path);</code> , dòng này có nhiệm vụ xóa đi file đã cache trước đó khi process xong hoặc process bị lỗi.</p>
<p>Đây là format của file CSV:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">name,price,categoryCode,description</code></pre></div>
<p>Trong phần trên, mình đã lấy tất cả category code và đưa vào 1 Map, sau đó với mỗi dòng trong CSV thì mình sẽ kiểm tra xem category có tồn tại hay không, nếu có thì gán categoryId cho nó, nếu không, thì trả về với 1 lỗi.</p>
<p>Hãy tránh việc gọi db nhiều lần để lấy dữ liệu, nó sẽ làm app bạn chậm đi đáng kể đấy.</p>
<p>Đây chỉ là cơ chế validation cơ bản, cân nhắc validation nhiều hơn nếu bạn dùng trong thực tế nha.</p>
<h4 id="export-product" style="position:relative;"><a href="#export-product" aria-label="export product permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Export product</h4>
<p>Handler này export product ra CSV với schema y chang lúc mình đã import. Mình cho tối đa export 1 triệu bản ghi, còn mặc định sẽ là 100k bản ghi. Chứ để export quá nhiều chắc chớt luôn hệ thống.</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">exportProducts</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> limit <span class="token operator">=</span> req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>limit <span class="token operator">||</span> <span class="token number">100000</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>limit <span class="token operator">||</span> limit <span class="token operator">></span> <span class="token number">1000000</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    limit <span class="token operator">=</span> <span class="token number">1000000</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> products <span class="token operator">=</span> <span class="token keyword">await</span> Product<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    limit<span class="token punctuation">:</span> limit<span class="token punctuation">,</span>
    attributes<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token string">"price"</span><span class="token punctuation">,</span> <span class="token string">"description"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    include<span class="token punctuation">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        model<span class="token punctuation">:</span> Category<span class="token punctuation">,</span>
        attributes<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"code"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    subQuery<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    raw<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> dir <span class="token operator">=</span> appDir <span class="token operator">+</span> <span class="token string">"static/exports"</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fs<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span>dir<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fs<span class="token punctuation">.</span><span class="token function">mkdirSync</span><span class="token punctuation">(</span>dir<span class="token punctuation">,</span> <span class="token punctuation">{</span> recursive<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> fileName <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>dir<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>process<span class="token punctuation">.</span>hrtime<span class="token punctuation">.</span><span class="token function">bigint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">-products.csv</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> csvWriter <span class="token operator">=</span> <span class="token function">createObjectCsvWriter</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    path<span class="token punctuation">:</span> fileName<span class="token punctuation">,</span>
    header<span class="token punctuation">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token string">"name"</span><span class="token punctuation">,</span> title<span class="token punctuation">:</span> <span class="token string">"name"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token string">"price"</span><span class="token punctuation">,</span> title<span class="token punctuation">:</span> <span class="token string">"price"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token string">"category.code"</span><span class="token punctuation">,</span> title<span class="token punctuation">:</span> <span class="token string">"categoryCode"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token string">"description"</span><span class="token punctuation">,</span> title<span class="token punctuation">:</span> <span class="token string">"description"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> csvWriter
    <span class="token punctuation">.</span><span class="token function">writeRecords</span><span class="token punctuation">(</span>products<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"CSV file exported successfully"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>fileName<span class="token punctuation">,</span> <span class="token string">"UTF-8"</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
          res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">"Content-Type"</span><span class="token punctuation">,</span> <span class="token string">"text/csv"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span>
          <span class="token string">"Content-Disposition"</span><span class="token punctuation">,</span>
          <span class="token string">"attachment; filename=products.csv"</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
      res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">finally</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">unlink</span><span class="token punctuation">(</span>fileName<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"DELETED THE TEMP FILE"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div>
<p>Mình có tối ưu lại một chút query để hiệu năng tốt hơn:</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> products <span class="token operator">=</span> <span class="token keyword">await</span> Product<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  limit<span class="token punctuation">:</span> limit<span class="token punctuation">,</span>
  attributes<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token string">"price"</span><span class="token punctuation">,</span> <span class="token string">"description"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  include<span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      model<span class="token punctuation">:</span> Category<span class="token punctuation">,</span>
      attributes<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"code"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  subQuery<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  raw<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>Với query sequelize như trên, thì ta có kết quả là một array với những product như sau:</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    name<span class="token punctuation">:</span> <span class="token string">"Handcrafted Fresh Salad"</span><span class="token punctuation">,</span>
    price<span class="token punctuation">:</span> <span class="token string">"602.00"</span><span class="token punctuation">,</span>
    description<span class="token punctuation">:</span> <span class="token string">"Boston's most advanced compression wea...."</span><span class="token punctuation">,</span>
    <span class="token string">"category.code"</span><span class="token punctuation">:</span> <span class="token string">"BKS"</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span></code></pre></div>
<p>Điểm đặc biệt là <code class="language-text">&#39;category.code&#39;</code> , mà trong Javascript thì key của 1 object có thể là string, do đó nó hợp lệ.</p>
<p>Có 2 option mình truyền vào là <strong>subQuery</strong> cũng như <strong>raw</strong>. Cái trước sẽ tắt chức năng subquery, cái sau sẽ không transform dữ liệu mà chỉ lấy những prop như mình select, 2 tùy chọn này đều góp phần tăng hiệu năng của API.</p>
<p>Raw query sequelize compile ra như sau:</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token punctuation">[</span><span class="token number">14</span> ms<span class="token punctuation">]</span> <span class="token function">Executed</span> <span class="token punctuation">(</span><span class="token keyword">default</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token constant">SELECT</span> <span class="token string">"products"</span><span class="token punctuation">.</span><span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token string">"products"</span><span class="token punctuation">.</span><span class="token string">"price"</span><span class="token punctuation">,</span> <span class="token string">"products"</span><span class="token punctuation">.</span><span class="token string">"description"</span><span class="token punctuation">,</span> <span class="token string">"category"</span><span class="token punctuation">.</span><span class="token string">"code"</span> <span class="token constant">AS</span> <span class="token string">"category.code"</span>
	<span class="token constant">FROM</span> <span class="token string">"products"</span> <span class="token constant">AS</span> <span class="token string">"products"</span>
	<span class="token constant">LEFT</span> <span class="token constant">OUTER</span> <span class="token constant">JOIN</span> <span class="token string">"categories"</span> <span class="token constant">AS</span> <span class="token string">"category"</span>
		<span class="token constant">ON</span> <span class="token string">"products"</span><span class="token punctuation">.</span><span class="token string">"categoryId"</span> <span class="token operator">=</span> <span class="token string">"category"</span><span class="token punctuation">.</span><span class="token string">"id"</span>
	<span class="token constant">LIMIT</span> <span class="token string">'1000'</span><span class="token punctuation">;</span></code></pre></div>
<h3 id="middleware-logger" style="position:relative;"><a href="#middleware-logger" aria-label="middleware logger permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Middleware logger</h3>
<p>Ở đây mình có dùng thêm 1 em logger <code class="language-text">middlewares/logger.js</code>, mục đích để xem console có request nào với status code nào, lúc benchmark nhìn vào console sẽ trực quan hơn, fancy hơn:</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">import</span> colors <span class="token keyword">from</span> <span class="token string">"colors"</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">logger</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'finish'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> color<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>statusCode <span class="token operator">>=</span> <span class="token number">500</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            color <span class="token operator">=</span> colors<span class="token punctuation">.</span>red<span class="token punctuation">.</span>bold<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>statusCode <span class="token operator">>=</span> <span class="token number">300</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            color <span class="token operator">=</span> colors<span class="token punctuation">.</span>yellow<span class="token punctuation">.</span>bold<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            color <span class="token operator">=</span> colors<span class="token punctuation">.</span>green<span class="token punctuation">.</span>bold<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">color</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>method<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>originalUrl<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>res<span class="token punctuation">.</span>statusCode<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toISOString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> logger<span class="token punctuation">;</span></code></pre></div>
<h3 id="ui-cho-trang-chủ" style="position:relative;"><a href="#ui-cho-trang-ch%E1%BB%A7" aria-label="ui cho trang chủ permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>UI cho trang chủ</h3>
<p>Để dễ test hơn thì mình có tạo 1 trang UI ở index để có form upload file cũng như show ra danh sách product (có phân trang), đây là <code class="language-text">handlers/index.js</code>.</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">index</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> perPage <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> page <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>page<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> offset <span class="token operator">=</span> <span class="token punctuation">(</span>page <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> perPage<span class="token punctuation">;</span>

    <span class="token keyword">const</span> products <span class="token operator">=</span> <span class="token keyword">await</span> Product<span class="token punctuation">.</span><span class="token function">findAndCountAll</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      limit<span class="token punctuation">:</span> perPage<span class="token punctuation">,</span>
      offset<span class="token punctuation">:</span> offset<span class="token punctuation">,</span>
      order<span class="token punctuation">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">[</span><span class="token string">"updatedAt"</span><span class="token punctuation">,</span> <span class="token string">"DESC"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span><span class="token string">"createdAt"</span><span class="token punctuation">,</span> <span class="token string">"DESC"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> pageCount <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span>products<span class="token punctuation">.</span>count <span class="token operator">/</span> perPage<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> pages <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> pageCount<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      pages<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">"index"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      products<span class="token punctuation">:</span> products<span class="token punctuation">.</span>rows<span class="token punctuation">,</span>
      pages<span class="token punctuation">:</span> pages<span class="token punctuation">,</span>
      totalPages<span class="token punctuation">:</span> pages<span class="token punctuation">.</span>length<span class="token punctuation">,</span>
      currentPage<span class="token punctuation">:</span> page<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">"index"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div>
<p>Mình cũng có thêm 1 view template của ejs, nhưng mà nó dài lắm, mình chỉ show cái form để upload, với cái table thôi nha:</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"form-group"</span><span class="token operator">></span>
    <span class="token operator">&lt;</span>label <span class="token keyword">for</span><span class="token operator">=</span><span class="token string">"file"</span><span class="token operator">></span>Select <span class="token constant">CSV</span> file to <span class="token keyword">import</span><span class="token operator">&lt;</span><span class="token operator">/</span>label<span class="token operator">></span>
    <span class="token operator">&lt;</span>input type<span class="token operator">=</span><span class="token string">"file"</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"form-control-file"</span> id<span class="token operator">=</span><span class="token string">"file"</span> name<span class="token operator">=</span><span class="token string">"file"</span><span class="token operator">></span>
<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
<span class="token operator">&lt;</span>button type<span class="token operator">=</span><span class="token string">"button"</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"btn btn-primary"</span> id<span class="token operator">=</span><span class="token string">"import-btn"</span><span class="token operator">></span>Import<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">></span>
<span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"table-responsive"</span><span class="token operator">></span>
    <span class="token operator">&lt;</span>table <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"table table-striped table-hover"</span><span class="token operator">></span>
        <span class="token operator">&lt;</span>thead<span class="token operator">></span>
        <span class="token operator">&lt;</span>tr<span class="token operator">></span>
            <span class="token operator">&lt;</span>th<span class="token operator">></span>Name<span class="token operator">&lt;</span><span class="token operator">/</span>th<span class="token operator">></span>
            <span class="token operator">&lt;</span>th<span class="token operator">></span>Price<span class="token operator">&lt;</span><span class="token operator">/</span>th<span class="token operator">></span>
            <span class="token operator">&lt;</span>th<span class="token operator">></span>Description<span class="token operator">&lt;</span><span class="token operator">/</span>th<span class="token operator">></span>
            <span class="token operator">&lt;</span>th<span class="token operator">></span>Created At<span class="token operator">&lt;</span><span class="token operator">/</span>th<span class="token operator">></span>
            <span class="token operator">&lt;</span>th<span class="token operator">></span>Updated At<span class="token operator">&lt;</span><span class="token operator">/</span>th<span class="token operator">></span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>tr<span class="token operator">></span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>thead<span class="token operator">></span>
        <span class="token operator">&lt;</span>tbody<span class="token operator">></span>
        <span class="token operator">&lt;</span><span class="token operator">%</span> products<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">product</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span> <span class="token operator">%</span><span class="token operator">></span>
            <span class="token operator">&lt;</span>tr<span class="token operator">></span>
                <span class="token operator">&lt;</span>td<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">%=</span> product<span class="token punctuation">.</span>name <span class="token operator">%</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>td<span class="token operator">></span>
                <span class="token operator">&lt;</span>td<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">%=</span> product<span class="token punctuation">.</span>price <span class="token operator">%</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>td<span class="token operator">></span>
                <span class="token operator">&lt;</span>td<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">%=</span> product<span class="token punctuation">.</span>description <span class="token operator">%</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>td<span class="token operator">></span>
                <span class="token operator">&lt;</span>td<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">%=</span> product<span class="token punctuation">.</span>createdAt<span class="token punctuation">.</span><span class="token function">toDateString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>td<span class="token operator">></span>
                <span class="token operator">&lt;</span>td<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">%=</span> product<span class="token punctuation">.</span>updatedAt<span class="token punctuation">.</span><span class="token function">toDateString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>td<span class="token operator">></span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>tr<span class="token operator">></span>
        <span class="token operator">&lt;</span><span class="token operator">%</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">%</span><span class="token operator">></span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>tbody<span class="token operator">></span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>table<span class="token operator">></span>
<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
<span class="token operator">&lt;</span>script<span class="token operator">></span>
    <span class="token keyword">const</span> importBtn <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'import-btn'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    importBtn<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> fileInput <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'file'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> file <span class="token operator">=</span> fileInput<span class="token punctuation">.</span>files<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> formData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FormData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        formData<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'file'</span><span class="token punctuation">,</span> file<span class="token punctuation">)</span><span class="token punctuation">;</span>

        axios<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/api/products/import'</span><span class="token punctuation">,</span> formData<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">response</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">"success"</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">error</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
                console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// handle error response here</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span></code></pre></div>
<h3 id="cai-dặt-express-server" style="position:relative;"><a href="#cai-d%E1%BA%B7t-express-server" aria-label="cai dặt express server permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Cài đặt express server</h3>
<p>Ở file <code class="language-text">index.js</code>, chúng ta cần khai báo và khởi chạy expressjs server:</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">import</span> express <span class="token keyword">from</span> <span class="token string">"express"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>
  exportProducts<span class="token punctuation">,</span>
  findManyProducts<span class="token punctuation">,</span>
  findOneProduct<span class="token punctuation">,</span>
  importProducts<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./handlers/product.js"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> index <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./handlers/index.js"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> uploadMiddleware <span class="token keyword">from</span> <span class="token string">"./middlewares/fileUpload.js"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> logger <span class="token keyword">from</span> <span class="token string">"./middlewares/logger.js"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> appDir <span class="token keyword">from</span> <span class="token string">"./utils/pathHelper.js"</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token constant">PORT</span> <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PORT</span> <span class="token operator">||</span> <span class="token number">8080</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"view engine"</span><span class="token punctuation">,</span> <span class="token string">"ejs"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"views"</span><span class="token punctuation">,</span> appDir <span class="token operator">+</span> <span class="token string">"src/views"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// parse requests of content-type - application/json</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// parse requests of content-type - application/x-www-form-urlencoded</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">urlencoded</span><span class="token punctuation">(</span><span class="token punctuation">{</span> extended<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>logger<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// routing</span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"/api/products"</span><span class="token punctuation">,</span> findManyProducts<span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>
  <span class="token string">"/api/products/import"</span><span class="token punctuation">,</span>
  uploadMiddleware<span class="token punctuation">.</span><span class="token function">single</span><span class="token punctuation">(</span><span class="token string">"file"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  importProducts
<span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"/api/products/export"</span><span class="token punctuation">,</span> exportProducts<span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"/api/products/:id"</span><span class="token punctuation">,</span> findOneProduct<span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token constant">PORT</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"App is listening on port "</span> <span class="token operator">+</span> <span class="token constant">PORT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Error occurred, server can't start"</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<h3 id="chạy-app-len" style="position:relative;"><a href="#ch%E1%BA%A1y-app-len" aria-label="chạy app len permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Chạy app lên</h3>
<p>Để chạy được app ta có thể gõ <code class="language-text">node src/index.js</code>, nhưng không, thường thì ta thêm sẵn script, rồi lúc cần chạy <code class="language-text">yarn dev</code> hoặc <code class="language-text">npm run dev</code> là được:</p>
<p>Ở đây mình dùng nodemon để có thể theo dõi được code change và reload app luôn.</p>
<div class="gatsby-highlight" data-language="json"><pre class="language-json"><code class="language-json"><span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"dev"</span><span class="token operator">:</span> <span class="token string">"nodemon src/index.js --watch -max-old-space-size=2048"</span><span class="token punctuation">,</span>
    <span class="token property">"start"</span><span class="token operator">:</span> <span class="token string">"node src/index.js -max-old-space-size=2048"</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span></code></pre></div>
<p>Lúc mình test benchmark thì app báo tràn memory, nên mình set lên 2GB ram, tình trạng đó không còn nữa. Phải thôi, những file mình import cả 100k - 1m rows, import hàng ngàn request thì RAM nào chịu nổi :D.</p>
<p>Với production thì nên set biến này tùy theo monitoring và yêu cầu nha.</p>
<p>Chạy app lên và see:</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1019px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/7b179cda0049a3245d2ea6dadc43b205/159fb/run-yarn-start.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 35.66666666666667%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAIAAACHqfpvAAAACXBIWXMAAA9hAAAPYQGoP6dpAAAA5ElEQVQY033OSWrDQBCFYZ0lMe6We1BVVw/Vrcmy5CHZBJID5Aa5/zLYgoANDnzL98OrXrYmje/58JHmrzh9Uneh7uLyKfEceU43kZfES8hHuoE4raqNMLGdXDn48Q3LokOvw2Bp8K54VxAYbIImYZNswwpYA0vtV9WrMBRbcNkiAxX0PVJnMBtqrSvShK32K6FIKvorr/FGANGEPLtywrwAz1gWRYNynfZDbVOtqdZ+JXW4i+XOtP0Z/NCEEeIewtjEEeKIaW99L83d+kGFxx+FLHZOrq8ePC+vse6/hfL/j57Fv51tUm8o9DBPAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/7b179cda0049a3245d2ea6dadc43b205/c85cb/run-yarn-start.webp 300w,
/static/7b179cda0049a3245d2ea6dadc43b205/e88ff/run-yarn-start.webp 600w,
/static/7b179cda0049a3245d2ea6dadc43b205/6b83e/run-yarn-start.webp 1019w"
              sizes="(max-width: 1019px) 100vw, 1019px"
              type="image/webp"
            />
          <source
            srcset="/static/7b179cda0049a3245d2ea6dadc43b205/5a46d/run-yarn-start.png 300w,
/static/7b179cda0049a3245d2ea6dadc43b205/0a47e/run-yarn-start.png 600w,
/static/7b179cda0049a3245d2ea6dadc43b205/159fb/run-yarn-start.png 1019w"
            sizes="(max-width: 1019px) 100vw, 1019px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/7b179cda0049a3245d2ea6dadc43b205/159fb/run-yarn-start.png"
            alt="run-yarn-start.png"
            title="run-yarn-start.png"
            loading="lazy"
            decoding="async"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span></p>
<p>Còn đây là giao diện, mình code tạm bằng bootstrap:</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1066px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/cbd7c90e44a8e14e6698cfd8c8ce93d6/2e367/ui-product-nodejs-importer-csv-browser.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 87.33333333333334%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAAAsTAAALEwEAmpwYAAADOklEQVQ4y3VS34sbVRTOHyFoUbaLVVHwwWpBEWTHhyLUgk8+9skHEX3x7yjpUxHsk9ts1kXEtPZFtygborupu5V0t5ptk/2VmUky986vZGby487M/eTcSTZZsBc+zuFyzne+79ybe3/h2s33zn+FS4uf4+LCZ7i0+CUuvnwNr5y7gsXnPsL5Z+DV56/itReu4PUXP8Yb5z7Fuy99jQ8WvriZ++3+H9e3q3uobtaG1a1a/HCnHu89asaPa424tlOPa9v1+NFOPd59uH8Gf2/vxw+29uLt6r9xdas2/OvBLn79pXI9NxhGeWRHAJCU7HvAh7eBq2vAJz8AS8vAW98Cb98C3rkFvPkN8MTH9MhJL6IoyOc453kpJZIkEUmSAjKFFyWo7Pso1z3cf+zh9ycDlA9TlA8ShY1momqolnqolziYxfI5x3GUQimlupQyG1rZNbDb7GAc2BDRTA7mhE1rqZcy27ZnhGmaKkKqSlOJ/J/Aj/9krYkEklSeQZqxYSqGIrk9JZzuYXZShTTNkKk/i+k9iTlV6HlefjQaodPpiE63i3angygaTCbjf4nknLp5MaeEQggwboskSeD7PQRhCM/3EUYRnnVIhOO4qoZxLmgF5FYRjscjnLRagnEO23HAGEOrpePw8AiGYcA02zg5aUE3DOi6gWkd1ViWhePjExEnCVzXnVlmjAnf95VC13XRaDRhGKYiM9tt6LoO0zTVACIjdY6KDllV7hQhyaTlcs5FFEWI4xgUwzDMEEUYDAYIwwhBEExiqGp6/b6Kvt9TO5yzPMbh0ZGgydTkeb6azDmfg61A6/A8D9ymPLPe7Vpnd0iWnzYagjEuXdeVXcuSR8fHsnlwoPC00ZCNRnOSN6VlWQqGaaralq7PLBMhfYNOpyvG4zH9BzkajaRptqXZbkvbtiW3bWkxJhnnknNbBmEohRAqDodDGQTBzDJj7AYpdD0vpX3Ql6GHoYcgi9lDZfAmoLzf76PX66no+35Ka7Ms60auXC5fqFQql79bXl5aX1/X7t37Wft+bU27c/eutrJS1AqFglZcXdVWiqsqLxRWtGJxVfupVFL3pVJJu10oLG1ubl7e2Ni48B992Ktw7DJunQAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/cbd7c90e44a8e14e6698cfd8c8ce93d6/c85cb/ui-product-nodejs-importer-csv-browser.webp 300w,
/static/cbd7c90e44a8e14e6698cfd8c8ce93d6/e88ff/ui-product-nodejs-importer-csv-browser.webp 600w,
/static/cbd7c90e44a8e14e6698cfd8c8ce93d6/fbb05/ui-product-nodejs-importer-csv-browser.webp 1066w"
              sizes="(max-width: 1066px) 100vw, 1066px"
              type="image/webp"
            />
          <source
            srcset="/static/cbd7c90e44a8e14e6698cfd8c8ce93d6/5a46d/ui-product-nodejs-importer-csv-browser.png 300w,
/static/cbd7c90e44a8e14e6698cfd8c8ce93d6/0a47e/ui-product-nodejs-importer-csv-browser.png 600w,
/static/cbd7c90e44a8e14e6698cfd8c8ce93d6/2e367/ui-product-nodejs-importer-csv-browser.png 1066w"
            sizes="(max-width: 1066px) 100vw, 1066px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/cbd7c90e44a8e14e6698cfd8c8ce93d6/2e367/ui-product-nodejs-importer-csv-browser.png"
            alt="ui-product-nodejs-importer-csv-browser.png"
            title="ui-product-nodejs-importer-csv-browser.png"
            loading="lazy"
            decoding="async"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span></p>
<p>Mình có thử import vài file trước đó rồi cho nên ở file này có show ra vài sản phẩm.</p>
<p>Lúc test nếu không in ra console thì chẳng biết nó process thế nào, endpoint nào, thành công hay thất b, do đó cái logger phía trên đã giúp chúng ta có 1 cái console fancy như sau:</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1200px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/383c4358cf7add84030c2abd5e19a198/e84a7/app-running-log.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 53.333333333333336%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAA9hAAAPYQGoP6dpAAABsElEQVQozy2QSY6kMBBFOUyVVGBHOIzniSGBJBm6Vn2Dvv8dWpApPYVefG/8o2rApv7UadV594+/pvttwyzdRG6SfiF/+VvuZJZ+kmF5e/UDnsKO+cC4ifIH4gvTjukA/xT5xPTCuFE5RT4wrKL/xbSJcoq0i7RXNVqdRvJFuEKuR9MJ2wvTNxTe1CI0IjQU68/0DcX3U/XDTBtemA+IL5F3CCumDdMObr5mWDGs17/SBn4R5YS4Yt4xbhhf1Q/5Nj6kK9IW6QZpOmkHsgOXCWTkF/kjbYK23Hm6JsWKMdXZYbS5mDyYklXu9UWQodc5qZja2OvcqRTbMOic29ipVC5ihai0cqSckFbKIMjTDYDhXHOuEW8BDWAQPsK5ZlxXcvyn4pP6g7qDulOkF5WT0s79cnd+gn++y19JPu6jHFfztFVMjzJOFEbhRwozmoH8LNzM28L0wFTHdf/BDNyMrC33OjDVVwy0iouIs4gLxSe6ScQV3cT1AH7mduR6QDdz++C6R79cuZvBPsBOVQ2GydAIz8jXaBl5kA7a8N20b75q+c3UZ2Xqq5HfjayFa4T7D2VajKWb/2fyAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/383c4358cf7add84030c2abd5e19a198/c85cb/app-running-log.webp 300w,
/static/383c4358cf7add84030c2abd5e19a198/e88ff/app-running-log.webp 600w,
/static/383c4358cf7add84030c2abd5e19a198/92f8c/app-running-log.webp 1200w,
/static/383c4358cf7add84030c2abd5e19a198/25b5c/app-running-log.webp 1317w"
              sizes="(max-width: 1200px) 100vw, 1200px"
              type="image/webp"
            />
          <source
            srcset="/static/383c4358cf7add84030c2abd5e19a198/5a46d/app-running-log.png 300w,
/static/383c4358cf7add84030c2abd5e19a198/0a47e/app-running-log.png 600w,
/static/383c4358cf7add84030c2abd5e19a198/c1b63/app-running-log.png 1200w,
/static/383c4358cf7add84030c2abd5e19a198/e84a7/app-running-log.png 1317w"
            sizes="(max-width: 1200px) 100vw, 1200px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/383c4358cf7add84030c2abd5e19a198/c1b63/app-running-log.png"
            alt="logger on console"
            title="logger on console"
            loading="lazy"
            decoding="async"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span></p>
<h2 id="benchmark" style="position:relative;"><a href="#benchmark" aria-label="benchmark permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Benchmark</h2>
<p>Ở bước trên chúng ta đã cài thư viện <code class="language-text">autocannon</code>, sau khi thử qua nhiều thư viện thì mình dừng lại với em này bởi vì nó hỗ trợ upload file. Còn artillery thì chỉ có bản pro mới support tính năng đó.</p>
<h3 id="tạo-file-csv-mẫu" style="position:relative;"><a href="#t%E1%BA%A1o-file-csv-m%E1%BA%ABu" aria-label="tạo file csv mẫu permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Tạo file CSV mẫu</h3>
<p>Để việc tạo CSV dễ dàng hơn, mình sử dụng fakerjs mà mình đã cài đặt trước đó.</p>
<p>Tạo file <code class="language-text">csv-generator.js</code>:</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> faker <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@faker-js/faker"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> createObjectCsvWriter <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"csv-writer"</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> categories <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    id<span class="token punctuation">:</span> <span class="token string">"b2ff1377-c40c-4c10-b3a4-4d12c2f90bca"</span><span class="token punctuation">,</span>
    name<span class="token punctuation">:</span> <span class="token string">"Electronics"</span><span class="token punctuation">,</span>
    description<span class="token punctuation">:</span> <span class="token string">"Category for electronic devices"</span><span class="token punctuation">,</span>
    code<span class="token punctuation">:</span> <span class="token string">"ELC"</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    id<span class="token punctuation">:</span> <span class="token string">"8c054e34-e65d-4b6e-b7f1-9d9b556e10d1"</span><span class="token punctuation">,</span>
    name<span class="token punctuation">:</span> <span class="token string">"Clothing"</span><span class="token punctuation">,</span>
    description<span class="token punctuation">:</span> <span class="token string">"Category for clothing items"</span><span class="token punctuation">,</span>
    code<span class="token punctuation">:</span> <span class="token string">"CLT"</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    id<span class="token punctuation">:</span> <span class="token string">"a18b11cc-9a2e-4a04-b831-dde4667e8e0a"</span><span class="token punctuation">,</span>
    name<span class="token punctuation">:</span> <span class="token string">"Books"</span><span class="token punctuation">,</span>
    description<span class="token punctuation">:</span> <span class="token string">"Category for books and literature"</span><span class="token punctuation">,</span>
    code<span class="token punctuation">:</span> <span class="token string">"BKS"</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    id<span class="token punctuation">:</span> <span class="token string">"773e7aa3-f06d-42af-a8c3-3cb50d966f26"</span><span class="token punctuation">,</span>
    name<span class="token punctuation">:</span> <span class="token string">"Home &amp; Kitchen"</span><span class="token punctuation">,</span>
    description<span class="token punctuation">:</span> <span class="token string">"Category for home and kitchen products"</span><span class="token punctuation">,</span>
    code<span class="token punctuation">:</span> <span class="token string">"HKP"</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    id<span class="token punctuation">:</span> <span class="token string">"b8f3c3eb-30f6-41dd-a7b8-518ff2db616f"</span><span class="token punctuation">,</span>
    name<span class="token punctuation">:</span> <span class="token string">"Health &amp; Beauty"</span><span class="token punctuation">,</span>
    description<span class="token punctuation">:</span> <span class="token string">"Category for health and beauty products"</span><span class="token punctuation">,</span>
    code<span class="token punctuation">:</span> <span class="token string">"HBP"</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    id<span class="token punctuation">:</span> <span class="token string">"5c6f5df6-5c5f-4a69-a38c-95d330c156e2"</span><span class="token punctuation">,</span>
    name<span class="token punctuation">:</span> <span class="token string">"Toys &amp; Games"</span><span class="token punctuation">,</span>
    description<span class="token punctuation">:</span> <span class="token string">"Category for toys and games"</span><span class="token punctuation">,</span>
    code<span class="token punctuation">:</span> <span class="token string">"TNG"</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    id<span class="token punctuation">:</span> <span class="token string">"54b31c80-38f6-4e6a-9f70-049a8e0905c9"</span><span class="token punctuation">,</span>
    name<span class="token punctuation">:</span> <span class="token string">"Sports &amp; Outdoors"</span><span class="token punctuation">,</span>
    description<span class="token punctuation">:</span> <span class="token string">"Category for sports and outdoor products"</span><span class="token punctuation">,</span>
    code<span class="token punctuation">:</span> <span class="token string">"SPO"</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    id<span class="token punctuation">:</span> <span class="token string">"66d74c4b-4b4d-4a54-935d-6b0b6faa07f4"</span><span class="token punctuation">,</span>
    name<span class="token punctuation">:</span> <span class="token string">"Automotive"</span><span class="token punctuation">,</span>
    description<span class="token punctuation">:</span> <span class="token string">"Category for automotive products"</span><span class="token punctuation">,</span>
    code<span class="token punctuation">:</span> <span class="token string">"AUT"</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    id<span class="token punctuation">:</span> <span class="token string">"23212a97-74af-460e-bd3d-7b1320dd1c25"</span><span class="token punctuation">,</span>
    name<span class="token punctuation">:</span> <span class="token string">"Office Products"</span><span class="token punctuation">,</span>
    description<span class="token punctuation">:</span> <span class="token string">"Category for office supplies and stationery"</span><span class="token punctuation">,</span>
    code<span class="token punctuation">:</span> <span class="token string">"OFS"</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    id<span class="token punctuation">:</span> <span class="token string">"141d2f17-91d8-4f9d-9143-3b8213c6f5a5"</span><span class="token punctuation">,</span>
    name<span class="token punctuation">:</span> <span class="token string">"Pet Supplies"</span><span class="token punctuation">,</span>
    description<span class="token punctuation">:</span> <span class="token string">"Category for pet supplies and accessories"</span><span class="token punctuation">,</span>
    code<span class="token punctuation">:</span> <span class="token string">"PET"</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> categoryCodes <span class="token operator">=</span> categories<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">c</span><span class="token punctuation">)</span> <span class="token operator">=></span> c<span class="token punctuation">.</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">generateProductsCsv</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">rows</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> csvWriter <span class="token operator">=</span> <span class="token function">createObjectCsvWriter</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    path<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">./bench/sample-csv/products-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>rows<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">-rows.csv</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    header<span class="token punctuation">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token string">"name"</span><span class="token punctuation">,</span> title<span class="token punctuation">:</span> <span class="token string">"name"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token string">"price"</span><span class="token punctuation">,</span> title<span class="token punctuation">:</span> <span class="token string">"price"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token string">"categoryCode"</span><span class="token punctuation">,</span> title<span class="token punctuation">:</span> <span class="token string">"categoryCode"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token string">"description"</span><span class="token punctuation">,</span> title<span class="token punctuation">:</span> <span class="token string">"description"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> rows<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    data<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      name<span class="token punctuation">:</span> faker<span class="token punctuation">.</span>commerce<span class="token punctuation">.</span><span class="token function">productName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      price<span class="token punctuation">:</span> faker<span class="token punctuation">.</span>commerce<span class="token punctuation">.</span><span class="token function">price</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      categoryCode<span class="token punctuation">:</span> faker<span class="token punctuation">.</span>helpers<span class="token punctuation">.</span><span class="token function">arrayElement</span><span class="token punctuation">(</span>categoryCodes<span class="token punctuation">)</span><span class="token punctuation">,</span>
      description<span class="token punctuation">:</span> faker<span class="token punctuation">.</span>commerce<span class="token punctuation">.</span><span class="token function">productDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  csvWriter
    <span class="token punctuation">.</span><span class="token function">writeRecords</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">CSV file generated successfully with </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>rows<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> rows</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> rows <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">,</span> <span class="token number">100000</span><span class="token punctuation">,</span> <span class="token number">1000000</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"GENERATING CSV..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
rows<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">generateProductsCsv</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>File trên lúc chạy <code class="language-text">node csv-generator.js</code> thì sẽ có 6 file chứa từ 10, 100, 1000, 100k đến 1 triệu record nằm trong folder <code class="language-text">bench/sample-csv</code>.</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1200px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/e5673a41123c5f34bb792ee5510f914b/9cea8/terminal-run-generate-csv-sample.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 56.666666666666664%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAA9hAAAPYQGoP6dpAAABqElEQVQoz33Q2W4bMQwF0PmWwuNZtFESKWobz8hLEi9I/v9vCsdAWvShwMF9uwTJTseHzZ+uftnyafPD5ocMNxluiq8zXUy6unKz+W7zHfJd8m3ED8F3GR+D++gAE+WzDavBamhRrmhXLBVLq/HrOPt+UP30tBvkbi/7UfaD3A2iH2U3CGAupW7WBe/ZGKcVWMxIjcOF/InwiGF1tBjMysVZ86T5ld08q8XszqxXUgc/L3Y4mF9kweJCsfl0cvEItNnQPDcfm3ZVQJKQBaRuGEXRuyObxrAxPEfA3mu1l6QMO8o2FQhZYzKUIWQBYRQ4yqeuH0R0+lhT9OC1RCO9HEFb5arSAW0CTAajtKxc1D4KEyZFL10/maVdS7vH9YapYdyIDxwb5wuG5mlz3zsb2r6tBv/odpOx5WzXm65XVc6qvAVcsy/JlYq1+JqoAi3GV+OrhDSp8ONZxrhh3CxVSwtgBazGl1H6UeLwSuFfR/6j6ydAXjE2jC2kI/JK+UjlPGvuhR8k7sX/ysaXEx3ecbnw+o71LZXzYXkLtIAOVjMAa5d/Pvx3+TdSnIXSWgDOjAAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/e5673a41123c5f34bb792ee5510f914b/c85cb/terminal-run-generate-csv-sample.webp 300w,
/static/e5673a41123c5f34bb792ee5510f914b/e88ff/terminal-run-generate-csv-sample.webp 600w,
/static/e5673a41123c5f34bb792ee5510f914b/92f8c/terminal-run-generate-csv-sample.webp 1200w,
/static/e5673a41123c5f34bb792ee5510f914b/893d6/terminal-run-generate-csv-sample.webp 1278w"
              sizes="(max-width: 1200px) 100vw, 1200px"
              type="image/webp"
            />
          <source
            srcset="/static/e5673a41123c5f34bb792ee5510f914b/5a46d/terminal-run-generate-csv-sample.png 300w,
/static/e5673a41123c5f34bb792ee5510f914b/0a47e/terminal-run-generate-csv-sample.png 600w,
/static/e5673a41123c5f34bb792ee5510f914b/c1b63/terminal-run-generate-csv-sample.png 1200w,
/static/e5673a41123c5f34bb792ee5510f914b/9cea8/terminal-run-generate-csv-sample.png 1278w"
            sizes="(max-width: 1200px) 100vw, 1200px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/e5673a41123c5f34bb792ee5510f914b/c1b63/terminal-run-generate-csv-sample.png"
            alt="terminal-run-generate-csv-sample.png"
            title="terminal-run-generate-csv-sample.png"
            loading="lazy"
            decoding="async"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span></p>
<h3 id="tiến-hanh-benchmark" style="position:relative;"><a href="#ti%E1%BA%BFn-hanh-benchmark" aria-label="tiến hanh benchmark permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Tiến hành benchmark</h3>
<h4 id="test-tren-trinh-duyệt" style="position:relative;"><a href="#test-tren-trinh-duy%E1%BB%87t" aria-label="test tren trinh duyệt permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Test trên trình duyệt</h4>
<p>Mình tiến hành delete hết bản ghi trong database và bắt đầu import lại, vì có hàng triệu dòng trong database làm ảnh hưởng hiệu năng lúc test.</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1200px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/3bb7535e71c25791843348d539c12f94/636d3/test-import-on-browser.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 54.666666666666664%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAA9hAAAPYQGoP6dpAAABqUlEQVQoz3VRy24UQQyc/4UcQGIllNsec+PKr0BCEinfgEDsZrLRZHdm+jHtdrfb/Ro0u4lAglglq2S7VLbc1FrnlzhRA/PVbb25W3B5U79eP+PLt3p1Wz39mWz+Fpey5HZXP67L+qKuL/L783q2ms9W5e2qvPlQ3p3nUdT/i1+qVanucHjQeqBgcsZ5TqfmESefhTT/KBf/T5/D9R3Pc825lFzmV6Kx1gKAMcZ7j4gOwCj9Y0PdkyMiqQHRnWYAwAJMYEiq9P1XmGwDQuBR3ff9oe+fuq7b7Ya+a+837eN+8zgMQhozaa31pJVSatJGCrjfGSEbJaUUEhHRolZaCDGOC9r2QQyjNUZLpZUGA1oqdeQWrFBK66mJKTrncs4YPJWYYiql5JxrrTaSYjTJq2Ah0ylLAiwsvLElNCFwLiXFGFMiZiJi5hCYObrgPAeKEclRZCRPka13xlpOCRw22+0WwHoi771zbr/fI+IoRu/89udeK2AOiCiP10khxSgMGA4sjW76w4GIcs4pJWa21sYYnfcppW43oQ1LJ+flEc4DgHO+lJLSsutvZLBrSWLR0IUAAAAASUVORK5CYII='); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/3bb7535e71c25791843348d539c12f94/c85cb/test-import-on-browser.webp 300w,
/static/3bb7535e71c25791843348d539c12f94/e88ff/test-import-on-browser.webp 600w,
/static/3bb7535e71c25791843348d539c12f94/92f8c/test-import-on-browser.webp 1200w,
/static/3bb7535e71c25791843348d539c12f94/41bb6/test-import-on-browser.webp 1222w"
              sizes="(max-width: 1200px) 100vw, 1200px"
              type="image/webp"
            />
          <source
            srcset="/static/3bb7535e71c25791843348d539c12f94/5a46d/test-import-on-browser.png 300w,
/static/3bb7535e71c25791843348d539c12f94/0a47e/test-import-on-browser.png 600w,
/static/3bb7535e71c25791843348d539c12f94/c1b63/test-import-on-browser.png 1200w,
/static/3bb7535e71c25791843348d539c12f94/636d3/test-import-on-browser.png 1222w"
            sizes="(max-width: 1200px) 100vw, 1200px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/3bb7535e71c25791843348d539c12f94/c1b63/test-import-on-browser.png"
            alt="test-import-on-browser.png"
            title="test-import-on-browser.png"
            loading="lazy"
            decoding="async"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span></p>
<p>Kết quả theo thứ tự cho import 10k dòng, 100k dòng và 1triệu dòng là: 633ms, 4.74s và 52.63s.</p>
<p>Con số khá tốt, không đến nỗi nào, vì node vốn dĩ không mạnh về các tác vụ blocking IO như việc transform những file lớn như vậy. Phần 2 của API này mình sẽ cố gắng cải thiện nó.</p>
<h4 id="stress-test" style="position:relative;"><a href="#stress-test" aria-label="stress test permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Stress test</h4>
<p>Mỗi test vậy thôi thì hơi buồn, mình chạy stress test với số lượng file nhiều nhưng số dòng ít (1k-10k) xem thử nó đáp ứng ra sao.</p>
<p>Mình gom lại test case thành file benchmark <code class="language-text">v1.bash</code>:</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span>
<span class="token builtin class-name">set</span> -eu

<span class="token comment"># Get the directory of the script file</span>
<span class="token assign-left variable">SCRIPT_DIR</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">dirname</span> <span class="token string">"<span class="token variable"><span class="token variable">$(</span>readlink -f <span class="token string">"<span class="token variable">$0</span>"</span><span class="token variable">)</span></span>"</span><span class="token variable">)</span></span>

<span class="token builtin class-name">echo</span> -e <span class="token string">"<span class="token entity" title="\e">\e</span>[34mTEST 10s with 5 connections and csv file of 1000 rows<span class="token entity" title="\e">\e</span>[0m"</span>

autocannon http://localhost:8080/api/products/import -m POST <span class="token punctuation">\</span>
  -F <span class="token string">'{ "file": { "type": "file", "path": "'</span><span class="token string">"<span class="token variable">$SCRIPT_DIR</span>/sample-csv/products-1000-rows.csv"</span><span class="token string">'" }}'</span> <span class="token punctuation">\</span>
  --duration <span class="token number">10</span> --connections <span class="token number">5</span> <span class="token punctuation">\</span>
  --maxOverallRequests <span class="token number">10000</span>

<span class="token builtin class-name">echo</span> -e <span class="token string">"<span class="token entity" title="\e">\e</span>[34mTEST 10s with 5 connections and csv file of 10000 rows<span class="token entity" title="\e">\e</span>[0m"</span>

autocannon http://localhost:8080/api/products/import -m POST <span class="token punctuation">\</span>
  -F <span class="token string">'{ "file": { "type": "file", "path": "'</span><span class="token string">"<span class="token variable">$SCRIPT_DIR</span>/sample-csv/products-10000-rows.csv"</span><span class="token string">'" }}'</span> <span class="token punctuation">\</span>
  --duration <span class="token number">10</span> --connections <span class="token number">5</span> <span class="token punctuation">\</span>
  --maxOverallRequests <span class="token number">1000</span>

<span class="token builtin class-name">echo</span> -e <span class="token string">"<span class="token entity" title="\e">\e</span>[34mTEST 10s with 5 connections get Products<span class="token entity" title="\e">\e</span>[0m"</span>

autocannon http://localhost:8080/api/products -m GET <span class="token punctuation">\</span>
  --duration <span class="token number">10</span> --connections <span class="token number">5</span> <span class="token punctuation">\</span>
  --maxOverallRequests <span class="token number">100000</span></code></pre></div>
<p>Bạn có thể thấy mình stress test 2 endpoint chính.</p>
<ul>
<li><strong>Import product</strong>: Mình test 2 trường hợp chạy 10 giây, 5 kết nối đồng thời:
<ul>
<li>Trường hợp đầu tiên tối đa 10k request với những file có 1000 records.</li>
<li>Trường hợp thứ hai tối đa 1k request với những file có 10000 records.</li>
</ul>
</li>
<li><strong>Get products</strong>: Endpoint này để stress test việc query liên tục vào database để lấy 200 product mới nhất.</li>
</ul>
<p>Kết quả stress test chi tiết mình có để ở file readme, đây là tóm tắt kết quả sau 10 giây chạy cho mỗi test:</p>
<p>Test case thứ nhất import một tá file 1000 dòng: <strong>262</strong> request</p>
<p>Test case thứ 2, import nhiều file 10k dòng: <strong>35</strong> request</p>
<p>Test case số 3, GET 200 products liên tục: <strong>1k</strong> request.</p>
<h2 id="kết-luận" style="position:relative;"><a href="#k%E1%BA%BFt-lu%E1%BA%ADn" aria-label="kết luận permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Kết luận</h2>
<p>Dạo này mình viết bài nào cũng dài thật, hi vọng bài này có ích với các bạn trong khi tham khảo 1 API để import CSV đơn giản nhanh gọn.</p>
<p>Các con số kết quả stress test làm mình khá ngạc nhiên, vì khi code Go như bài viết connection pooling<sup id="fnref-3"><a href="#fn-3" class="footnote-ref">3</a></sup>, những con số benchmark ấn tượng hơn rất nhiều.</p>
<p>Nhưng cũng phải thôi, vì mình có dùng ORM, lại chưa kể Nodejs không mạnh về mấy cái blocking-IO, cho nên con số này chấp nhận được.</p>
<p>Thế mới có lý do mình viết tiếp phần 2 chứ, đón đọc hen!</p>
<p>Ở trên repo thì các bạn có thể kiểm tra code của bài này trong branch v1 nhé, lỡ đâu branch main mình update version 2 rồi.</p>
<p>Happy coding!</p>

      <div class="footnotes">
        <hr/><strong>References:</strong>
        <ol >
    
    <li class="footnote-list-item" id="fn-1" >
          
        
      <a href="#fnref-1" class="footnote-backref" style="display:inline;text-decoration: none;">
        ↩
      </a>
    <p class="footnote-paragraph" style="display:inline; margin-left: 5px;"><a href="https://reflectoring.io/node-csv-importer/">https://reflectoring.io/node-csv-importer/</a></p>
      </li>
      
    

    <li class="footnote-list-item" id="fn-2" >
          
        
      <a href="#fnref-2" class="footnote-backref" style="display:inline;text-decoration: none;">
        ↩
      </a>
    <p class="footnote-paragraph" style="display:inline; margin-left: 5px;"><a href="https://github.com/kienmatu/nodejs-product-csv">https://github.com/kienmatu/nodejs-product-csv</a></p>
      </li>
      
    

    <li class="footnote-list-item" id="fn-3" >
          
        
      <a href="#fnref-3" class="footnote-backref" style="display:inline;text-decoration: none;">
        ↩
      </a>
    <p class="footnote-paragraph" style="display:inline; margin-left: 5px;"><a href="https://devgiangho.github.io/connection-pooling-tong-quan-va-implement-benchmark/">https://devgiangho.github.io/connection-pooling-tong-quan-va-implement-benchmark/</a></p>
      </li>
      
    

    <li class="footnote-list-item" id="fn-4" >
          
        
      <a href="#fnref-4" class="footnote-backref" style="display:inline;text-decoration: none;">
        ↩
      </a>
    <p class="footnote-paragraph" style="display:inline; margin-left: 5px;"><a href="https://nodejs.org/api/process.html#process_process_hrtime_time">https://nodejs.org/api/process.html#process_process_hrtime_time</a></p>
      </li>
      
    </ol></div></section><footer class="postStyle__PostFooter-sc-1q9n7ky-9 kGeBkw"><p>Published under <span><a class="postStyle__FooterTagLink-sc-1q9n7ky-10 bsOVgh" href="/tag/nodejs/">Nodejs</a>, </span><span><a class="postStyle__FooterTagLink-sc-1q9n7ky-10 bsOVgh" href="/tag/backend/">Backend</a>, </span><span><a class="postStyle__FooterTagLink-sc-1q9n7ky-10 bsOVgh" href="/tag/javascript/">JavaScript</a></span> on<!-- --> <time dateTime="2023-04-12T04:33:56.927Z">12 April, 2023</time>.</p></footer><div class="style__LinkedPostWrapper-sc-cu5n11-0 tpqNJ"><div class="style__PrevPost-sc-cu5n11-2 jKVyMT"><a class="style__LinkedPost-sc-cu5n11-1 llMcQV" href="/golang-slice-tat-tan-tat-va-nhung-dieu-co-the-ban-chua-biet/"><div class="sublabel">Previous</div><div class="label">Slice trong Go: Tất tần tật, và những điều có thể bạn chưa biết</div></a></div></div><div class="comments__PostComment-sc-188g6ow-0 cEXXiX"><div></div></div></article></div></div><section class="postStyle__PostAddition-sc-1q9n7ky-11 hnKtRH"><div class="common__Container-sc-yvdkhc-0 postStyle__PostAdditionContent-sc-1q9n7ky-12 hhzXsP bIQtHU"><div class="postStyle__BioWrapper-sc-1q9n7ky-13 cXvylF"><section class="bio__StyledBio-sc-cy4lz8-0 buiIfq"><div class="avatar__StyledAvatar-sc-1b55w7o-0 iLbeUa gatsby-image-wrapper" style="position:relative;overflow:hidden;display:inline-block;width:110px;height:110px"><img aria-hidden="true" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsTAAALEwEAmpwYAAAFlUlEQVQ4y2WSaVCTVxSGb6gz+kccq1QFlVo7tI7TqTp16lJFVGRRkAARWcWxuIKKYtWyBUWEqSgKHRFks0QWBQoKuGIBQVQIGMISwhISCCQioCxVvu+7b+cL2v7oj3vvzL3nfc57zrkk2VZMrtmEkyQbseDKphDCrwuWp02i1586GvnTLw/CVgdpT608yh5bEcAEfH9Is3/pgbu7Lfz2eS7abSwy30VcFvoIHEw9BY5mnsTB1JOQVPsIkmwrFqTYRZCr1mE80P/SxmB99LqTCFkWgGPf7MURi304uNgPuxf4YJe5L3Zb+MHr6z1q0UIfb+F8L7JuhjPZNs9DYD/XnZAU+whBxtazRLIt0ihxS/jNhC1hiFkVhHOrg5gbhxLZ8tTH9HF6CS1NKqTFCcVcjPtvjMdCH0Zk5oUdi3yx3cwrXjjfmyydYke2zvMgJM4qmCTZikmKXcTNJDsxYtecmPjj53iuV67G2Og7mn7tIvXfI6J73e1obEQQHdD3U/nTZgRanWQdZrsxwgXesJ/rHse7czD1NCI3tkXyyz9921nErzs1URwmoRzHAQCNOHGYrlhshmUWi2E+xwTGnxEEHvSj/NvYyDjCROeozUxXdqupJ6xN3ETWJm6EZDtFmUi2R+mTNoUi71Aix7GsATY8OARXG0usXWKODUu/hO/ab+G4/Cus+WE53gwMGGJGh0exd3Ugu3mmK7bM2alYY+w8lWQLzx/NdDyH6zbhjFamMgSyEwx/IjMhChHeG5F2RIhkfyekHhHi1wPeGBx+C3DU4PRpUQ02zXBhrL9ww4ZZop0k1yX6QfoWMYqD0nhrlHIcH4iJ8RFUSS7g9vn9yD/rh4wT7rgTE4DbIb4YVCkNCSnlKMuw1G/tcWb9dCGsZu/IJLdcY7QpViGQ3nhiyPixZDAfPqCx4DKeJgTgfvR+FAV74kmMH8pi/DE+qDfEsMxke+KOJXGrpzrAysStngey1zcEQ3FP+hHI8ZtBoGuXIl/shsxAF1z3s0VOkCM0supJdxz3L/DmxXz645StPHCUBzIGYGndf0BK+XIMwuf5l1AY7oE/gz2QH+6F8XdD/wNKYvM+Ad/yQE3qxhDUpj3iPgEnFZOHtCQJBWdFyDnthKzjdmguLzA88SP59L1iD19l10wzlPyS5DpH382wEaPoSDLzEWPo4/vxEcgaXqL61gXkhjoiN9QZt4O3o7rgGirLH4GdGAfHsXRs5G/qu/IwY2nszA8llf82+ySO55BsHc50VMjBcGN0dEiLfnUzqsqK0C6rQGnCMTy4sh+yhxlQyGrwtOwu3o/qKccO0WelVdT6cxG72cQNVrNETiTH6byxxClKnWgZjKrkQnZ0VIOBXgUd7G+n/d1ydDTVoLn2IaSPcyB/8QjdbbXoU7fQQb2KDg+ooNO0Mj4rDsByunNDliTPiKRuDCMZ9me80x0joaqXMnptC9V2ytCnklFdTwvV97RC3VYHZeMzaDpeoaeriT55UEgV8hd43avghvRKTuwTCQtiabOArCLkdX+7QFFRQ/IDfo/XqVrR1VLDttQ9Znkn/d1NVKduphqllL7WttE3ui56/04ubW2soT2dMqZPJef6VE34q6AkdEDbSli214g8Ty0SpAjjSJ7wEhnSq+I0bXWoLcuDUlbJC5i+bjmn7ZJTnaaVDr1WsT1dcv6e7eloQL+6BdrOptDkMwmk8t4dQc7lbEIq4m4RafZ9AQCi62kkGoV0R3VpVpuivhy9na/ACzVKKbSqRmhVct412hur0dXysqG/W2Gr0zSTJeQ7QdalLBIXGE9I65NqoqqTksaSCqLpeGmkUdSRrNiYaU01j9zl1aUSZX15fZf8xbhaUT+ibKisVb6qSmuoLHW6fDzKqK+7hWi7Gox6lArS29FKtJ3N5B8YTTI10y3oBAAAAABJRU5ErkJggg==" alt="Kiên Đinh" style="position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;object-position:center;opacity:1;transition-delay:500ms"/><noscript><picture><source srcset="/static/5e09b7dc046a8972547b7e2d01e32a28/3b7ca/logo.png 1x,
/static/5e09b7dc046a8972547b7e2d01e32a28/085e0/logo.png 1.5x,
/static/5e09b7dc046a8972547b7e2d01e32a28/1efc4/logo.png 2x" /><img loading="lazy" width="110" height="110" srcset="/static/5e09b7dc046a8972547b7e2d01e32a28/3b7ca/logo.png 1x,
/static/5e09b7dc046a8972547b7e2d01e32a28/085e0/logo.png 1.5x,
/static/5e09b7dc046a8972547b7e2d01e32a28/1efc4/logo.png 2x" src="/static/5e09b7dc046a8972547b7e2d01e32a28/3b7ca/logo.png" alt="Kiên Đinh" style="position:absolute;top:0;left:0;opacity:1;width:100%;height:100%;object-fit:cover;object-position:center"/></picture></noscript></div><h3 class="bio__AuthorName-sc-cy4lz8-2 HeSmV">Kiên Đinh</h3><p class="bio__AuthorDescription-sc-cy4lz8-1 iEPaOA">Bần đạo là <strong>Kiên Đinh</strong>, một Developer. 
            Ta viết blog này với mục đích chia sẻ những kinh nghiệm của bản thân đối với <b>coding chi đạo</b>. </p><ul class="social-channel-list__StyledSocialChannels-sc-hb4cd6-0 eWZpEr"><li class="social-channel-list__StyledSocialChannel-sc-hb4cd6-1 dIYGZM"><a href="https://www.facebook.com/kien.matu.7" target="_blank" rel="noopener" aria-label="facebook"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" color="#4267b2" style="color:#4267b2" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M504 256C504 119 393 8 256 8S8 119 8 256c0 123.78 90.69 226.38 209.25 245V327.69h-63V256h63v-54.64c0-62.15 37-96.48 93.67-96.48 27.14 0 55.52 4.84 55.52 4.84v61h-31.28c-30.8 0-40.41 19.12-40.41 38.73V256h68.78l-11 71.69h-57.78V501C413.31 482.38 504 379.78 504 256z"></path></svg></a></li><li class="social-channel-list__StyledSocialChannel-sc-hb4cd6-1 dIYGZM"><a href="https://www.linkedin.com/in/kiendinh-dev/" target="_blank" rel="noopener" aria-label="linkedin"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 448 512" color="#0077b5" style="color:#0077b5" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"></path></svg></a></li><li class="social-channel-list__StyledSocialChannel-sc-hb4cd6-1 dIYGZM"><a href="https://viblo.asia/u/kiendev" target="_blank" rel="noopener" aria-label="viblo"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M136.6 138.79a64.003 64.003 0 0 0-43.31 41.35L0 460l14.69 14.69L164.8 324.58c-2.99-6.26-4.8-13.18-4.8-20.58 0-26.51 21.49-48 48-48s48 21.49 48 48-21.49 48-48 48c-7.4 0-14.32-1.81-20.58-4.8L37.31 497.31 52 512l279.86-93.29a64.003 64.003 0 0 0 41.35-43.31L416 224 288 96l-151.4 42.79zm361.34-64.62l-60.11-60.11c-18.75-18.75-49.16-18.75-67.91 0l-56.55 56.55 128.02 128.02 56.55-56.55c18.75-18.75 18.75-49.15 0-67.91z"></path></svg></a></li><li class="social-channel-list__StyledSocialChannel-sc-hb4cd6-1 dIYGZM"><a href="https://www.youtube.com/channel/UCnq0iZ1X0udszc7ODV9uK4g" target="_blank" rel="noopener" aria-label="youtube"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 576 512" color="#ff0000" style="color:#ff0000" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M549.655 124.083c-6.281-23.65-24.787-42.276-48.284-48.597C458.781 64 288 64 288 64S117.22 64 74.629 75.486c-23.497 6.322-42.003 24.947-48.284 48.597-11.412 42.867-11.412 132.305-11.412 132.305s0 89.438 11.412 132.305c6.281 23.65 24.787 41.5 48.284 47.821C117.22 448 288 448 288 448s170.78 0 213.371-11.486c23.497-6.321 42.003-24.171 48.284-47.821 11.412-42.867 11.412-132.305 11.412-132.305s0-89.438-11.412-132.305zm-317.51 213.508V175.185l142.739 81.205-142.739 81.201z"></path></svg></a></li><li class="social-channel-list__StyledSocialChannel-sc-hb4cd6-1 dIYGZM"><a href="https://github.com/kienmatu" target="_blank" rel="noopener" aria-label="github"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 496 512" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg></a></li></ul></section></div></div></section></main><footer class="style__StyledFooter-sc-1bbyksd-0 hNmZFn"><div class="common__Container-sc-yvdkhc-0 style__FooterContainer-sc-1bbyksd-1 hhzXsP kRFmqs"><nav class="style__StyledNav-sc-1bbyksd-4 hCiwIZ"><ul><li><a class="style__FooterMenuLink-sc-1bbyksd-6 RdnGO" href="/about-me/">About me</a></li></ul></nav><div><p class="style__Copyright-sc-1bbyksd-2 eFaQjI"><strong>Dev Giang Hồ - Blog for Devs</strong> © <!-- -->2023</p><p class="style__DesignBy-sc-1bbyksd-3 hFClol"><a href="https://devgiangho.github.io" title="devgiangho">devgiangho</a><br/>Icons made by <a href="https://www.flaticon.com/authors/dinosoftlabs" title="DinosoftLabs">DinosoftLabs</a> from <a href="https://www.flaticon.com/" title="Flaticon">Flaticon</a></p></div></div></footer></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/dung-api-import-csv-bang-nodejs-va-express/";window.___webpackCompilationHash="b23416e40a6e36433f2d";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-d5ab38783296e1c773b0.js"],"app":["/app-3d56a7e927d0e18cd127.js"],"component---src-pages-404-tsx":["/component---src-pages-404-tsx-dac1e2e8f46e2904c1f4.js"],"component---src-pages-archive-tsx":["/component---src-pages-archive-tsx-d17a542145ac54c73b71.js"],"component---src-pages-tags-tsx":["/component---src-pages-tags-tsx-3316aecd1d08b21d3d21.js"],"component---src-templates-page-tsx":["/component---src-templates-page-tsx-6bc8dea0877c1c99ae09.js"],"component---src-templates-post-tsx":["/component---src-templates-post-tsx-3cdd1abe5df6730423e9.js"],"component---src-templates-posts-tsx":["/component---src-templates-posts-tsx-f9246684225265d50d3d.js"],"component---src-templates-tag-tsx":["/component---src-templates-tag-tsx-7523085417102b9ac221.js"]};/*]]>*/</script><script src="/polyfill-d5ab38783296e1c773b0.js" nomodule=""></script><script src="/app-3d56a7e927d0e18cd127.js" async=""></script><script src="/framework-bd9150bcf9e535dfa7fa.js" async=""></script><script src="/webpack-runtime-2e0adcb081d9c1d7a8b7.js" async=""></script></body></html>