{"componentChunkName":"component---src-templates-post-tsx","path":"/dung-api-import-csv-bang-nodejs-va-express/","result":{"data":{"post":{"headings":[{"id":"tản-mạn","depth":2,"value":"Tản mạn"},{"id":"giới-thiệu-về-project","depth":2,"value":"Giới thiệu về project"},{"id":"tại-sao-lại-la-import-csv","depth":3,"value":"Tại sao lại là import CSV?"},{"id":"ưu-diểm-của-csv","depth":3,"value":"Ưu điểm của CSV"},{"id":"first-thing-first","depth":2,"value":"First thing first"},{"id":"bắt-tay-vao-code","depth":2,"value":"Bắt tay vào code"},{"id":"khởi-tạo-nodejs-project","depth":3,"value":"Khởi tạo Nodejs Project"},{"id":"cấu-truc-thư-mục","depth":4,"value":"Cấu trúc thư mục"},{"id":"dựng-database-postgresql","depth":3,"value":"Dựng database postgresql"},{"id":"dựng-data-model-va-kết-nối-database","depth":3,"value":"Dựng data model và kết nối database"},{"id":"cache-lại-file-da-upload","depth":3,"value":"Cache lại file đã upload"},{"id":"cac-endpoint-rest-api","depth":3,"value":"Các endpoint REST API"},{"id":"get-many-products","depth":4,"value":"Get many products"},{"id":"get-product-by-id","depth":4,"value":"Get product by ID"},{"id":"import-products","depth":4,"value":"Import products"},{"id":"export-product","depth":4,"value":"Export product"},{"id":"middleware-logger","depth":3,"value":"Middleware logger"},{"id":"ui-cho-trang-chủ","depth":3,"value":"UI cho trang chủ"},{"id":"cai-dặt-express-server","depth":3,"value":"Cài đặt express server"},{"id":"chạy-app-len","depth":3,"value":"Chạy app lên"},{"id":"benchmark","depth":2,"value":"Benchmark"},{"id":"tạo-file-csv-mẫu","depth":3,"value":"Tạo file CSV mẫu"},{"id":"tiến-hanh-benchmark","depth":3,"value":"Tiến hành benchmark"},{"id":"test-tren-trinh-duyệt","depth":4,"value":"Test trên trình duyệt"},{"id":"stress-test","depth":4,"value":"Stress test"},{"id":"kết-luận","depth":2,"value":"Kết luận"}],"tableOfContents":"<ul>\n<li>\n<p><a href=\"#t%E1%BA%A3n-m%E1%BA%A1n\">Tản mạn</a></p>\n</li>\n<li>\n<p><a href=\"#gi%E1%BB%9Bi-thi%E1%BB%87u-v%E1%BB%81-project\">Giới thiệu về project</a></p>\n<ul>\n<li><a href=\"#t%E1%BA%A1i-sao-l%E1%BA%A1i-la-import-csv\">Tại sao lại là import CSV?</a></li>\n<li><a href=\"#%C6%B0u-di%E1%BB%83m-c%E1%BB%A7a-csv\">Ưu điểm của CSV</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#first-thing-first\">First thing first</a></p>\n</li>\n<li>\n<p><a href=\"#b%E1%BA%AFt-tay-vao-code\">Bắt tay vào code</a></p>\n<ul>\n<li>\n<p><a href=\"#kh%E1%BB%9Fi-t%E1%BA%A1o-nodejs-project\">Khởi tạo Nodejs Project</a></p>\n<ul>\n<li><a href=\"#c%E1%BA%A5u-truc-th%C6%B0-m%E1%BB%A5c\">Cấu trúc thư mục</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#d%E1%BB%B1ng-database-postgresql\">Dựng database postgresql</a></p>\n</li>\n<li>\n<p><a href=\"#d%E1%BB%B1ng-data-model-va-k%E1%BA%BFt-n%E1%BB%91i-database\">Dựng data model và kết nối database</a></p>\n</li>\n<li>\n<p><a href=\"#cache-l%E1%BA%A1i-file-da-upload\">Cache lại file đã upload</a></p>\n</li>\n<li>\n<p><a href=\"#cac-endpoint-rest-api\">Các endpoint REST API</a></p>\n<ul>\n<li><a href=\"#get-many-products\">Get many products</a></li>\n<li><a href=\"#get-product-by-id\">Get product by ID</a></li>\n<li><a href=\"#import-products\">Import products</a></li>\n<li><a href=\"#export-product\">Export product</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#middleware-logger\">Middleware logger</a></p>\n</li>\n<li>\n<p><a href=\"#ui-cho-trang-ch%E1%BB%A7\">UI cho trang chủ</a></p>\n</li>\n<li>\n<p><a href=\"#cai-d%E1%BA%B7t-express-server\">Cài đặt express server</a></p>\n</li>\n<li>\n<p><a href=\"#ch%E1%BA%A1y-app-len\">Chạy app lên</a></p>\n</li>\n</ul>\n</li>\n<li>\n<p><a href=\"#benchmark\">Benchmark</a></p>\n<ul>\n<li>\n<p><a href=\"#t%E1%BA%A1o-file-csv-m%E1%BA%ABu\">Tạo file CSV mẫu</a></p>\n</li>\n<li>\n<p><a href=\"#ti%E1%BA%BFn-hanh-benchmark\">Tiến hành benchmark</a></p>\n<ul>\n<li><a href=\"#test-tren-trinh-duy%E1%BB%87t\">Test trên trình duyệt</a></li>\n<li><a href=\"#stress-test\">Stress test</a></li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p><a href=\"#k%E1%BA%BFt-lu%E1%BA%ADn\">Kết luận</a></p>\n</li>\n</ul>","frontmatter":{"title":"Dựng API import CSV bằng Nodejs và Express","path":"/dung-api-import-csv-bang-nodejs-va-express","tags":["Nodejs","Backend","JavaScript"],"excerpt":"Ở bài viết này mình muốn xây dựng một API dùng cho việc import CSV bằng nodejs và express, kết hợp với database postgresql.","created":"2023-04-12T04:33:56.927Z","createdPretty":"12 April, 2023","updated":"2023-04-12T04:33:56.927Z","updatedPretty":"12 April, 2023","featuredImage":{"childImageSharp":{"fluid":{"base64":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAA9hAAAPYQGoP6dpAAACIUlEQVQoz2Pg2xQpsiVGcmuC3PZk5R3pGruydHfnGe0tNN9XanOgwvFQjdvheu+jTQHH20JPdEaf6o0/PSH17JTMczPyL8xmwK55D1Szw6Fqp8M1Hkca/Y+1hmDXvDlGcluC3LZk5R1pGjtBmg13FVjsL7U+UOFxqCHmWE/M0d7Y470xJ3qjT/Yknp6IpHljpMj2WMltCbK7U5V2ZmgeytPekKleFm55rNJsf0n6qSk7b51YeW3fsmu7y8/MCz7ZEXu6P/ns5Cyo5u1RopODJXyc5XpDNfv91GdEy0d5K4V6q2UE6lRGeRxtiD7aHXW0O/XkpPTTU5NOTco5OyPn3Mysc9NhmrsDJUr95Vr9taa4qncHy/u6q+WHqEb76k1Kij/dv/D8tpbTS5Zf2b3u+sEVV/YsvbRzydXdWedm5EGdvTVWckei7M5U1S1JeusT9ZYmG+4uNNtRZLmz1OtoQ+K5aZGne1NOTEw4MSHz9LSs09MKz83OQgmwLfFy25NVtqXprYw32JphtK/IfH+p3aFyy71t/IsPmKydEHOiPe/4jNLTc0pPzi47NSf33My8C7NQo2onKKp0dudC4tn2QJnt/jaNroUOC5tiz/RkHJ+SfWpa4alZJafn5IA044pnWCJxOlTleazG52ST/7HWoBPt4Se7Y073J52dnAkNMEIpzPVQg/fhpsDjbWEnumJO9Sacnph2dkoWvhRGKHlCNAMAXwJjAVMGuZoAAAAASUVORK5CYII=","aspectRatio":1.6666666666666667,"srcWebp":"/static/527adeb9fa98ccee34f98ce928095dcc/8761d/featured-nodejs-csv-importer.webp","srcSetWebp":"/static/527adeb9fa98ccee34f98ce928095dcc/08dba/featured-nodejs-csv-importer.webp 200w,\n/static/527adeb9fa98ccee34f98ce928095dcc/9a2fa/featured-nodejs-csv-importer.webp 400w,\n/static/527adeb9fa98ccee34f98ce928095dcc/8761d/featured-nodejs-csv-importer.webp 800w,\n/static/527adeb9fa98ccee34f98ce928095dcc/f31e3/featured-nodejs-csv-importer.webp 878w","src":"/static/527adeb9fa98ccee34f98ce928095dcc/5d1ed/featured-nodejs-csv-importer.png","srcSet":"/static/527adeb9fa98ccee34f98ce928095dcc/4e5c3/featured-nodejs-csv-importer.png 200w,\n/static/527adeb9fa98ccee34f98ce928095dcc/5392f/featured-nodejs-csv-importer.png 400w,\n/static/527adeb9fa98ccee34f98ce928095dcc/5d1ed/featured-nodejs-csv-importer.png 800w,\n/static/527adeb9fa98ccee34f98ce928095dcc/544df/featured-nodejs-csv-importer.png 878w","sizes":"(max-width: 800px) 100vw, 800px"}}}},"html":"<h2 id=\"tản-mạn\" style=\"position:relative;\"><a href=\"#t%E1%BA%A3n-m%E1%BA%A1n\" aria-label=\"tản mạn permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tản mạn</h2>\n<p>Nodejs luôn luôn là một lựa chọn tốt cho startup.</p>\n<p>Lý do ư?</p>\n<ul>\n<li>Nhanh (có hàng tá bài viết nói tại sao Nodejs lại nhanh rồi)</li>\n<li>Dễ code, dễ học, dễ tiếp cận, và dễ maintain: Nhân sĩ trên giang hồ chỉ cần biết một môn công pháp Javascript thôi là đã đủ để luyện cả 2 phần backend và frontend.</li>\n<li>Thư viện hỗ trợ nhiều, cộng đồng đông đảo.</li>\n</ul>\n<p>Tình cờ hôm bữa mình lướt thấy 1 bài viết nói về tối ưu hiệu suất cho Nodejs, mình nghĩ bụng hay là làm một cái thử xem nhỉ. Ơ thế là làm thật, và ra bài viết này.</p>\n<blockquote>\n<p>⚠️ Cảnh báo: Bài viết rất dài và chi tiết.</p>\n</blockquote>\n<h2 id=\"giới-thiệu-về-project\" style=\"position:relative;\"><a href=\"#gi%E1%BB%9Bi-thi%E1%BB%87u-v%E1%BB%81-project\" aria-label=\"giới thiệu về project permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Giới thiệu về project</h2>\n<p>Mình đã quyết định thử nghiệm một chút với Nodejs, và sẽ làm 2 phần, phần đầu tiên sẽ là dựng một service để phục vụ mục đích chính là import CSV.</p>\n<p>Phần tiếp theo sẽ là tối ưu performance. Đợi bài sau sẽ rõ.</p>\n<h3 id=\"tại-sao-lại-la-import-csv\" style=\"position:relative;\"><a href=\"#t%E1%BA%A1i-sao-l%E1%BA%A1i-la-import-csv\" aria-label=\"tại sao lại la import csv permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tại sao lại là import CSV?</h3>\n<p>Thực ra các project CRUD đã quá nhiều rồi, mà mình muốn test thử hiệu năng, cho nên CSV là một lựa chọn không tồi để thử sức với các dataset lớn hàng trăm nghìn dòng, hoặc hàng triệu dòng, mà cũng là do một phần mình đọc được bài viết này <sup id=\"fnref-1\"><a href=\"#fn-1\" class=\"footnote-ref\">1</a></sup>.</p>\n<p>Mà thực tế các hệ thống hiện nay vẫn còn dùng CSV Importer đấy thôi, trong đó có công ty mình.</p>\n<h3 id=\"ưu-diểm-của-csv\" style=\"position:relative;\"><a href=\"#%C6%B0u-di%E1%BB%83m-c%E1%BB%A7a-csv\" aria-label=\"ưu diểm của csv permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Ưu điểm của CSV</h3>\n<ul>\n<li>Thân thiện hơn với user non-tech</li>\n<li>Dễ dàng quản lý relationship</li>\n<li>Có thể dùng để migrate data từ hệ thống cũ qua hệ thống với với sự khác biệtt về cấu trúc data.</li>\n<li>… bạn tự điền nếu bạn có dùng rồi 😂.</li>\n</ul>\n<h2 id=\"first-thing-first\" style=\"position:relative;\"><a href=\"#first-thing-first\" aria-label=\"first thing first permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>First thing first</h2>\n<p>Again, nếu bạn không biết thì mình là Kiên bê đê (lúc đi cùng bạn gái), một anh chàng developer thích viết. Mình đang cố gắng nâng cao kiến thức về máy tính và lập trình bằng nhiều cách như đọc sách, học các khóa học, đọc, và cả viết blog cho mấy cái experiment của mình nữa.</p>\n<p>Hi vọng những bài viết của mình sẽ giúp được bạn, mình rất vui ❤️.</p>\n<h2 id=\"bắt-tay-vao-code\" style=\"position:relative;\"><a href=\"#b%E1%BA%AFt-tay-vao-code\" aria-label=\"bắt tay vao code permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Bắt tay vào code</h2>\n<p>Và đây là cấu trúc dự án mình đã code xong version 1.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 943px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/928e96121d62a0551901af615dc23eec/146da/nodejs-products-csv-project-structure.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 102%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAIAAAAC64paAAAACXBIWXMAAA7EAAAOxAGVKw4bAAAC00lEQVQ4y2WUyXIbNxCG+SaWSM4MgMbe2IFZSIq2YstRqnJIJadc8gbOwdckD54aUqYip+qrOeGb7r+xbOSnv+P0NJ9/Cu0xjI+uvm/HHzGfMT9gfhBYuU6As25PdnoS4YRpUukoXFEub3Yd4UK3tqQyKu2FtNp4yiQDCVwR7igPGmcIM/gJwsz8RE2hJg/cbQi3Eki2ckwBFVe0V6zXQK5QjlQEpSr4kWFhtlAVCeAKd5v9ILKGUzTZyqQhShIlCYIEucIEUh5AZeYqw0qEH5gl3BHuBsDNfQf7QRjMxqWOym0H2/4VAshkNGF0ccaVJdYHlw+YFp+Pq3zXAQE9L0euw7sdve/gBuHIZBCmCj9x10AlJgOoeP1urosGJudlDuWw7fn9nv1HdkwErgrDte01sPArt7bvL5WXZanLIyh/91YGGY2dVtkWcI3Z8vIX7l7leVlcmjuq37btmIrCZgI4fOM66le5p+JwmGI7gfLbtzJ3WZpsfQGVuF4zX80X+a6DjvDDMsZ25Pp/bdvEcVRYtWvGj1yn4bvKTGIbZ2kzE/hmYMIxEbnO1NVBhZ6aHuyt/1V+twfCTWoH5dp2UHd7eOGaWUZQSZiqTJMqS1WlLEpVIfMqA4OMpuWspWKEcsZuXI+ntFXb0brJuglxvrAgLpvtICiFaaopVWMspazvh28QKhzTSWPVmKkM3GTQkZvETeYmb3qm9yLlH37Jy3NcnmV46ETd8bLjdccCAQSblJ8NFolVYZW2UO4Hdsk8gFTTr+ff/nn+/a/556/x6Uv6/Gf6/CU/f8XzHwMYJoKwVZgibVZYlVtv+Mu0mcRQxuXDxzafQm7GRe3CDVCRu4xhqu0gbTF+NH5aiwtPhd/0VFPplJ8UFu0b1+HleK8bxtZp62zqY2znPL4fp5NLs9BZmJVLZiI7IjuqdoNYze9vVbTtg68PuZ1COfpysGFSl+fpX4st5T+IaAuzAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/928e96121d62a0551901af615dc23eec/c85cb/nodejs-products-csv-project-structure.webp 300w,\n/static/928e96121d62a0551901af615dc23eec/e88ff/nodejs-products-csv-project-structure.webp 600w,\n/static/928e96121d62a0551901af615dc23eec/18615/nodejs-products-csv-project-structure.webp 943w\"\n              sizes=\"(max-width: 943px) 100vw, 943px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/928e96121d62a0551901af615dc23eec/5a46d/nodejs-products-csv-project-structure.png 300w,\n/static/928e96121d62a0551901af615dc23eec/0a47e/nodejs-products-csv-project-structure.png 600w,\n/static/928e96121d62a0551901af615dc23eec/146da/nodejs-products-csv-project-structure.png 943w\"\n            sizes=\"(max-width: 943px) 100vw, 943px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/928e96121d62a0551901af615dc23eec/146da/nodejs-products-csv-project-structure.png\"\n            alt=\"nodejs-products-csv-project-structure.png\"\n            title=\"nodejs-products-csv-project-structure.png\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>Code hiện có ở trên github repo<sup id=\"fnref-2\"><a href=\"#fn-2\" class=\"footnote-ref\">2</a></sup>, các bạn tham khảo nhé.</p>\n<h3 id=\"khởi-tạo-nodejs-project\" style=\"position:relative;\"><a href=\"#kh%E1%BB%9Fi-t%E1%BA%A1o-nodejs-project\" aria-label=\"khởi tạo nodejs project permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Khởi tạo Nodejs Project</h3>\n<p>Mình thích typescript hơn javascript nhiều, tuy nhiên sau khi dùng Goland/IntelliJ để code thì nó gợi ý hay quá, mình cảm giác không cần typescript cũng không sao 😄. Vậy nên để tập trung vào vấn đề chính, mình code Javascript cho lẹ.</p>\n<p>Mình giả định các bạn cũng dùng Linux/Mac nhé, nên mình dùng command trên linux luôn.</p>\n<p>Tạo folder và init:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">mkdir</span> nodejs-product-csv <span class=\"token operator\">&amp;&amp;</span> <span class=\"token builtin class-name\">cd</span> nodejs-product-csv</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">yarn</span> init</code></pre></div>\n<p>Điền vài thông tin cơ bản xong thì đến với bước thêm thư viện:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">yarn</span> <span class=\"token function\">add</span> express ejs multer fast-csv csv-writer pg sequelize colors</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">yarn</span> <span class=\"token function\">add</span> -D nodemon autocannon @faker-js/faker</code></pre></div>\n<p>Đến đây thì để tại hạ phải ra mặt giới thiệu những thư viện trên cho các đạo hữu rồi:</p>\n<ul>\n<li><strong>express</strong>: Web framework của nodejs, nổi tiếng nhỏ mà có võ.</li>\n<li><strong>ejs</strong>: Javascript template engine, dùng như Razor trong .NET vậy, giúp chúng ta render các file template HTML.</li>\n<li><strong>multer</strong>: Middleware hỗ trợ cache file upload.</li>\n<li><strong>fast-csv</strong>, <strong>csv-writer</strong>: Hai thư viện này phục vụ cho việc đọc và xuất CSV từ dữ liệu của chúng ta.</li>\n<li><strong>pg</strong>: Driver cho postgresql.</li>\n<li><strong>sequelize:</strong> ORM này hỗ trợ tốt việc define schema và khá tối ưu query. Mình chọn sequelize vì nó khá đơn giản, còn nếu làm typeorm hay prisma thì hiệu năng cao hơn, nhưng tốn thời gian setup hơn nên mình lười.\nThêm vào đó, với kinh nghiệm của mình thi sequelize cũng hỗ trợ query tốt hơn trong trường hợp không sử dụng raw-query, đặc biệt là các field JSON.</li>\n</ul>\n<p>Tương tự mình cũng cài thêm vài package hỗ trợ cho việc dev mượt mà hơn:</p>\n<ul>\n<li><strong>nodemon</strong>: Hỗ trợ reload app khi chúng ta thay đổi code (watch mode).</li>\n<li><strong>autocannon</strong>: HTTP benchmark tool, giúp mình đo hiệu năng của app.</li>\n<li><strong>@faker-js/faker</strong>: Thư viện hỗ trợ fake data, rất hữu ích trong việc generate cả triệu dòng CSV để test.</li>\n</ul>\n<h4 id=\"cấu-truc-thư-mục\" style=\"position:relative;\"><a href=\"#c%E1%BA%A5u-truc-th%C6%B0-m%E1%BB%A5c\" aria-label=\"cấu truc thư mục permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Cấu trúc thư mục</h4>\n<p>Trước khi code mình show cho các bạn xem cấu trúc thư mục, để cho các phần tiếp theo được dễ hình dung:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">.\n├── bench\n│   ├── sample-csv\n│   └── v1.bash\n├── csv-generator.js\n├── data\n│   └── postgres //readonly\n├── docker-compose.yml\n├── package.json\n├── src\n│   ├── config\n│   │   └── db.js\n│   ├── handlers\n│   │   ├── index.js\n│   │   └── product.js\n│   ├── index.js\n│   ├── middlewares\n│   │   ├── fileUpload.js\n│   │   └── logger.js\n│   ├── models\n│   │   ├── categoryInit.js\n│   │   ├── index.js\n│   │   ├── productInit.js\n│   │   └── sequelize.js\n│   ├── utils\n│   │   └── pathHelper.js\n│   └── views\n└── static\n    ├── exports\n    └── uploads</code></pre></div>\n<h3 id=\"dựng-database-postgresql\" style=\"position:relative;\"><a href=\"#d%E1%BB%B1ng-database-postgresql\" aria-label=\"dựng database postgresql permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Dựng database postgresql</h3>\n<p>Như trong bài trước về <a href=\"https://devgiangho.github.io/golang-slice-tat-tan-tat-va-nhung-dieu-co-the-ban-chua-biet/\">connection pooling</a>, mình đã tạo 1 DB postgres cho bảng Product rất đơn giản. Bài này mình dùng lại cái schema đó và thay đổi thêm 1 chút.</p>\n<p>Lần này mình có 1 bảng Product, liên kết khóa ngoại tới bảng Category.</p>\n<p>File <code class=\"language-text\">seed.sql</code> để khởi tạo database và chèn sẵn 10 danh mục (category):</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token comment\">-- We need double quoted the column names to preserve the case.</span>\n<span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">TABLE</span> <span class=\"token keyword\">IF</span> <span class=\"token operator\">NOT</span> <span class=\"token keyword\">EXISTS</span> categories\n<span class=\"token punctuation\">(</span>\n    id          <span class=\"token keyword\">VARCHAR</span><span class=\"token punctuation\">(</span><span class=\"token number\">36</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">PRIMARY</span> <span class=\"token keyword\">KEY</span><span class=\"token punctuation\">,</span>\n    name        <span class=\"token keyword\">VARCHAR</span><span class=\"token punctuation\">(</span><span class=\"token number\">255</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n    description <span class=\"token keyword\">TEXT</span><span class=\"token punctuation\">,</span>\n    code        <span class=\"token keyword\">VARCHAR</span><span class=\"token punctuation\">(</span><span class=\"token number\">12</span><span class=\"token punctuation\">)</span>  <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"createdAt\"</span> <span class=\"token keyword\">TIMESTAMP</span>    <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token function\">NOW</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"updatedAt\"</span> <span class=\"token keyword\">TIMESTAMP</span>    <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token function\">NOW</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">TABLE</span> <span class=\"token keyword\">IF</span> <span class=\"token operator\">NOT</span> <span class=\"token keyword\">EXISTS</span> products\n<span class=\"token punctuation\">(</span>\n    id           <span class=\"token keyword\">VARCHAR</span><span class=\"token punctuation\">(</span><span class=\"token number\">36</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">PRIMARY</span> <span class=\"token keyword\">KEY</span><span class=\"token punctuation\">,</span>\n    name         <span class=\"token keyword\">VARCHAR</span><span class=\"token punctuation\">(</span><span class=\"token number\">255</span><span class=\"token punctuation\">)</span>   <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n    price        <span class=\"token keyword\">NUMERIC</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n    description  <span class=\"token keyword\">TEXT</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"categoryId\"</span> <span class=\"token keyword\">VARCHAR</span><span class=\"token punctuation\">(</span><span class=\"token number\">36</span><span class=\"token punctuation\">)</span>    <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"createdAt\"</span>  <span class=\"token keyword\">TIMESTAMP</span>      <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token function\">NOW</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"updatedAt\"</span>  <span class=\"token keyword\">TIMESTAMP</span>      <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token function\">NOW</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token keyword\">CONSTRAINT</span> products_categoryId_fk <span class=\"token keyword\">FOREIGN</span> <span class=\"token keyword\">KEY</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"categoryId\"</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">REFERENCES</span> categories <span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">)</span> <span class=\"token keyword\">ON</span> <span class=\"token keyword\">DELETE</span> <span class=\"token keyword\">CASCADE</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> categories <span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">,</span> name<span class=\"token punctuation\">,</span> description<span class=\"token punctuation\">,</span> code<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">VALUES</span> <span class=\"token punctuation\">(</span><span class=\"token string\">'b2ff1377-c40c-4c10-b3a4-4d12c2f90bca'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'Electronics'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'Category for electronic devices'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'ELC'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n       <span class=\"token punctuation\">(</span><span class=\"token string\">'8c054e34-e65d-4b6e-b7f1-9d9b556e10d1'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'Clothing'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'Category for clothing items'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'CLT'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n       <span class=\"token punctuation\">(</span><span class=\"token string\">'a18b11cc-9a2e-4a04-b831-dde4667e8e0a'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'Books'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'Category for books and literature'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'BKS'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n       <span class=\"token punctuation\">(</span><span class=\"token string\">'773e7aa3-f06d-42af-a8c3-3cb50d966f26'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'Home &amp; Kitchen'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'Category for home and kitchen products'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'HKP'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n       <span class=\"token punctuation\">(</span><span class=\"token string\">'b8f3c3eb-30f6-41dd-a7b8-518ff2db616f'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'Health &amp; Beauty'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'Category for health and beauty products'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'HBP'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n       <span class=\"token punctuation\">(</span><span class=\"token string\">'5c6f5df6-5c5f-4a69-a38c-95d330c156e2'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'Toys &amp; Games'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'Category for toys and games'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'TNG'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n       <span class=\"token punctuation\">(</span><span class=\"token string\">'54b31c80-38f6-4e6a-9f70-049a8e0905c9'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'Sports &amp; Outdoors'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'Category for sports and outdoor products'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'SPO'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n       <span class=\"token punctuation\">(</span><span class=\"token string\">'66d74c4b-4b4d-4a54-935d-6b0b6faa07f4'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'Automotive'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'Category for automotive products'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'AUT'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n       <span class=\"token punctuation\">(</span><span class=\"token string\">'23212a97-74af-460e-bd3d-7b1320dd1c25'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'Office Products'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'Category for office supplies and stationery'</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'OFS'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n       <span class=\"token punctuation\">(</span><span class=\"token string\">'141d2f17-91d8-4f9d-9143-3b8213c6f5a5'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'Pet Supplies'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'Category for pet supplies and accessories'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'PET'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Có một lưu ý nhỏ, postgresql không giống với SQLServer, khi chúng ta tạo table với các column thì nó sẽ tự động lowercase hết column name <code class=\"language-text\">createdAt → createdat</code> và làm cho Sequelize bị lỗi.</p>\n<p>Để né việc đó, chúng ta cần thêm nháy kép (<code class=\"language-text\">&quot;createdAt&quot;</code>) trong DDL.</p>\n<p>Tiếp tục tạo file <code class=\"language-text\">docker-compose.yml</code> để seed data:</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\">version: <span class=\"token string\">\"3.9\"</span>\n\nservices:\n  postgres:\n    image: postgres:<span class=\"token number\">13.1</span><span class=\"token operator\">-</span>alpine\n    container_name: product_postgres_container\n    volumes:\n      <span class=\"token operator\">-</span> <span class=\"token punctuation\">.</span><span class=\"token operator\">/</span>seed<span class=\"token punctuation\">.</span><span class=\"token keyword\">sql</span>:<span class=\"token operator\">/</span>docker<span class=\"token operator\">-</span>entrypoint<span class=\"token operator\">-</span>initdb<span class=\"token punctuation\">.</span>d<span class=\"token operator\">/</span>seed<span class=\"token punctuation\">.</span><span class=\"token keyword\">sql</span>\n      <span class=\"token operator\">-</span> <span class=\"token punctuation\">.</span><span class=\"token operator\">/</span><span class=\"token keyword\">data</span><span class=\"token operator\">/</span>postgres:<span class=\"token operator\">/</span>var<span class=\"token operator\">/</span>lib<span class=\"token operator\">/</span>postgresql<span class=\"token operator\">/</span><span class=\"token keyword\">data</span>\n    environment:\n      <span class=\"token operator\">-</span> POSTGRES_DB<span class=\"token operator\">=</span>${POSTGRES_DB:<span class=\"token operator\">-</span>postgres}\n      <span class=\"token operator\">-</span> POSTGRES_USER<span class=\"token operator\">=</span>${POSTGRES_USER:<span class=\"token operator\">-</span>postgres}\n      <span class=\"token operator\">-</span> POSTGRES_PASSWORD<span class=\"token operator\">=</span>${POSTGRES_PASSWORD:<span class=\"token operator\">-</span>password1}\n    ports:\n      <span class=\"token operator\">-</span> <span class=\"token string\">\"5433:5432\"</span>\n    restart: unless<span class=\"token operator\">-</span>stopped</code></pre></div>\n<p>Giờ ta chỉ cần chạy <code class=\"language-text\">docker compose up -d</code> là đã có 1 DB postgres ở cổng 5433.</p>\n<h3 id=\"dựng-data-model-va-kết-nối-database\" style=\"position:relative;\"><a href=\"#d%E1%BB%B1ng-data-model-va-k%E1%BA%BFt-n%E1%BB%91i-database\" aria-label=\"dựng data model va kết nối database permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Dựng data model và kết nối database</h3>\n<p>Mình trước hết cần một file config để lưu thiết lập, connection string của database, đó là file <code class=\"language-text\">/src/config/db.js</code> :</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> dbConfig <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token constant\">HOST</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"localhost\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token constant\">USER</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"postgres\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token constant\">PASSWORD</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"password1\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token constant\">PORT</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"5433\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token constant\">DB</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"postgres\"</span><span class=\"token punctuation\">,</span>\n  dialect<span class=\"token punctuation\">:</span> <span class=\"token string\">\"postgres\"</span><span class=\"token punctuation\">,</span>\n  pool<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n    max<span class=\"token punctuation\">:</span> <span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// max pool size</span>\n    min<span class=\"token punctuation\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// min pool size</span>\n    acquire<span class=\"token punctuation\">:</span> <span class=\"token number\">3000</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// timeout to wait connection in  milliseconds</span>\n    idle<span class=\"token punctuation\">:</span> <span class=\"token number\">10000</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// idle time in milliseconds</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> dbConfig<span class=\"token punctuation\">;</span></code></pre></div>\n<p>Ở đây mình hardcode luôn các biến môi trường, thực tế có thể thêm vài dòng để đọc ra từ file <code class=\"language-text\">.env</code> .</p>\n<p>Sequelize có hỗ trợ connection pooling mặc định luôn trong các thiết đặt, nếu bạn chưa biết thì đọc bài viết trước<sup id=\"fnref-3\"><a href=\"#fn-3\" class=\"footnote-ref\">3</a></sup> của mình nhé.</p>\n<p>Vào folder <code class=\"language-text\">src/models</code> để chúng ta làm việc tiếp, đầu tiên chúng ta cần 1 instance của Sequelize, lấy config từ file config hồi nãy:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">import</span> dbConfig <span class=\"token keyword\">from</span> <span class=\"token string\">\"../config/db.js\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> Sequelize <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"sequelize\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> colors <span class=\"token keyword\">from</span> <span class=\"token string\">\"colors\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> sequelize <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Sequelize</span><span class=\"token punctuation\">(</span>\n  dbConfig<span class=\"token punctuation\">.</span><span class=\"token constant\">DB</span><span class=\"token punctuation\">,</span>\n  dbConfig<span class=\"token punctuation\">.</span><span class=\"token constant\">USER</span><span class=\"token punctuation\">,</span>\n  dbConfig<span class=\"token punctuation\">.</span><span class=\"token constant\">PASSWORD</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">{</span>\n    host<span class=\"token punctuation\">:</span> dbConfig<span class=\"token punctuation\">.</span><span class=\"token constant\">HOST</span><span class=\"token punctuation\">,</span>\n    dialect<span class=\"token punctuation\">:</span> dbConfig<span class=\"token punctuation\">.</span>dialect<span class=\"token punctuation\">,</span>\n    operatorsAliases<span class=\"token punctuation\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n    port<span class=\"token punctuation\">:</span> dbConfig<span class=\"token punctuation\">.</span><span class=\"token constant\">PORT</span><span class=\"token punctuation\">,</span>\n    pool<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n      max<span class=\"token punctuation\">:</span> dbConfig<span class=\"token punctuation\">.</span>pool<span class=\"token punctuation\">.</span>max<span class=\"token punctuation\">,</span>\n      min<span class=\"token punctuation\">:</span> dbConfig<span class=\"token punctuation\">.</span>pool<span class=\"token punctuation\">.</span>min<span class=\"token punctuation\">,</span>\n      acquire<span class=\"token punctuation\">:</span> dbConfig<span class=\"token punctuation\">.</span>pool<span class=\"token punctuation\">.</span>acquire<span class=\"token punctuation\">,</span>\n      idle<span class=\"token punctuation\">:</span> dbConfig<span class=\"token punctuation\">.</span>pool<span class=\"token punctuation\">.</span>idle<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    define<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n      timestamps<span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n      underscored<span class=\"token punctuation\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    benchmark<span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n    <span class=\"token function-variable function\">logging</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">message<span class=\"token punctuation\">,</span> execTime</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>message<span class=\"token punctuation\">.</span>length <span class=\"token operator\">></span> <span class=\"token number\">500</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        message <span class=\"token operator\">=</span> message<span class=\"token punctuation\">.</span><span class=\"token function\">slice</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">500</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">\"... (truncated)\"</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\">// You can use something like cloud logging...</span>\n      <span class=\"token punctuation\">}</span>\n      <span class=\"token keyword\">let</span> color <span class=\"token operator\">=</span> colors<span class=\"token punctuation\">.</span>blue<span class=\"token punctuation\">.</span>bold<span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>execTime <span class=\"token operator\">&amp;&amp;</span> execTime <span class=\"token operator\">>=</span> <span class=\"token number\">30</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        color <span class=\"token operator\">=</span> colors<span class=\"token punctuation\">.</span>red<span class=\"token punctuation\">.</span>bold<span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n      console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>colors<span class=\"token punctuation\">.</span>magenta<span class=\"token punctuation\">.</span><span class=\"token function\">bold</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">[</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>execTime<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\"> ms]</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token function\">color</span><span class=\"token punctuation\">(</span>message<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nsequelize\n  <span class=\"token punctuation\">.</span><span class=\"token function\">authenticate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Connection has been established successfully.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">err</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Unable to connect to the database:\"</span><span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> sequelize<span class=\"token punctuation\">;</span></code></pre></div>\n<p>Ở đây mình cũng làm luôn 1 cái logger đơn giản cho sequelize, để in ra những query nào tốn thời gian để thực thi thì bôi nó thành màu đỏ, khỏi cần dùng ASCII code vì có thư viện colors lo.</p>\n<p>Tiếp tục define model schema cho bảng Product và Category tương tứng 2 file <code class=\"language-text\">ProductInit.js</code> và <code class=\"language-text\">CategoryInit.js</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">import</span> Sequelize <span class=\"token keyword\">from</span> <span class=\"token string\">\"sequelize\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> sequelize <span class=\"token keyword\">from</span> <span class=\"token string\">\"./sequelize.js\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> ProductInit <span class=\"token operator\">=</span> sequelize<span class=\"token punctuation\">.</span><span class=\"token function\">define</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"products\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n  id<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n    type<span class=\"token punctuation\">:</span> Sequelize<span class=\"token punctuation\">.</span><span class=\"token constant\">UUID</span><span class=\"token punctuation\">,</span>\n    defaultValue<span class=\"token punctuation\">:</span> Sequelize<span class=\"token punctuation\">.</span><span class=\"token constant\">UUIDV4</span><span class=\"token punctuation\">,</span>\n    primaryKey<span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  name<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n    type<span class=\"token punctuation\">:</span> Sequelize<span class=\"token punctuation\">.</span><span class=\"token constant\">STRING</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  price<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n    type<span class=\"token punctuation\">:</span> Sequelize<span class=\"token punctuation\">.</span><span class=\"token constant\">FLOAT</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  description<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n    type<span class=\"token punctuation\">:</span> Sequelize<span class=\"token punctuation\">.</span><span class=\"token constant\">STRING</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  categoryId<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n    type<span class=\"token punctuation\">:</span> Sequelize<span class=\"token punctuation\">.</span><span class=\"token constant\">UUID</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  createdAt<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n    type<span class=\"token punctuation\">:</span> Sequelize<span class=\"token punctuation\">.</span><span class=\"token constant\">DATE</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  updatedAt<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n    type<span class=\"token punctuation\">:</span> Sequelize<span class=\"token punctuation\">.</span><span class=\"token constant\">DATE</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> ProductInit<span class=\"token punctuation\">;</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">import</span> Sequelize <span class=\"token keyword\">from</span> <span class=\"token string\">\"sequelize\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> sequelize <span class=\"token keyword\">from</span> <span class=\"token string\">\"./sequelize.js\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> CategoryInit <span class=\"token operator\">=</span> sequelize<span class=\"token punctuation\">.</span><span class=\"token function\">define</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"categories\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n  id<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n    type<span class=\"token punctuation\">:</span> Sequelize<span class=\"token punctuation\">.</span><span class=\"token constant\">UUID</span><span class=\"token punctuation\">,</span>\n    defaultValue<span class=\"token punctuation\">:</span> Sequelize<span class=\"token punctuation\">.</span><span class=\"token constant\">UUIDV4</span><span class=\"token punctuation\">,</span>\n    primaryKey<span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  name<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n    type<span class=\"token punctuation\">:</span> Sequelize<span class=\"token punctuation\">.</span><span class=\"token constant\">STRING</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  code<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n    type<span class=\"token punctuation\">:</span> Sequelize<span class=\"token punctuation\">.</span><span class=\"token constant\">STRING</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  description<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n    type<span class=\"token punctuation\">:</span> Sequelize<span class=\"token punctuation\">.</span><span class=\"token constant\">STRING</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  createdAt<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n    type<span class=\"token punctuation\">:</span> Sequelize<span class=\"token punctuation\">.</span><span class=\"token constant\">DATE</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  updatedAt<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n    type<span class=\"token punctuation\">:</span> Sequelize<span class=\"token punctuation\">.</span><span class=\"token constant\">DATE</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> CategoryInit<span class=\"token punctuation\">;</span></code></pre></div>\n<p>Tạo 1 file <code class=\"language-text\">index.js</code> để khai báo thêm ràng buộc khóa ngoại cho 2 table trên.</p>\n<p>Ở đây Product và Category có quan hệ Many-To-One, cho nên mình sử dụng 2 phương thức của Sequelize là <code class=\"language-text\">hasMany</code> và <code class=\"language-text\">belongsTo</code> .</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">import</span> ProductInit <span class=\"token keyword\">from</span> <span class=\"token string\">\"./productInit.js\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> CategoryInit <span class=\"token keyword\">from</span> <span class=\"token string\">\"./categoryInit.js\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> Sequelize <span class=\"token keyword\">from</span> <span class=\"token string\">\"sequelize\"</span><span class=\"token punctuation\">;</span>\n\nCategoryInit<span class=\"token punctuation\">.</span>Products <span class=\"token operator\">=</span> CategoryInit<span class=\"token punctuation\">.</span><span class=\"token function\">hasMany</span><span class=\"token punctuation\">(</span>ProductInit<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n  foreignKey<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n    name<span class=\"token punctuation\">:</span> <span class=\"token string\">\"categoryId\"</span><span class=\"token punctuation\">,</span>\n    type<span class=\"token punctuation\">:</span> Sequelize<span class=\"token punctuation\">.</span><span class=\"token constant\">UUID</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nProductInit<span class=\"token punctuation\">.</span><span class=\"token function\">belongsTo</span><span class=\"token punctuation\">(</span>CategoryInit<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n  foreignKey<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n    name<span class=\"token punctuation\">:</span> <span class=\"token string\">\"categoryId\"</span><span class=\"token punctuation\">,</span>\n    type<span class=\"token punctuation\">:</span> Sequelize<span class=\"token punctuation\">.</span><span class=\"token constant\">UUID</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token punctuation\">{</span> ProductInit <span class=\"token keyword\">as</span> Product<span class=\"token punctuation\">,</span> CategoryInit <span class=\"token keyword\">as</span> Category <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Có thể bạn sẽ hỏi tại sao mình không khai báo luôn relationship ở trong <code class=\"language-text\">ProductInit</code> và <code class=\"language-text\">CategoryInit</code> . Đáp án là bởi vì nếu làm vậy sẽ xảy ra lỗi circular import.</p>\n<p>Mình cũng muốn export chỉ mỗi model để thao tác query, nên cũng không gán 2 model này vào instance của Sequelize. Coi tiếp phần dưới thì bạn sẽ thấy mình chỉ import model từ <code class=\"language-text\">models/index.js</code> mà thôi.</p>\n<h3 id=\"cache-lại-file-da-upload\" style=\"position:relative;\"><a href=\"#cache-l%E1%BA%A1i-file-da-upload\" aria-label=\"cache lại file da upload permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Cache lại file đã upload</h3>\n<p>Như bạn đã biết, lúc import thì file CSV có thể lên tới hàng triệu dòng, do vậy nên kích thước file khá là lớn (tầm 150mb cho 1 triệu dòng), thế nên việc cache lại file vào ổ cứng là điều phải làm.</p>\n<p>Tạo 1 middleware <code class=\"language-text\">middlewares/fileUpload.js</code> :</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">import</span> fs <span class=\"token keyword\">from</span> <span class=\"token string\">\"fs\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> multer <span class=\"token keyword\">from</span> <span class=\"token string\">\"multer\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> appDir <span class=\"token keyword\">from</span> <span class=\"token string\">\"../utils/pathHelper.js\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> storage <span class=\"token operator\">=</span> multer<span class=\"token punctuation\">.</span><span class=\"token function\">diskStorage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  <span class=\"token function-variable function\">destination</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">_req<span class=\"token punctuation\">,</span> file<span class=\"token punctuation\">,</span> callback</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> dir <span class=\"token operator\">=</span> appDir <span class=\"token operator\">+</span> <span class=\"token string\">\"static/uploads\"</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>fs<span class=\"token punctuation\">.</span><span class=\"token function\">existsSync</span><span class=\"token punctuation\">(</span>dir<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      fs<span class=\"token punctuation\">.</span><span class=\"token function\">mkdirSync</span><span class=\"token punctuation\">(</span>dir<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> recursive<span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token function\">callback</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> dir<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token function-variable function\">filename</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">_req<span class=\"token punctuation\">,</span> file<span class=\"token punctuation\">,</span> callback</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">callback</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>process<span class=\"token punctuation\">.</span>hrtime<span class=\"token punctuation\">.</span><span class=\"token function\">bigint</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">-</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>file<span class=\"token punctuation\">.</span>originalname<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">csvFilter</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">_req<span class=\"token punctuation\">,</span> file<span class=\"token punctuation\">,</span> callback</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Reading file in middleware\"</span><span class=\"token punctuation\">,</span> file<span class=\"token punctuation\">.</span>originalname<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>file<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">callback</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Please upload a file to proceed.\"</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>file<span class=\"token punctuation\">.</span>mimetype<span class=\"token punctuation\">.</span><span class=\"token function\">includes</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"csv\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">callback</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">callback</span><span class=\"token punctuation\">(</span>\n      <span class=\"token string\">\"Please upload only csv file as only CSV is supported for now.\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token boolean\">false</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token function\">multer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  storage<span class=\"token punctuation\">:</span> storage<span class=\"token punctuation\">,</span>\n  fileFilter<span class=\"token punctuation\">:</span> csvFilter<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Đặc thù hệ thống là import CSV, do vậy nên middleware này chỉ cho phép upload file có đuôi csv mà thôi, sau đó cache lại trong ổ đĩa.</p>\n<p>Ở đây mình cache lại file name theo dạng <code class=\"language-text\">${process.hrtime.bigint()}-${file.originalname}</code> , lý do mình dùng <code class=\"language-text\">process.hrtime.bigint()</code> thay vì <code class=\"language-text\">Date.now()</code> chính là khi mình thực hiện stress test (ở bước tiếp theo) thì lượng request đồng thời rất lớn, khiến cho hàm <code class=\"language-text\">Date.now()</code> trả về giá trị đôi lúc giống nhau, cho nên file bị conflict. <code class=\"language-text\">process.hrtime.bigint()</code> trả về nanoseconds, còn <code class=\"language-text\">Date.now()</code> trả về milliseconds<sup id=\"fnref-4\"><a href=\"#fn-4\" class=\"footnote-ref\">4</a></sup>.</p>\n<p>Ở đây do với chế độ module thì thằng quỷ Nodejs không cho phép gọi <code class=\"language-text\">__dirname</code>. Nên mình làm 1 cái file helper để lấy folder root của project nằm ở <code class=\"language-text\">utils/pathHelper.js</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">import</span> path <span class=\"token keyword\">from</span> <span class=\"token string\">\"path\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> fileURLToPath <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"url\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> __dirname <span class=\"token operator\">=</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">dirname</span><span class=\"token punctuation\">(</span><span class=\"token function\">fileURLToPath</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">import</span><span class=\"token punctuation\">.</span>meta<span class=\"token punctuation\">.</span>url<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> appDir <span class=\"token operator\">=</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span>__dirname<span class=\"token punctuation\">,</span> <span class=\"token string\">\"../../\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> appDir<span class=\"token punctuation\">;</span></code></pre></div>\n<h3 id=\"cac-endpoint-rest-api\" style=\"position:relative;\"><a href=\"#cac-endpoint-rest-api\" aria-label=\"cac endpoint rest api permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Các endpoint REST API</h3>\n<p>Như đã nói ở đầu bài viết, mục đích chính của service này là để import CSV. Do đó mình chỉ có vài endpoint sau:</p>\n<ul>\n<li><code class=\"language-text\">/</code> - GET: Index, dùng để làm giao diện cho form upload CSV.</li>\n<li><code class=\"language-text\">/api/products</code> - GET: Lấy 200 product mới nhất để hiển thị.</li>\n<li><code class=\"language-text\">/api/products/:id</code> - GET: Lấy product theo ID.</li>\n<li><code class=\"language-text\">/api/products/export</code> - GET: Export products ra file CSV và download.</li>\n<li><code class=\"language-text\">/api/products/import</code> - POST: Import CSV file.</li>\n</ul>\n<p>Handler của những endpoint này sẽ nằm trong folder <code class=\"language-text\">handlers</code>.</p>\n<p>Bắt đầu với file <code class=\"language-text\">product.js</code> cho những handler liên quan em này:</p>\n<h4 id=\"get-many-products\" style=\"position:relative;\"><a href=\"#get-many-products\" aria-label=\"get many products permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Get many products</h4>\n<p>Mình query lấy ra 200 product mới nhất:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">findManyProducts</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// should add pagination.</span>\n    <span class=\"token keyword\">const</span> products <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> Product<span class=\"token punctuation\">.</span><span class=\"token function\">findAll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      limit<span class=\"token punctuation\">:</span> <span class=\"token number\">200</span><span class=\"token punctuation\">,</span>\n      include<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token punctuation\">{</span>\n          model<span class=\"token punctuation\">:</span> Category<span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n      order<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token punctuation\">[</span><span class=\"token string\">\"updatedAt\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"DESC\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">[</span><span class=\"token string\">\"createdAt\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"DESC\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    res<span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      message<span class=\"token punctuation\">:</span> <span class=\"token string\">\"OK\"</span><span class=\"token punctuation\">,</span>\n      data<span class=\"token punctuation\">:</span> products<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    res<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">500</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      message<span class=\"token punctuation\">:</span> <span class=\"token string\">\"internal error\"</span><span class=\"token punctuation\">,</span>\n      err<span class=\"token punctuation\">:</span> err<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Thực tế cần phải làm thêm phần pagination, nhưng mục tiêu chính mình làm không phải ở đó nên đã bỏ qua.</p>\n<p>Mình có dùng option include, tức là sẽ join và lấy luôn Category về, kết quả sẽ hiển thị ở postman như sau:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1200px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/2af70692ae27664661d65edc11fdd752/e8814/postman-get-many-products.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 61.33333333333334%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAA9hAAAPYQGoP6dpAAABOklEQVQoz42RWW7cQAxEdWafKUfIOXwMG87IaqkXNllcJqDGntjIx/iBIIofJVZTy77vtdZSymVNjuPovRONG/MLzEw0wXOt8+n3+PUsSztKq4eqAgLFKRJVdffrJ2amqveRRPuUxd3N7PodEYnvMPOc8z4qoJCllq33Poh6b2OM3AncPhERN+HuACQdyhACjmFQX1pvvVbqg5kVIiIKuf5HZMVd25l3sQhTBRHDGa4W5lnXR0TEAjWPUBrH2+X1fVyOuVUuTdpUqMtHZch/I1KnmaEWgTHGy8vW+HWjtzIrQdT8jPC138vTG8vM1e6mYyvrTqXJYG0E5J+KB7HTbGmXbRu1rVW2xnUAlu9/YGaomrkqi04xhmdX+9HBOHeE0TjW8mefe5dGINEJExjOzrDbtRh5PIGdF/G/o+O/DIFbthAAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/2af70692ae27664661d65edc11fdd752/c85cb/postman-get-many-products.webp 300w,\n/static/2af70692ae27664661d65edc11fdd752/e88ff/postman-get-many-products.webp 600w,\n/static/2af70692ae27664661d65edc11fdd752/92f8c/postman-get-many-products.webp 1200w,\n/static/2af70692ae27664661d65edc11fdd752/f3c7c/postman-get-many-products.webp 1392w\"\n              sizes=\"(max-width: 1200px) 100vw, 1200px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/2af70692ae27664661d65edc11fdd752/5a46d/postman-get-many-products.png 300w,\n/static/2af70692ae27664661d65edc11fdd752/0a47e/postman-get-many-products.png 600w,\n/static/2af70692ae27664661d65edc11fdd752/c1b63/postman-get-many-products.png 1200w,\n/static/2af70692ae27664661d65edc11fdd752/e8814/postman-get-many-products.png 1392w\"\n            sizes=\"(max-width: 1200px) 100vw, 1200px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/2af70692ae27664661d65edc11fdd752/c1b63/postman-get-many-products.png\"\n            alt=\"postman-get-many-products.png\"\n            title=\"postman-get-many-products.png\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<h4 id=\"get-product-by-id\" style=\"position:relative;\"><a href=\"#get-product-by-id\" aria-label=\"get product by id permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Get product by ID</h4>\n<p>Cũng giống với findMany, khi lấy chỉ 1 product theo ID thì chúng ta chỉ cần lấy id từ path params vào thôi:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">findOneProduct</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> id <span class=\"token operator\">=</span> req<span class=\"token punctuation\">.</span>params<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> product <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> Product<span class=\"token punctuation\">.</span><span class=\"token function\">findByPk</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n      include<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token punctuation\">{</span>\n          model<span class=\"token punctuation\">:</span> Category<span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>product<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      res<span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n        message<span class=\"token punctuation\">:</span> <span class=\"token string\">\"OK\"</span><span class=\"token punctuation\">,</span>\n        data<span class=\"token punctuation\">:</span> product<span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n      res<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">404</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n        message<span class=\"token punctuation\">:</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Cannot find Product with id=</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>id<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">.</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    res<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">500</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      message<span class=\"token punctuation\">:</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Error retrieving Product with id=</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>id<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span>\n      error<span class=\"token punctuation\">:</span> err<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Kết quả khi gọi postman:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1200px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/f49b1ae572906db71cbbb3c4defa3b6b/062c8/postman-get-one-product.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 61%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAA9hAAAPYQGoP6dpAAABOUlEQVQoz4WQXXIcIQyE59S+UY6Qc/gUrtrYM4YFCfTTYlKw3k2ch+xXegCqWnT3di2lEqWU92Pf9z2nxEStNV70O7JorZv0vcjLT/7xKlu9JqIKhLs7HICZmRoABM47WDyuZtZFN1M1s/M7ZjbGOM9z3BGRLvK4+vzBti7C3CLwh+nBx3fmk/lj+wiH26aqjXkuXsHWRiOiW2YiurmdLTSeipkOhXXaTsdeSiHmWutsSLqr/uV3uV+ZPWYlU49ggTk2NVNm5SYeDqhDzb8U/yWAzREw6ykfuR1FSJzEu8IQc3wNwh/nNYjpaTMHItrlcj3y22d7O/g99yupGBzDl+zf8YibWMwQoTnlTHvR0oy6q+Op7SnuahjDaq2XXx+5v+eeSFlcbFp7ItZV/bSiqo6u6M9kX4VF/AY4d78CUCxT/AAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/f49b1ae572906db71cbbb3c4defa3b6b/c85cb/postman-get-one-product.webp 300w,\n/static/f49b1ae572906db71cbbb3c4defa3b6b/e88ff/postman-get-one-product.webp 600w,\n/static/f49b1ae572906db71cbbb3c4defa3b6b/92f8c/postman-get-one-product.webp 1200w,\n/static/f49b1ae572906db71cbbb3c4defa3b6b/df861/postman-get-one-product.webp 1386w\"\n              sizes=\"(max-width: 1200px) 100vw, 1200px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/f49b1ae572906db71cbbb3c4defa3b6b/5a46d/postman-get-one-product.png 300w,\n/static/f49b1ae572906db71cbbb3c4defa3b6b/0a47e/postman-get-one-product.png 600w,\n/static/f49b1ae572906db71cbbb3c4defa3b6b/c1b63/postman-get-one-product.png 1200w,\n/static/f49b1ae572906db71cbbb3c4defa3b6b/062c8/postman-get-one-product.png 1386w\"\n            sizes=\"(max-width: 1200px) 100vw, 1200px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/f49b1ae572906db71cbbb3c4defa3b6b/c1b63/postman-get-one-product.png\"\n            alt=\"postman-get-one-product.png\"\n            title=\"postman-get-one-product.png\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<h4 id=\"import-products\" style=\"position:relative;\"><a href=\"#import-products\" aria-label=\"import products permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Import products</h4>\n<p>Đây là nhân vật chính của ngày hôm nay, endpoint dùng để xử lý file CSV và thêm vào database.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">importProducts</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>req<span class=\"token punctuation\">.</span>file<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">.</span>file<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    res<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">400</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      message<span class=\"token punctuation\">:</span> <span class=\"token string\">\"No file is uploaded\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">const</span> rows <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">let</span> path <span class=\"token operator\">=</span> appDir <span class=\"token operator\">+</span> <span class=\"token string\">\"static/uploads/\"</span> <span class=\"token operator\">+</span> req<span class=\"token punctuation\">.</span>file<span class=\"token punctuation\">.</span>filename<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> categories <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> Category<span class=\"token punctuation\">.</span><span class=\"token function\">findAll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    attributes<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"id\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"name\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"code\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> categoryMap <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Map</span><span class=\"token punctuation\">(</span>\n    categories<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">c</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> <span class=\"token punctuation\">[</span>c<span class=\"token punctuation\">.</span>dataValues<span class=\"token punctuation\">.</span>code<span class=\"token punctuation\">,</span> c<span class=\"token punctuation\">.</span>dataValues<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> rowNumber <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> parser <span class=\"token operator\">=</span> csv\n      <span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> headers<span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"error\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">err</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        console<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">await</span> fs<span class=\"token punctuation\">.</span>promises<span class=\"token punctuation\">.</span><span class=\"token function\">unlink</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        res<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">400</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> message<span class=\"token punctuation\">:</span> err<span class=\"token punctuation\">.</span>message <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"data\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">data</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">const</span> category <span class=\"token operator\">=</span> categoryMap<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>categoryCode<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>category<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span>\n            <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Row </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>rowNumber<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">, category not found.\\nData: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span>\n              data\n            <span class=\"token punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span>\n          <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        rows<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token operator\">...</span>data<span class=\"token punctuation\">,</span> categoryId<span class=\"token punctuation\">:</span> category<span class=\"token punctuation\">.</span>id <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        rowNumber<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"end\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// Remove the uploaded file after parsing</span>\n        <span class=\"token keyword\">await</span> fs<span class=\"token punctuation\">.</span>promises<span class=\"token punctuation\">.</span><span class=\"token function\">unlink</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// Map the parsed data into the Product model</span>\n        <span class=\"token keyword\">const</span> products <span class=\"token operator\">=</span> rows<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span>\n          <span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span> name<span class=\"token punctuation\">,</span> price<span class=\"token punctuation\">,</span> description<span class=\"token punctuation\">,</span> categoryId <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n            name<span class=\"token punctuation\">,</span>\n            price<span class=\"token punctuation\">,</span>\n            description<span class=\"token punctuation\">,</span>\n            categoryId<span class=\"token punctuation\">,</span>\n            createdAt<span class=\"token punctuation\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Date</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            updatedAt<span class=\"token punctuation\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Date</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n          <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// Import the products into the database</span>\n        <span class=\"token keyword\">await</span> Product<span class=\"token punctuation\">.</span><span class=\"token function\">bulkCreate</span><span class=\"token punctuation\">(</span>products<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        res<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">200</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> message<span class=\"token punctuation\">:</span> <span class=\"token string\">\"Products imported successfully\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    fs<span class=\"token punctuation\">.</span><span class=\"token function\">createReadStream</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">pipe</span><span class=\"token punctuation\">(</span>parser<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    res<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">500</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> message<span class=\"token punctuation\">:</span> <span class=\"token string\">\"Internal server error\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Bạn để ý dòng code <code class=\"language-text\">await fs.promises.unlink(path);</code> , dòng này có nhiệm vụ xóa đi file đã cache trước đó khi process xong hoặc process bị lỗi.</p>\n<p>Đây là format của file CSV:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">name,price,categoryCode,description</code></pre></div>\n<p>Trong phần trên, mình đã lấy tất cả category code và đưa vào 1 Map, sau đó với mỗi dòng trong CSV thì mình sẽ kiểm tra xem category có tồn tại hay không, nếu có thì gán categoryId cho nó, nếu không, thì trả về với 1 lỗi.</p>\n<p>Hãy tránh việc gọi db nhiều lần để lấy database, nó sẽ làm app bạn chậm đi đáng kể đấy.</p>\n<p>Đây chỉ là cơ chế validation cơ bản, cân nhắc validation nhiều hơn nếu bạn dùng trong thực tế nha.</p>\n<h4 id=\"export-product\" style=\"position:relative;\"><a href=\"#export-product\" aria-label=\"export product permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Export product</h4>\n<p>Handler này export product ra CSV với schema y chang lúc mình đã import. Mình cho tối đa export 1 triệu bản ghi, còn mặc định sẽ là 100k bản ghi. Chứ để export quá nhiều chắc chớt luôn hệ thống.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">exportProducts</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> limit <span class=\"token operator\">=</span> req<span class=\"token punctuation\">.</span>query<span class=\"token punctuation\">.</span>limit <span class=\"token operator\">||</span> <span class=\"token number\">100000</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>limit <span class=\"token operator\">||</span> limit <span class=\"token operator\">></span> <span class=\"token number\">1000000</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    limit <span class=\"token operator\">=</span> <span class=\"token number\">1000000</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">const</span> products <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> Product<span class=\"token punctuation\">.</span><span class=\"token function\">findAll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    limit<span class=\"token punctuation\">:</span> limit<span class=\"token punctuation\">,</span>\n    attributes<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"name\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"price\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"description\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    include<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n      <span class=\"token punctuation\">{</span>\n        model<span class=\"token punctuation\">:</span> Category<span class=\"token punctuation\">,</span>\n        attributes<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"code\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    subQuery<span class=\"token punctuation\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n    raw<span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> dir <span class=\"token operator\">=</span> appDir <span class=\"token operator\">+</span> <span class=\"token string\">\"static/exports\"</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>fs<span class=\"token punctuation\">.</span><span class=\"token function\">existsSync</span><span class=\"token punctuation\">(</span>dir<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    fs<span class=\"token punctuation\">.</span><span class=\"token function\">mkdirSync</span><span class=\"token punctuation\">(</span>dir<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> recursive<span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">const</span> fileName <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>dir<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">/</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>process<span class=\"token punctuation\">.</span>hrtime<span class=\"token punctuation\">.</span><span class=\"token function\">bigint</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">-products.csv</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> csvWriter <span class=\"token operator\">=</span> <span class=\"token function\">createObjectCsvWriter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    path<span class=\"token punctuation\">:</span> fileName<span class=\"token punctuation\">,</span>\n    header<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n      <span class=\"token punctuation\">{</span> id<span class=\"token punctuation\">:</span> <span class=\"token string\">\"name\"</span><span class=\"token punctuation\">,</span> title<span class=\"token punctuation\">:</span> <span class=\"token string\">\"name\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">{</span> id<span class=\"token punctuation\">:</span> <span class=\"token string\">\"price\"</span><span class=\"token punctuation\">,</span> title<span class=\"token punctuation\">:</span> <span class=\"token string\">\"price\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">{</span> id<span class=\"token punctuation\">:</span> <span class=\"token string\">\"category.code\"</span><span class=\"token punctuation\">,</span> title<span class=\"token punctuation\">:</span> <span class=\"token string\">\"categoryCode\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">{</span> id<span class=\"token punctuation\">:</span> <span class=\"token string\">\"description\"</span><span class=\"token punctuation\">,</span> title<span class=\"token punctuation\">:</span> <span class=\"token string\">\"description\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">await</span> csvWriter\n    <span class=\"token punctuation\">.</span><span class=\"token function\">writeRecords</span><span class=\"token punctuation\">(</span>products<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"CSV file exported successfully\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">await</span> fs<span class=\"token punctuation\">.</span><span class=\"token function\">readFile</span><span class=\"token punctuation\">(</span>fileName<span class=\"token punctuation\">,</span> <span class=\"token string\">\"UTF-8\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">err<span class=\"token punctuation\">,</span> data</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          console<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n          res<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">500</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        res<span class=\"token punctuation\">.</span><span class=\"token function\">setHeader</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Content-Type\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"text/csv\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        res<span class=\"token punctuation\">.</span><span class=\"token function\">setHeader</span><span class=\"token punctuation\">(</span>\n          <span class=\"token string\">\"Content-Disposition\"</span><span class=\"token punctuation\">,</span>\n          <span class=\"token string\">\"attachment; filename=products.csv\"</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        res<span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">err</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      console<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      res<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">500</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">finally</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">await</span> fs<span class=\"token punctuation\">.</span><span class=\"token function\">unlink</span><span class=\"token punctuation\">(</span>fileName<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"DELETED THE TEMP FILE\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Mình có tối ưu lại một chút query để hiệu năng tốt hơn:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> products <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> Product<span class=\"token punctuation\">.</span><span class=\"token function\">findAll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  limit<span class=\"token punctuation\">:</span> limit<span class=\"token punctuation\">,</span>\n  attributes<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"name\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"price\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"description\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  include<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">{</span>\n      model<span class=\"token punctuation\">:</span> Category<span class=\"token punctuation\">,</span>\n      attributes<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"code\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  subQuery<span class=\"token punctuation\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n  raw<span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Với query sequelize như trên, thì ta có kết quả là một array với những product như sau:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token punctuation\">[</span>\n  <span class=\"token punctuation\">{</span>\n    name<span class=\"token punctuation\">:</span> <span class=\"token string\">\"Handcrafted Fresh Salad\"</span><span class=\"token punctuation\">,</span>\n    price<span class=\"token punctuation\">:</span> <span class=\"token string\">\"602.00\"</span><span class=\"token punctuation\">,</span>\n    description<span class=\"token punctuation\">:</span> <span class=\"token string\">\"Boston's most advanced compression wea....\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"category.code\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"BKS\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Điểm đặc biệt là <code class=\"language-text\">&#39;category.code&#39;</code> , mà trong Javascript thì key của 1 object có thể là string, do đó nó hợp lệ.</p>\n<p>Có 2 option mình truyền vào là <strong>subQuery</strong> cũng như <strong>raw</strong>. Cái trước sẽ tắt chức năng subquery, cái sau sẽ không transform dữ liệu mà chỉ lấy những prop như mình select, 2 tùy chọn này đều góp phần tăng hiệu năng của API.</p>\n<p>Raw query sequelize compile ra như sau:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token punctuation\">[</span><span class=\"token number\">14</span> ms<span class=\"token punctuation\">]</span> <span class=\"token function\">Executed</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">default</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token constant\">SELECT</span> <span class=\"token string\">\"products\"</span><span class=\"token punctuation\">.</span><span class=\"token string\">\"name\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"products\"</span><span class=\"token punctuation\">.</span><span class=\"token string\">\"price\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"products\"</span><span class=\"token punctuation\">.</span><span class=\"token string\">\"description\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"category\"</span><span class=\"token punctuation\">.</span><span class=\"token string\">\"code\"</span> <span class=\"token constant\">AS</span> <span class=\"token string\">\"category.code\"</span>\n\t<span class=\"token constant\">FROM</span> <span class=\"token string\">\"products\"</span> <span class=\"token constant\">AS</span> <span class=\"token string\">\"products\"</span>\n\t<span class=\"token constant\">LEFT</span> <span class=\"token constant\">OUTER</span> <span class=\"token constant\">JOIN</span> <span class=\"token string\">\"categories\"</span> <span class=\"token constant\">AS</span> <span class=\"token string\">\"category\"</span>\n\t\t<span class=\"token constant\">ON</span> <span class=\"token string\">\"products\"</span><span class=\"token punctuation\">.</span><span class=\"token string\">\"categoryId\"</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"category\"</span><span class=\"token punctuation\">.</span><span class=\"token string\">\"id\"</span>\n\t<span class=\"token constant\">LIMIT</span> <span class=\"token string\">'1000'</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h3 id=\"middleware-logger\" style=\"position:relative;\"><a href=\"#middleware-logger\" aria-label=\"middleware logger permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Middleware logger</h3>\n<p>Ở đây mình có dùng thêm 1 em logger <code class=\"language-text\">middlewares/logger.js</code>, mục đích để xem console có request nào với status code nào, lúc benchmark nhìn vào console sẽ trực quan hơn, fancy hơn:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">import</span> colors <span class=\"token keyword\">from</span> <span class=\"token string\">\"colors\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">logger</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">,</span> next</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    res<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">'finish'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">let</span> color<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">.</span>statusCode <span class=\"token operator\">>=</span> <span class=\"token number\">500</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            color <span class=\"token operator\">=</span> colors<span class=\"token punctuation\">.</span>red<span class=\"token punctuation\">.</span>bold<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">.</span>statusCode <span class=\"token operator\">>=</span> <span class=\"token number\">300</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            color <span class=\"token operator\">=</span> colors<span class=\"token punctuation\">.</span>yellow<span class=\"token punctuation\">.</span>bold<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n            color <span class=\"token operator\">=</span> colors<span class=\"token punctuation\">.</span>green<span class=\"token punctuation\">.</span>bold<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token function\">color</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>req<span class=\"token punctuation\">.</span>method<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\"> </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>req<span class=\"token punctuation\">.</span>originalUrl<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>res<span class=\"token punctuation\">.</span>statusCode<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Date</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toISOString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> logger<span class=\"token punctuation\">;</span></code></pre></div>\n<h3 id=\"ui-cho-trang-chủ\" style=\"position:relative;\"><a href=\"#ui-cho-trang-ch%E1%BB%A7\" aria-label=\"ui cho trang chủ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>UI cho trang chủ</h3>\n<p>Để dễ test hơn thì mình có tạo 1 trang UI ở index để có form upload file cũng như show ra danh sách product (có phân trang), đây là <code class=\"language-text\">handlers/index.js</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">index</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> perPage <span class=\"token operator\">=</span> <span class=\"token number\">20</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> page <span class=\"token operator\">=</span> <span class=\"token function\">parseInt</span><span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">.</span>query<span class=\"token punctuation\">.</span>page<span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> offset <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>page <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> perPage<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">const</span> products <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> Product<span class=\"token punctuation\">.</span><span class=\"token function\">findAndCountAll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      limit<span class=\"token punctuation\">:</span> perPage<span class=\"token punctuation\">,</span>\n      offset<span class=\"token punctuation\">:</span> offset<span class=\"token punctuation\">,</span>\n      order<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token punctuation\">[</span><span class=\"token string\">\"updatedAt\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"DESC\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">[</span><span class=\"token string\">\"createdAt\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"DESC\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">const</span> pageCount <span class=\"token operator\">=</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">ceil</span><span class=\"token punctuation\">(</span>products<span class=\"token punctuation\">.</span>count <span class=\"token operator\">/</span> perPage<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> pages <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> i <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;=</span> pageCount<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      pages<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    res<span class=\"token punctuation\">.</span><span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"index\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n      products<span class=\"token punctuation\">:</span> products<span class=\"token punctuation\">.</span>rows<span class=\"token punctuation\">,</span>\n      pages<span class=\"token punctuation\">:</span> pages<span class=\"token punctuation\">,</span>\n      totalPages<span class=\"token punctuation\">:</span> pages<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">,</span>\n      currentPage<span class=\"token punctuation\">:</span> page<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    res<span class=\"token punctuation\">.</span><span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"index\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Mình cũng có thêm 1 view template của ejs, nhưng mà nó dài lắm, mình chỉ show cái form để upload, với cái table thôi nha:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token operator\">&lt;</span>div <span class=\"token keyword\">class</span><span class=\"token operator\">=</span><span class=\"token string\">\"form-group\"</span><span class=\"token operator\">></span>\n    <span class=\"token operator\">&lt;</span>label <span class=\"token keyword\">for</span><span class=\"token operator\">=</span><span class=\"token string\">\"file\"</span><span class=\"token operator\">></span>Select <span class=\"token constant\">CSV</span> file to <span class=\"token keyword\">import</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>label<span class=\"token operator\">></span>\n    <span class=\"token operator\">&lt;</span>input type<span class=\"token operator\">=</span><span class=\"token string\">\"file\"</span> <span class=\"token keyword\">class</span><span class=\"token operator\">=</span><span class=\"token string\">\"form-control-file\"</span> id<span class=\"token operator\">=</span><span class=\"token string\">\"file\"</span> name<span class=\"token operator\">=</span><span class=\"token string\">\"file\"</span><span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span>button type<span class=\"token operator\">=</span><span class=\"token string\">\"button\"</span> <span class=\"token keyword\">class</span><span class=\"token operator\">=</span><span class=\"token string\">\"btn btn-primary\"</span> id<span class=\"token operator\">=</span><span class=\"token string\">\"import-btn\"</span><span class=\"token operator\">></span>Import<span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>button<span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span>div <span class=\"token keyword\">class</span><span class=\"token operator\">=</span><span class=\"token string\">\"table-responsive\"</span><span class=\"token operator\">></span>\n    <span class=\"token operator\">&lt;</span>table <span class=\"token keyword\">class</span><span class=\"token operator\">=</span><span class=\"token string\">\"table table-striped table-hover\"</span><span class=\"token operator\">></span>\n        <span class=\"token operator\">&lt;</span>thead<span class=\"token operator\">></span>\n        <span class=\"token operator\">&lt;</span>tr<span class=\"token operator\">></span>\n            <span class=\"token operator\">&lt;</span>th<span class=\"token operator\">></span>Name<span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>th<span class=\"token operator\">></span>\n            <span class=\"token operator\">&lt;</span>th<span class=\"token operator\">></span>Price<span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>th<span class=\"token operator\">></span>\n            <span class=\"token operator\">&lt;</span>th<span class=\"token operator\">></span>Description<span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>th<span class=\"token operator\">></span>\n            <span class=\"token operator\">&lt;</span>th<span class=\"token operator\">></span>Created At<span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>th<span class=\"token operator\">></span>\n            <span class=\"token operator\">&lt;</span>th<span class=\"token operator\">></span>Updated At<span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>th<span class=\"token operator\">></span>\n        <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>tr<span class=\"token operator\">></span>\n        <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>thead<span class=\"token operator\">></span>\n        <span class=\"token operator\">&lt;</span>tbody<span class=\"token operator\">></span>\n        <span class=\"token operator\">&lt;</span><span class=\"token operator\">%</span> products<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">product</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span> <span class=\"token operator\">%</span><span class=\"token operator\">></span>\n            <span class=\"token operator\">&lt;</span>tr<span class=\"token operator\">></span>\n                <span class=\"token operator\">&lt;</span>td<span class=\"token operator\">></span><span class=\"token operator\">&lt;</span><span class=\"token operator\">%=</span> product<span class=\"token punctuation\">.</span>name <span class=\"token operator\">%</span><span class=\"token operator\">></span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>td<span class=\"token operator\">></span>\n                <span class=\"token operator\">&lt;</span>td<span class=\"token operator\">></span><span class=\"token operator\">&lt;</span><span class=\"token operator\">%=</span> product<span class=\"token punctuation\">.</span>price <span class=\"token operator\">%</span><span class=\"token operator\">></span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>td<span class=\"token operator\">></span>\n                <span class=\"token operator\">&lt;</span>td<span class=\"token operator\">></span><span class=\"token operator\">&lt;</span><span class=\"token operator\">%=</span> product<span class=\"token punctuation\">.</span>description <span class=\"token operator\">%</span><span class=\"token operator\">></span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>td<span class=\"token operator\">></span>\n                <span class=\"token operator\">&lt;</span>td<span class=\"token operator\">></span><span class=\"token operator\">&lt;</span><span class=\"token operator\">%=</span> product<span class=\"token punctuation\">.</span>createdAt<span class=\"token punctuation\">.</span><span class=\"token function\">toDateString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">%</span><span class=\"token operator\">></span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>td<span class=\"token operator\">></span>\n                <span class=\"token operator\">&lt;</span>td<span class=\"token operator\">></span><span class=\"token operator\">&lt;</span><span class=\"token operator\">%=</span> product<span class=\"token punctuation\">.</span>updatedAt<span class=\"token punctuation\">.</span><span class=\"token function\">toDateString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">%</span><span class=\"token operator\">></span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>td<span class=\"token operator\">></span>\n            <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>tr<span class=\"token operator\">></span>\n        <span class=\"token operator\">&lt;</span><span class=\"token operator\">%</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token operator\">%</span><span class=\"token operator\">></span>\n        <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>tbody<span class=\"token operator\">></span>\n    <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>table<span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span>script<span class=\"token operator\">></span>\n    <span class=\"token keyword\">const</span> importBtn <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">'import-btn'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    importBtn<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'click'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">const</span> fileInput <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">'file'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">const</span> file <span class=\"token operator\">=</span> fileInput<span class=\"token punctuation\">.</span>files<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">const</span> formData <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">FormData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        formData<span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span><span class=\"token string\">'file'</span><span class=\"token punctuation\">,</span> file<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        axios<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/api/products/import'</span><span class=\"token punctuation\">,</span> formData<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">response</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n                console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token function\">alert</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"success\"</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">error</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n                console<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token comment\">// handle error response here</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>script<span class=\"token operator\">></span></code></pre></div>\n<h3 id=\"cai-dặt-express-server\" style=\"position:relative;\"><a href=\"#cai-d%E1%BA%B7t-express-server\" aria-label=\"cai dặt express server permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Cài đặt express server</h3>\n<p>Ở file <code class=\"language-text\">index.js</code>, chúng ta cần khai báo và khởi chạy expressjs server:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">import</span> express <span class=\"token keyword\">from</span> <span class=\"token string\">\"express\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span>\n  exportProducts<span class=\"token punctuation\">,</span>\n  findManyProducts<span class=\"token punctuation\">,</span>\n  findOneProduct<span class=\"token punctuation\">,</span>\n  importProducts<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"./handlers/product.js\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> index <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"./handlers/index.js\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> uploadMiddleware <span class=\"token keyword\">from</span> <span class=\"token string\">\"./middlewares/fileUpload.js\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> logger <span class=\"token keyword\">from</span> <span class=\"token string\">\"./middlewares/logger.js\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> appDir <span class=\"token keyword\">from</span> <span class=\"token string\">\"./utils/pathHelper.js\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token constant\">PORT</span> <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">PORT</span> <span class=\"token operator\">||</span> <span class=\"token number\">8080</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> app <span class=\"token operator\">=</span> <span class=\"token function\">express</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"view engine\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"ejs\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"views\"</span><span class=\"token punctuation\">,</span> appDir <span class=\"token operator\">+</span> <span class=\"token string\">\"src/views\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// parse requests of content-type - application/json</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>express<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// parse requests of content-type - application/x-www-form-urlencoded</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>express<span class=\"token punctuation\">.</span><span class=\"token function\">urlencoded</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> extended<span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\napp<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>logger<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// routing</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/\"</span><span class=\"token punctuation\">,</span> index<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/api/products\"</span><span class=\"token punctuation\">,</span> findManyProducts<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span>\n  <span class=\"token string\">\"/api/products/import\"</span><span class=\"token punctuation\">,</span>\n  uploadMiddleware<span class=\"token punctuation\">.</span><span class=\"token function\">single</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"file\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  importProducts\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/api/products/export\"</span><span class=\"token punctuation\">,</span> exportProducts<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/api/products/:id\"</span><span class=\"token punctuation\">,</span> findOneProduct<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\napp<span class=\"token punctuation\">.</span><span class=\"token function\">listen</span><span class=\"token punctuation\">(</span><span class=\"token constant\">PORT</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">error</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"App is listening on port \"</span> <span class=\"token operator\">+</span> <span class=\"token constant\">PORT</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Error occurred, server can't start\"</span><span class=\"token punctuation\">,</span> error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h3 id=\"chạy-app-len\" style=\"position:relative;\"><a href=\"#ch%E1%BA%A1y-app-len\" aria-label=\"chạy app len permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Chạy app lên</h3>\n<p>Để chạy được app ta có thể gõ <code class=\"language-text\">node src/index.js</code>, nhưng không, thường thì ta thêm sẵn script, rồi lúc cần chạy <code class=\"language-text\">yarn dev</code> hoặc <code class=\"language-text\">npm run dev</code> là được:</p>\n<p>Ở đây mình dùng nodemon để có thể theo dõi được code change và reload app luôn.</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token property\">\"scripts\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"dev\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"nodemon src/index.js --watch -max-old-space-size=2048\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"start\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"node src/index.js -max-old-space-size=2048\"</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span></code></pre></div>\n<p>Lúc mình test benchmark thì app báo tràn memory, nên mình set lên 2GB ram, tình trạng đó không còn nữa. Phải thôi, những file mình import cả 100k - 1m rows, import hàng ngàn request thì RAM nào chịu nổi :D.</p>\n<p>Với production thì nên set biến này tùy theo monitoring và yêu cầu nha.</p>\n<p>Chạy app lên và see:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1019px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/7b179cda0049a3245d2ea6dadc43b205/159fb/run-yarn-start.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 35.66666666666667%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAIAAACHqfpvAAAACXBIWXMAAA9hAAAPYQGoP6dpAAAA5ElEQVQY033OSWrDQBCFYZ0lMe6We1BVVw/Vrcmy5CHZBJID5Aa5/zLYgoANDnzL98OrXrYmje/58JHmrzh9Uneh7uLyKfEceU43kZfES8hHuoE4raqNMLGdXDn48Q3LokOvw2Bp8K54VxAYbIImYZNswwpYA0vtV9WrMBRbcNkiAxX0PVJnMBtqrSvShK32K6FIKvorr/FGANGEPLtywrwAz1gWRYNynfZDbVOtqdZ+JXW4i+XOtP0Z/NCEEeIewtjEEeKIaW99L83d+kGFxx+FLHZOrq8ePC+vse6/hfL/j57Fv51tUm8o9DBPAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/7b179cda0049a3245d2ea6dadc43b205/c85cb/run-yarn-start.webp 300w,\n/static/7b179cda0049a3245d2ea6dadc43b205/e88ff/run-yarn-start.webp 600w,\n/static/7b179cda0049a3245d2ea6dadc43b205/6b83e/run-yarn-start.webp 1019w\"\n              sizes=\"(max-width: 1019px) 100vw, 1019px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/7b179cda0049a3245d2ea6dadc43b205/5a46d/run-yarn-start.png 300w,\n/static/7b179cda0049a3245d2ea6dadc43b205/0a47e/run-yarn-start.png 600w,\n/static/7b179cda0049a3245d2ea6dadc43b205/159fb/run-yarn-start.png 1019w\"\n            sizes=\"(max-width: 1019px) 100vw, 1019px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/7b179cda0049a3245d2ea6dadc43b205/159fb/run-yarn-start.png\"\n            alt=\"run-yarn-start.png\"\n            title=\"run-yarn-start.png\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>Còn đây là giao diện, mình code tạm bằng bootstrap:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1066px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/cbd7c90e44a8e14e6698cfd8c8ce93d6/2e367/ui-product-nodejs-importer-csv-browser.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 87.33333333333334%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAAAsTAAALEwEAmpwYAAADOklEQVQ4y3VS34sbVRTOHyFoUbaLVVHwwWpBEWTHhyLUgk8+9skHEX3x7yjpUxHsk9ts1kXEtPZFtygborupu5V0t5ptk/2VmUky986vZGby487M/eTcSTZZsBc+zuFyzne+79ybe3/h2s33zn+FS4uf4+LCZ7i0+CUuvnwNr5y7gsXnPsL5Z+DV56/itReu4PUXP8Yb5z7Fuy99jQ8WvriZ++3+H9e3q3uobtaG1a1a/HCnHu89asaPa424tlOPa9v1+NFOPd59uH8Gf2/vxw+29uLt6r9xdas2/OvBLn79pXI9NxhGeWRHAJCU7HvAh7eBq2vAJz8AS8vAW98Cb98C3rkFvPkN8MTH9MhJL6IoyOc453kpJZIkEUmSAjKFFyWo7Pso1z3cf+zh9ycDlA9TlA8ShY1momqolnqolziYxfI5x3GUQimlupQyG1rZNbDb7GAc2BDRTA7mhE1rqZcy27ZnhGmaKkKqSlOJ/J/Aj/9krYkEklSeQZqxYSqGIrk9JZzuYXZShTTNkKk/i+k9iTlV6HlefjQaodPpiE63i3angygaTCbjf4nknLp5MaeEQggwboskSeD7PQRhCM/3EUYRnnVIhOO4qoZxLmgF5FYRjscjnLRagnEO23HAGEOrpePw8AiGYcA02zg5aUE3DOi6gWkd1ViWhePjExEnCVzXnVlmjAnf95VC13XRaDRhGKYiM9tt6LoO0zTVACIjdY6KDllV7hQhyaTlcs5FFEWI4xgUwzDMEEUYDAYIwwhBEExiqGp6/b6Kvt9TO5yzPMbh0ZGgydTkeb6azDmfg61A6/A8D9ymPLPe7Vpnd0iWnzYagjEuXdeVXcuSR8fHsnlwoPC00ZCNRnOSN6VlWQqGaaralq7PLBMhfYNOpyvG4zH9BzkajaRptqXZbkvbtiW3bWkxJhnnknNbBmEohRAqDodDGQTBzDJj7AYpdD0vpX3Ql6GHoYcgi9lDZfAmoLzf76PX66no+35Ka7Ms60auXC5fqFQql79bXl5aX1/X7t37Wft+bU27c/eutrJS1AqFglZcXdVWiqsqLxRWtGJxVfupVFL3pVJJu10oLG1ubl7e2Ni48B992Ktw7DJunQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/cbd7c90e44a8e14e6698cfd8c8ce93d6/c85cb/ui-product-nodejs-importer-csv-browser.webp 300w,\n/static/cbd7c90e44a8e14e6698cfd8c8ce93d6/e88ff/ui-product-nodejs-importer-csv-browser.webp 600w,\n/static/cbd7c90e44a8e14e6698cfd8c8ce93d6/fbb05/ui-product-nodejs-importer-csv-browser.webp 1066w\"\n              sizes=\"(max-width: 1066px) 100vw, 1066px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/cbd7c90e44a8e14e6698cfd8c8ce93d6/5a46d/ui-product-nodejs-importer-csv-browser.png 300w,\n/static/cbd7c90e44a8e14e6698cfd8c8ce93d6/0a47e/ui-product-nodejs-importer-csv-browser.png 600w,\n/static/cbd7c90e44a8e14e6698cfd8c8ce93d6/2e367/ui-product-nodejs-importer-csv-browser.png 1066w\"\n            sizes=\"(max-width: 1066px) 100vw, 1066px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/cbd7c90e44a8e14e6698cfd8c8ce93d6/2e367/ui-product-nodejs-importer-csv-browser.png\"\n            alt=\"ui-product-nodejs-importer-csv-browser.png\"\n            title=\"ui-product-nodejs-importer-csv-browser.png\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>Mình có thử import vài file trước đó rồi cho nên ở file này có show ra vài sản phẩm.</p>\n<p>Lúc test nếu không in ra console thì chẳng biết nó process thế nào, endpoint nào, thành công hay thất b, do đó cái logger phía trên đã giúp chúng ta có 1 cái console fancy như sau:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1200px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/383c4358cf7add84030c2abd5e19a198/e84a7/app-running-log.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 53.333333333333336%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAA9hAAAPYQGoP6dpAAABsElEQVQozy2QSY6kMBBFOUyVVGBHOIzniSGBJBm6Vn2Dvv8dWpApPYVefG/8o2rApv7UadV594+/pvttwyzdRG6SfiF/+VvuZJZ+kmF5e/UDnsKO+cC4ifIH4gvTjukA/xT5xPTCuFE5RT4wrKL/xbSJcoq0i7RXNVqdRvJFuEKuR9MJ2wvTNxTe1CI0IjQU68/0DcX3U/XDTBtemA+IL5F3CCumDdMObr5mWDGs17/SBn4R5YS4Yt4xbhhf1Q/5Nj6kK9IW6QZpOmkHsgOXCWTkF/kjbYK23Hm6JsWKMdXZYbS5mDyYklXu9UWQodc5qZja2OvcqRTbMOic29ipVC5ihai0cqSckFbKIMjTDYDhXHOuEW8BDWAQPsK5ZlxXcvyn4pP6g7qDulOkF5WT0s79cnd+gn++y19JPu6jHFfztFVMjzJOFEbhRwozmoH8LNzM28L0wFTHdf/BDNyMrC33OjDVVwy0iouIs4gLxSe6ScQV3cT1AH7mduR6QDdz++C6R79cuZvBPsBOVQ2GydAIz8jXaBl5kA7a8N20b75q+c3UZ2Xqq5HfjayFa4T7D2VajKWb/2fyAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/383c4358cf7add84030c2abd5e19a198/c85cb/app-running-log.webp 300w,\n/static/383c4358cf7add84030c2abd5e19a198/e88ff/app-running-log.webp 600w,\n/static/383c4358cf7add84030c2abd5e19a198/92f8c/app-running-log.webp 1200w,\n/static/383c4358cf7add84030c2abd5e19a198/25b5c/app-running-log.webp 1317w\"\n              sizes=\"(max-width: 1200px) 100vw, 1200px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/383c4358cf7add84030c2abd5e19a198/5a46d/app-running-log.png 300w,\n/static/383c4358cf7add84030c2abd5e19a198/0a47e/app-running-log.png 600w,\n/static/383c4358cf7add84030c2abd5e19a198/c1b63/app-running-log.png 1200w,\n/static/383c4358cf7add84030c2abd5e19a198/e84a7/app-running-log.png 1317w\"\n            sizes=\"(max-width: 1200px) 100vw, 1200px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/383c4358cf7add84030c2abd5e19a198/c1b63/app-running-log.png\"\n            alt=\"logger on console\"\n            title=\"logger on console\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<h2 id=\"benchmark\" style=\"position:relative;\"><a href=\"#benchmark\" aria-label=\"benchmark permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Benchmark</h2>\n<p>Ở bước trên chúng ta đã cài thư viện <code class=\"language-text\">autocannon</code>, sau khi thử qua nhiều thư viện thì mình dừng lại với em này bởi vì nó hỗ trợ upload file. Còn artillery thì chỉ có bản pro mới support tính năng đó.</p>\n<h3 id=\"tạo-file-csv-mẫu\" style=\"position:relative;\"><a href=\"#t%E1%BA%A1o-file-csv-m%E1%BA%ABu\" aria-label=\"tạo file csv mẫu permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tạo file CSV mẫu</h3>\n<p>Để việc tạo CSV dễ dàng hơn, mình sử dụng fakerjs mà mình đã cài đặt trước đó.</p>\n<p>Tạo file <code class=\"language-text\">csv-generator.js</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> faker <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"@faker-js/faker\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> createObjectCsvWriter <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"csv-writer\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> categories <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n  <span class=\"token punctuation\">{</span>\n    id<span class=\"token punctuation\">:</span> <span class=\"token string\">\"b2ff1377-c40c-4c10-b3a4-4d12c2f90bca\"</span><span class=\"token punctuation\">,</span>\n    name<span class=\"token punctuation\">:</span> <span class=\"token string\">\"Electronics\"</span><span class=\"token punctuation\">,</span>\n    description<span class=\"token punctuation\">:</span> <span class=\"token string\">\"Category for electronic devices\"</span><span class=\"token punctuation\">,</span>\n    code<span class=\"token punctuation\">:</span> <span class=\"token string\">\"ELC\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">{</span>\n    id<span class=\"token punctuation\">:</span> <span class=\"token string\">\"8c054e34-e65d-4b6e-b7f1-9d9b556e10d1\"</span><span class=\"token punctuation\">,</span>\n    name<span class=\"token punctuation\">:</span> <span class=\"token string\">\"Clothing\"</span><span class=\"token punctuation\">,</span>\n    description<span class=\"token punctuation\">:</span> <span class=\"token string\">\"Category for clothing items\"</span><span class=\"token punctuation\">,</span>\n    code<span class=\"token punctuation\">:</span> <span class=\"token string\">\"CLT\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">{</span>\n    id<span class=\"token punctuation\">:</span> <span class=\"token string\">\"a18b11cc-9a2e-4a04-b831-dde4667e8e0a\"</span><span class=\"token punctuation\">,</span>\n    name<span class=\"token punctuation\">:</span> <span class=\"token string\">\"Books\"</span><span class=\"token punctuation\">,</span>\n    description<span class=\"token punctuation\">:</span> <span class=\"token string\">\"Category for books and literature\"</span><span class=\"token punctuation\">,</span>\n    code<span class=\"token punctuation\">:</span> <span class=\"token string\">\"BKS\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">{</span>\n    id<span class=\"token punctuation\">:</span> <span class=\"token string\">\"773e7aa3-f06d-42af-a8c3-3cb50d966f26\"</span><span class=\"token punctuation\">,</span>\n    name<span class=\"token punctuation\">:</span> <span class=\"token string\">\"Home &amp; Kitchen\"</span><span class=\"token punctuation\">,</span>\n    description<span class=\"token punctuation\">:</span> <span class=\"token string\">\"Category for home and kitchen products\"</span><span class=\"token punctuation\">,</span>\n    code<span class=\"token punctuation\">:</span> <span class=\"token string\">\"HKP\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">{</span>\n    id<span class=\"token punctuation\">:</span> <span class=\"token string\">\"b8f3c3eb-30f6-41dd-a7b8-518ff2db616f\"</span><span class=\"token punctuation\">,</span>\n    name<span class=\"token punctuation\">:</span> <span class=\"token string\">\"Health &amp; Beauty\"</span><span class=\"token punctuation\">,</span>\n    description<span class=\"token punctuation\">:</span> <span class=\"token string\">\"Category for health and beauty products\"</span><span class=\"token punctuation\">,</span>\n    code<span class=\"token punctuation\">:</span> <span class=\"token string\">\"HBP\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">{</span>\n    id<span class=\"token punctuation\">:</span> <span class=\"token string\">\"5c6f5df6-5c5f-4a69-a38c-95d330c156e2\"</span><span class=\"token punctuation\">,</span>\n    name<span class=\"token punctuation\">:</span> <span class=\"token string\">\"Toys &amp; Games\"</span><span class=\"token punctuation\">,</span>\n    description<span class=\"token punctuation\">:</span> <span class=\"token string\">\"Category for toys and games\"</span><span class=\"token punctuation\">,</span>\n    code<span class=\"token punctuation\">:</span> <span class=\"token string\">\"TNG\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">{</span>\n    id<span class=\"token punctuation\">:</span> <span class=\"token string\">\"54b31c80-38f6-4e6a-9f70-049a8e0905c9\"</span><span class=\"token punctuation\">,</span>\n    name<span class=\"token punctuation\">:</span> <span class=\"token string\">\"Sports &amp; Outdoors\"</span><span class=\"token punctuation\">,</span>\n    description<span class=\"token punctuation\">:</span> <span class=\"token string\">\"Category for sports and outdoor products\"</span><span class=\"token punctuation\">,</span>\n    code<span class=\"token punctuation\">:</span> <span class=\"token string\">\"SPO\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">{</span>\n    id<span class=\"token punctuation\">:</span> <span class=\"token string\">\"66d74c4b-4b4d-4a54-935d-6b0b6faa07f4\"</span><span class=\"token punctuation\">,</span>\n    name<span class=\"token punctuation\">:</span> <span class=\"token string\">\"Automotive\"</span><span class=\"token punctuation\">,</span>\n    description<span class=\"token punctuation\">:</span> <span class=\"token string\">\"Category for automotive products\"</span><span class=\"token punctuation\">,</span>\n    code<span class=\"token punctuation\">:</span> <span class=\"token string\">\"AUT\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">{</span>\n    id<span class=\"token punctuation\">:</span> <span class=\"token string\">\"23212a97-74af-460e-bd3d-7b1320dd1c25\"</span><span class=\"token punctuation\">,</span>\n    name<span class=\"token punctuation\">:</span> <span class=\"token string\">\"Office Products\"</span><span class=\"token punctuation\">,</span>\n    description<span class=\"token punctuation\">:</span> <span class=\"token string\">\"Category for office supplies and stationery\"</span><span class=\"token punctuation\">,</span>\n    code<span class=\"token punctuation\">:</span> <span class=\"token string\">\"OFS\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">{</span>\n    id<span class=\"token punctuation\">:</span> <span class=\"token string\">\"141d2f17-91d8-4f9d-9143-3b8213c6f5a5\"</span><span class=\"token punctuation\">,</span>\n    name<span class=\"token punctuation\">:</span> <span class=\"token string\">\"Pet Supplies\"</span><span class=\"token punctuation\">,</span>\n    description<span class=\"token punctuation\">:</span> <span class=\"token string\">\"Category for pet supplies and accessories\"</span><span class=\"token punctuation\">,</span>\n    code<span class=\"token punctuation\">:</span> <span class=\"token string\">\"PET\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> categoryCodes <span class=\"token operator\">=</span> categories<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">c</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> c<span class=\"token punctuation\">.</span>code<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">generateProductsCsv</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">rows</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> csvWriter <span class=\"token operator\">=</span> <span class=\"token function\">createObjectCsvWriter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    path<span class=\"token punctuation\">:</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">./bench/sample-csv/products-</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>rows<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">-rows.csv</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span>\n    header<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n      <span class=\"token punctuation\">{</span> id<span class=\"token punctuation\">:</span> <span class=\"token string\">\"name\"</span><span class=\"token punctuation\">,</span> title<span class=\"token punctuation\">:</span> <span class=\"token string\">\"name\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">{</span> id<span class=\"token punctuation\">:</span> <span class=\"token string\">\"price\"</span><span class=\"token punctuation\">,</span> title<span class=\"token punctuation\">:</span> <span class=\"token string\">\"price\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">{</span> id<span class=\"token punctuation\">:</span> <span class=\"token string\">\"categoryCode\"</span><span class=\"token punctuation\">,</span> title<span class=\"token punctuation\">:</span> <span class=\"token string\">\"categoryCode\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">{</span> id<span class=\"token punctuation\">:</span> <span class=\"token string\">\"description\"</span><span class=\"token punctuation\">,</span> title<span class=\"token punctuation\">:</span> <span class=\"token string\">\"description\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">const</span> data <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> rows<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    data<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      name<span class=\"token punctuation\">:</span> faker<span class=\"token punctuation\">.</span>commerce<span class=\"token punctuation\">.</span><span class=\"token function\">productName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n      price<span class=\"token punctuation\">:</span> faker<span class=\"token punctuation\">.</span>commerce<span class=\"token punctuation\">.</span><span class=\"token function\">price</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n      categoryCode<span class=\"token punctuation\">:</span> faker<span class=\"token punctuation\">.</span>helpers<span class=\"token punctuation\">.</span><span class=\"token function\">arrayElement</span><span class=\"token punctuation\">(</span>categoryCodes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n      description<span class=\"token punctuation\">:</span> faker<span class=\"token punctuation\">.</span>commerce<span class=\"token punctuation\">.</span><span class=\"token function\">productDescription</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  csvWriter\n    <span class=\"token punctuation\">.</span><span class=\"token function\">writeRecords</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span>\n      console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">CSV file generated successfully with </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>rows<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\"> rows</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">error</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> console<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> rows <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token number\">10</span><span class=\"token punctuation\">,</span> <span class=\"token number\">100</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">,</span> <span class=\"token number\">10000</span><span class=\"token punctuation\">,</span> <span class=\"token number\">100000</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1000000</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"GENERATING CSV...\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nrows<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">x</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">generateProductsCsv</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>File trên lúc chạy <code class=\"language-text\">node csv-generator.js</code> thì sẽ có 6 file chứa từ 10, 100, 1000, 100k đến 1 triệu record nằm trong folder <code class=\"language-text\">bench/sample-csv</code>.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1200px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/e5673a41123c5f34bb792ee5510f914b/9cea8/terminal-run-generate-csv-sample.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.666666666666664%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAA9hAAAPYQGoP6dpAAABqElEQVQoz33Q2W4bMQwF0PmWwuNZtFESKWobz8hLEi9I/v9vCsdAWvShwMF9uwTJTseHzZ+uftnyafPD5ocMNxluiq8zXUy6unKz+W7zHfJd8m3ED8F3GR+D++gAE+WzDavBamhRrmhXLBVLq/HrOPt+UP30tBvkbi/7UfaD3A2iH2U3CGAupW7WBe/ZGKcVWMxIjcOF/InwiGF1tBjMysVZ86T5ld08q8XszqxXUgc/L3Y4mF9kweJCsfl0cvEItNnQPDcfm3ZVQJKQBaRuGEXRuyObxrAxPEfA3mu1l6QMO8o2FQhZYzKUIWQBYRQ4yqeuH0R0+lhT9OC1RCO9HEFb5arSAW0CTAajtKxc1D4KEyZFL10/maVdS7vH9YapYdyIDxwb5wuG5mlz3zsb2r6tBv/odpOx5WzXm65XVc6qvAVcsy/JlYq1+JqoAi3GV+OrhDSp8ONZxrhh3CxVSwtgBazGl1H6UeLwSuFfR/6j6ydAXjE2jC2kI/JK+UjlPGvuhR8k7sX/ysaXEx3ecbnw+o71LZXzYXkLtIAOVjMAa5d/Pvx3+TdSnIXSWgDOjAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/e5673a41123c5f34bb792ee5510f914b/c85cb/terminal-run-generate-csv-sample.webp 300w,\n/static/e5673a41123c5f34bb792ee5510f914b/e88ff/terminal-run-generate-csv-sample.webp 600w,\n/static/e5673a41123c5f34bb792ee5510f914b/92f8c/terminal-run-generate-csv-sample.webp 1200w,\n/static/e5673a41123c5f34bb792ee5510f914b/893d6/terminal-run-generate-csv-sample.webp 1278w\"\n              sizes=\"(max-width: 1200px) 100vw, 1200px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/e5673a41123c5f34bb792ee5510f914b/5a46d/terminal-run-generate-csv-sample.png 300w,\n/static/e5673a41123c5f34bb792ee5510f914b/0a47e/terminal-run-generate-csv-sample.png 600w,\n/static/e5673a41123c5f34bb792ee5510f914b/c1b63/terminal-run-generate-csv-sample.png 1200w,\n/static/e5673a41123c5f34bb792ee5510f914b/9cea8/terminal-run-generate-csv-sample.png 1278w\"\n            sizes=\"(max-width: 1200px) 100vw, 1200px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/e5673a41123c5f34bb792ee5510f914b/c1b63/terminal-run-generate-csv-sample.png\"\n            alt=\"terminal-run-generate-csv-sample.png\"\n            title=\"terminal-run-generate-csv-sample.png\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<h3 id=\"tiến-hanh-benchmark\" style=\"position:relative;\"><a href=\"#ti%E1%BA%BFn-hanh-benchmark\" aria-label=\"tiến hanh benchmark permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tiến hành benchmark</h3>\n<h4 id=\"test-tren-trinh-duyệt\" style=\"position:relative;\"><a href=\"#test-tren-trinh-duy%E1%BB%87t\" aria-label=\"test tren trinh duyệt permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Test trên trình duyệt</h4>\n<p>Mình tiến hành delete hết bản ghi trong database và bắt đầu import lại, vì có hàng triệu dòng trong database làm ảnh hưởng hiệu năng lúc test.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1200px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/3bb7535e71c25791843348d539c12f94/636d3/test-import-on-browser.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 54.666666666666664%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAA9hAAAPYQGoP6dpAAABqUlEQVQoz3VRy24UQQyc/4UcQGIllNsec+PKr0BCEinfgEDsZrLRZHdm+jHtdrfb/Ro0u4lAglglq2S7VLbc1FrnlzhRA/PVbb25W3B5U79eP+PLt3p1Wz39mWz+Fpey5HZXP67L+qKuL/L783q2ms9W5e2qvPlQ3p3nUdT/i1+qVanucHjQeqBgcsZ5TqfmESefhTT/KBf/T5/D9R3Pc825lFzmV6Kx1gKAMcZ7j4gOwCj9Y0PdkyMiqQHRnWYAwAJMYEiq9P1XmGwDQuBR3ff9oe+fuq7b7Ya+a+837eN+8zgMQhozaa31pJVSatJGCrjfGSEbJaUUEhHRolZaCDGOC9r2QQyjNUZLpZUGA1oqdeQWrFBK66mJKTrncs4YPJWYYiql5JxrrTaSYjTJq2Ah0ylLAiwsvLElNCFwLiXFGFMiZiJi5hCYObrgPAeKEclRZCRPka13xlpOCRw22+0WwHoi771zbr/fI+IoRu/89udeK2AOiCiP10khxSgMGA4sjW76w4GIcs4pJWa21sYYnfcppW43oQ1LJ+flEc4DgHO+lJLSsutvZLBrSWLR0IUAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/3bb7535e71c25791843348d539c12f94/c85cb/test-import-on-browser.webp 300w,\n/static/3bb7535e71c25791843348d539c12f94/e88ff/test-import-on-browser.webp 600w,\n/static/3bb7535e71c25791843348d539c12f94/92f8c/test-import-on-browser.webp 1200w,\n/static/3bb7535e71c25791843348d539c12f94/41bb6/test-import-on-browser.webp 1222w\"\n              sizes=\"(max-width: 1200px) 100vw, 1200px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/3bb7535e71c25791843348d539c12f94/5a46d/test-import-on-browser.png 300w,\n/static/3bb7535e71c25791843348d539c12f94/0a47e/test-import-on-browser.png 600w,\n/static/3bb7535e71c25791843348d539c12f94/c1b63/test-import-on-browser.png 1200w,\n/static/3bb7535e71c25791843348d539c12f94/636d3/test-import-on-browser.png 1222w\"\n            sizes=\"(max-width: 1200px) 100vw, 1200px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/3bb7535e71c25791843348d539c12f94/c1b63/test-import-on-browser.png\"\n            alt=\"test-import-on-browser.png\"\n            title=\"test-import-on-browser.png\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>Kết quả theo thứ tự cho import 10k dòng, 100k dòng và 1triệu dòng là: 633ms, 4.74s và 52.63s.</p>\n<p>Con số khá tốt, không đến nỗi nào, vì node vốn dĩ không mạnh về các tác vụ blocking IO như việc transform những file lớn như vậy. Phần 2 của API này mình sẽ cố gắng cải thiện nó.</p>\n<h4 id=\"stress-test\" style=\"position:relative;\"><a href=\"#stress-test\" aria-label=\"stress test permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Stress test</h4>\n<p>Mỗi test vậy thôi thì hơi buồn, mình chạy stress test với số lượng file nhiều nhưng số dòng ít (1k-10k) xem thử nó đáp ứng ra sao.</p>\n<p>Mình gom lại test case thành file benchmark <code class=\"language-text\">v1.bash</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token shebang important\">#!/bin/bash</span>\n<span class=\"token builtin class-name\">set</span> -eu\n\n<span class=\"token comment\"># Get the directory of the script file</span>\n<span class=\"token assign-left variable\">SCRIPT_DIR</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">dirname</span> <span class=\"token string\">\"<span class=\"token variable\"><span class=\"token variable\">$(</span>readlink -f <span class=\"token string\">\"<span class=\"token variable\">$0</span>\"</span><span class=\"token variable\">)</span></span>\"</span><span class=\"token variable\">)</span></span>\n\n<span class=\"token builtin class-name\">echo</span> -e <span class=\"token string\">\"<span class=\"token entity\" title=\"\\e\">\\e</span>[34mTEST 10s with 5 connections and csv file of 1000 rows<span class=\"token entity\" title=\"\\e\">\\e</span>[0m\"</span>\n\nautocannon http://localhost:8080/api/products/import -m POST <span class=\"token punctuation\">\\</span>\n  -F <span class=\"token string\">'{ \"file\": { \"type\": \"file\", \"path\": \"'</span><span class=\"token string\">\"<span class=\"token variable\">$SCRIPT_DIR</span>/sample-csv/products-1000-rows.csv\"</span><span class=\"token string\">'\" }}'</span> <span class=\"token punctuation\">\\</span>\n  --duration <span class=\"token number\">10</span> --connections <span class=\"token number\">5</span> <span class=\"token punctuation\">\\</span>\n  --maxOverallRequests <span class=\"token number\">10000</span>\n\n<span class=\"token builtin class-name\">echo</span> -e <span class=\"token string\">\"<span class=\"token entity\" title=\"\\e\">\\e</span>[34mTEST 10s with 5 connections and csv file of 10000 rows<span class=\"token entity\" title=\"\\e\">\\e</span>[0m\"</span>\n\nautocannon http://localhost:8080/api/products/import -m POST <span class=\"token punctuation\">\\</span>\n  -F <span class=\"token string\">'{ \"file\": { \"type\": \"file\", \"path\": \"'</span><span class=\"token string\">\"<span class=\"token variable\">$SCRIPT_DIR</span>/sample-csv/products-10000-rows.csv\"</span><span class=\"token string\">'\" }}'</span> <span class=\"token punctuation\">\\</span>\n  --duration <span class=\"token number\">10</span> --connections <span class=\"token number\">5</span> <span class=\"token punctuation\">\\</span>\n  --maxOverallRequests <span class=\"token number\">1000</span>\n\n<span class=\"token builtin class-name\">echo</span> -e <span class=\"token string\">\"<span class=\"token entity\" title=\"\\e\">\\e</span>[34mTEST 10s with 5 connections get Products<span class=\"token entity\" title=\"\\e\">\\e</span>[0m\"</span>\n\nautocannon http://localhost:8080/api/products -m GET <span class=\"token punctuation\">\\</span>\n  --duration <span class=\"token number\">10</span> --connections <span class=\"token number\">5</span> <span class=\"token punctuation\">\\</span>\n  --maxOverallRequests <span class=\"token number\">100000</span></code></pre></div>\n<p>Bạn có thể thấy mình stress test 2 endpoint chính.</p>\n<ul>\n<li><strong>Import product</strong>: Mình test 2 trường hợp chạy 10 giây, 5 kết nối đồng thời:\n<ul>\n<li>Trường hợp đầu tiên tối đa 10k request với những file có 1000 records.</li>\n<li>Trường hợp thứ hai tối đa 1k request với những file có 10000 records.</li>\n</ul>\n</li>\n<li><strong>Get products</strong>: Endpoint này để stress test việc query liên tục vào database để lấy 200 product mới nhất.</li>\n</ul>\n<p>Kết quả stress test chi tiết mình có để ở file readme, đây là tóm tắt kết quả sau 10 giây chạy cho mỗi test:</p>\n<p>Test case thứ nhất import một tá file 1000 dòng: <strong>262</strong> request</p>\n<p>Test case thứ 2, import nhiều file 10k dòng: <strong>35</strong> request</p>\n<p>Test case số 3, GET 200 products liên tục: <strong>1k</strong> request.</p>\n<h2 id=\"kết-luận\" style=\"position:relative;\"><a href=\"#k%E1%BA%BFt-lu%E1%BA%ADn\" aria-label=\"kết luận permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Kết luận</h2>\n<p>Dạo này mình viết bài nào cũng dài thật, hi vọng bài này có ích với các bạn trong khi tham khảo 1 API để import CSV đơn giản nhanh gọn.</p>\n<p>Các con số kết quả stress test làm mình khá ngạc nhiên, vì khi code Go như bài viết connection pooling<sup id=\"fnref-3\"><a href=\"#fn-3\" class=\"footnote-ref\">3</a></sup>, những con số benchmark ấn tượng hơn rất nhiều.</p>\n<p>Nhưng cũng phải thôi, vì mình có dùng ORM, lại chưa kể Nodejs không mạnh về mấy cái blocking-IO, cho nên con số này chấp nhận được.</p>\n<p>Thế mới có lý do mình viết tiếp phần 2 chứ, đón đọc hen!</p>\n<p>Ở trên repo thì các bạn có thể kiểm tra code của bài này trong branch v1 nhé, lỡ đâu branch main mình update version 2 rồi.</p>\n<p>Happy coding!</p>\n\n      <div class=\"footnotes\">\n        <hr/><strong>References:</strong>\n        <ol >\n    \n    <li class=\"footnote-list-item\" id=\"fn-1\" >\n          \n        \n      <a href=\"#fnref-1\" class=\"footnote-backref\" style=\"display:inline;text-decoration: none;\">\n        ↩\n      </a>\n    <p class=\"footnote-paragraph\" style=\"display:inline; margin-left: 5px;\"><a href=\"https://reflectoring.io/node-csv-importer/\">https://reflectoring.io/node-csv-importer/</a></p>\n      </li>\n      \n    \n\n    <li class=\"footnote-list-item\" id=\"fn-2\" >\n          \n        \n      <a href=\"#fnref-2\" class=\"footnote-backref\" style=\"display:inline;text-decoration: none;\">\n        ↩\n      </a>\n    <p class=\"footnote-paragraph\" style=\"display:inline; margin-left: 5px;\"><a href=\"https://github.com/kienmatu/nodejs-product-csv\">https://github.com/kienmatu/nodejs-product-csv</a></p>\n      </li>\n      \n    \n\n    <li class=\"footnote-list-item\" id=\"fn-3\" >\n          \n        \n      <a href=\"#fnref-3\" class=\"footnote-backref\" style=\"display:inline;text-decoration: none;\">\n        ↩\n      </a>\n    <p class=\"footnote-paragraph\" style=\"display:inline; margin-left: 5px;\"><a href=\"https://devgiangho.github.io/connection-pooling-tong-quan-va-implement-benchmark/\">https://devgiangho.github.io/connection-pooling-tong-quan-va-implement-benchmark/</a></p>\n      </li>\n      \n    \n\n    <li class=\"footnote-list-item\" id=\"fn-4\" >\n          \n        \n      <a href=\"#fnref-4\" class=\"footnote-backref\" style=\"display:inline;text-decoration: none;\">\n        ↩\n      </a>\n    <p class=\"footnote-paragraph\" style=\"display:inline; margin-left: 5px;\"><a href=\"https://nodejs.org/api/process.html#process_process_hrtime_time\">https://nodejs.org/api/process.html#process_process_hrtime_time</a></p>\n      </li>\n      \n    </ol></div>"},"primaryTag":null,"prev":{"frontmatter":{"title":"Slice trong Go: Tất tần tật, và những điều có thể bạn chưa biết","path":"/golang-slice-tat-tan-tat-va-nhung-dieu-co-the-ban-chua-biet"}},"next":null},"pageContext":{"postId":"ca508b3b-4dc2-58ad-b135-ab0d8ed74ccb","primaryTag":"Nodejs","prevId":"17142bbc-a516-53d9-b85e-bb84d04661a3","nextId":null}},"staticQueryHashes":["2275848304","3082461530","3837502023","4133584024","545095672"]}